<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Presto查询提交流程 - 爱吃芒果</title><meta name="Description" content="This is my cool site"><meta property="og:url" content="http://example.org/posts/presto_query_submission/">
  <meta property="og:site_name" content="爱吃芒果">
  <meta property="og:title" content="Presto查询提交流程">
  <meta property="og:description" content="接收SQL查询请求 客户端首先发送HTTP请求v1/statement将待查询的sql发送给集群协调节点， 交由io.prestosql.dispatcher.QueuedStatementResource#postStatement处理，生成QueryId，然后将查询加入待执行队列中，返回响应报文给客户端，响应报文中包含了下一次客户端应该访问的URI，即/v1/statement/queued。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-09T22:27:56+08:00">
    <meta property="article:modified_time" content="2025-07-09T22:27:56+08:00">
    <meta property="article:tag" content="Presto">
    <meta property="article:tag" content="Trino">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Presto查询提交流程">
  <meta name="twitter:description" content="接收SQL查询请求 客户端首先发送HTTP请求v1/statement将待查询的sql发送给集群协调节点， 交由io.prestosql.dispatcher.QueuedStatementResource#postStatement处理，生成QueryId，然后将查询加入待执行队列中，返回响应报文给客户端，响应报文中包含了下一次客户端应该访问的URI，即/v1/statement/queued。">
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site">
<meta name="referrer" content="no-referrer" /><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/posts/presto_query_submission/" /><link rel="prev" href="http://example.org/posts/file_lock/" /><link rel="next" href="http://example.org/posts/trino-filter-project/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Presto查询提交流程",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/posts\/presto_query_submission\/"
        },"genre": "posts","keywords": "Presto, Trino","wordcount":  22068 ,
        "url": "http:\/\/example.org\/posts\/presto_query_submission\/","datePublished": "2025-07-09T22:27:56+08:00","dateModified": "2025-07-09T22:27:56+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "爱吃芒果"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="爱吃芒果">My cool site</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/page/archives/" title="Archives"> Archives </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/page/search/" title="Search"> Search </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="爱吃芒果">My cool site</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/page/archives/" title="Archives">Archives</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/page/search/" title="Search">Search</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Presto查询提交流程</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>爱吃芒果</a></span>&nbsp;<span class="post-category">included in <a href="/categories/presto/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Presto</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-07-09">2025-07-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;22068 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;45 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#接收sql查询请求">接收SQL查询请求</a></li>
        <li><a href="#词法与语法分析并生成抽象语法树">词法与语法分析并生成抽象语法树</a></li>
        <li><a href="#创建并提交queryexecution">创建并提交QueryExecution</a></li>
      </ul>
    </li>
    <li><a href="#执行计划的调度">执行计划的调度</a>
      <ul>
        <li><a href="#创建sqlstageexecution">创建SqlStageExecution</a></li>
        <li><a href="#调度并分发执行计划">调度并分发执行计划</a></li>
      </ul>
    </li>
    <li><a href="#执行计划的执行">执行计划的执行</a>
      <ul>
        <li><a href="#算子operator">算子Operator</a></li>
        <li><a href="#pageblockslice">Page、Block、Slice</a></li>
        <li><a href="#taskexecutordriver">TaskExecutor/Driver</a></li>
        <li><a href="#分批返回查询计算结果给sql客户端">分批返回查询计算结果给SQL客户端</a></li>
      </ul>
    </li>
    <li><a href="#执行计划生成的设计实现">执行计划生成的设计实现</a>
      <ul>
        <li><a href="#从sql到抽象语法树">从SQL到抽象语法树</a></li>
        <li><a href="#语义分析">语义分析</a></li>
        <li><a href="#生成初始逻辑执行计划">生成初始逻辑执行计划</a></li>
      </ul>
    </li>
    <li><a href="#执行计划优化的目的基本原理和基础算法">执行计划优化的目的、基本原理和基础算法</a>
      <ul>
        <li><a href="#执行计划优化的基本原理">执行计划优化的基本原理</a></li>
        <li><a href="#执行计划优化的基本算法">执行计划优化的基本算法</a></li>
        <li><a href="#执行计划优化的设计实现">执行计划优化的设计实现</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h3 id="接收sql查询请求">接收SQL查询请求</h3>
<p>客户端首先发送HTTP请求<code>v1/statement</code>将待查询的sql发送给集群协调节点， 交由<code>io.prestosql.dispatcher.QueuedStatementResource#postStatement</code>处理，生成QueryId，然后将查询加入待执行队列中，返回响应报文给客户端，响应报文中包含了下一次客户端应该访问的URI，即<code>/v1/statement/queued</code>。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="nf">postStatement</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">statement</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Context</span><span class="w"> </span><span class="n">HttpHeaders</span><span class="w"> </span><span class="n">httpHeaders</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Context</span><span class="w"> </span><span class="n">UriInfo</span><span class="w"> </span><span class="n">uriInfo</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isNullOrEmpty</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">badRequest</span><span class="p">(</span><span class="n">BAD_REQUEST</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;SQL statement is empty&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">remoteAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">.</span><span class="na">getRemoteAddr</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Identity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">identity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">((</span><span class="n">Identity</span><span class="p">)</span><span class="w"> </span><span class="n">servletRequest</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">AUTHENTICATED_IDENTITY</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MultivaluedMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">httpHeaders</span><span class="p">.</span><span class="na">getRequestHeaders</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// 创建请求的session context</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SessionContext</span><span class="w"> </span><span class="n">sessionContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpRequestSessionContext</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span><span class="w"> </span><span class="n">remoteAddress</span><span class="p">,</span><span class="w"> </span><span class="n">identity</span><span class="p">,</span><span class="w"> </span><span class="n">groupProvider</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 创建Query对象，构造QueryId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Query</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span><span class="w"> </span><span class="n">sessionContext</span><span class="p">,</span><span class="w"> </span><span class="n">dispatchManager</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">queries</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="na">getQueryId</span><span class="p">(),</span><span class="w"> </span><span class="n">query</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// let authentication filter know that identity lifecycle has been handed off</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">servletRequest</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">AUTHENTICATED_IDENTITY</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">createQueryResultsResponse</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="na">getQueryResults</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="na">getLastToken</span><span class="p">(),</span><span class="w"> </span><span class="n">uriInfo</span><span class="p">),</span><span class="w"> </span><span class="n">compressionEnabled</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>产生的QueryId的格式为<code>YYYYMMdd_HHmmss_index_coordId</code>，分别表示当前时间戳、查询计数和协调节点id。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// io.prestosql.execution.QueryIdGenerator#createNextQueryId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">QueryId</span><span class="w"> </span><span class="nf">createNextQueryId</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// only generate 100,000 ids per day</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">99_999</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// wait for the second to rollover</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">MILLISECONDS</span><span class="p">.</span><span class="na">toSeconds</span><span class="p">(</span><span class="n">nowInMillis</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lastTimeInSeconds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Uninterruptibles</span><span class="p">.</span><span class="na">sleepUninterruptibly</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// if it has been a second since the last id was generated, generate a new timestamp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nowInMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MILLISECONDS</span><span class="p">.</span><span class="na">toSeconds</span><span class="p">(</span><span class="n">now</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">lastTimeInSeconds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// generate new timestamp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lastTimeInSeconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MILLISECONDS</span><span class="p">.</span><span class="na">toSeconds</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lastTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIMESTAMP_FORMAT</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// if the day has rolled over, restart the counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MILLISECONDS</span><span class="p">.</span><span class="na">toDays</span><span class="p">(</span><span class="n">now</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">lastTimeInDays</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">lastTimeInDays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MILLISECONDS</span><span class="p">.</span><span class="na">toDays</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">QueryId</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;%s_%05d_%s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">lastTimestamp</span><span class="p">,</span><span class="w"> </span><span class="n">counter</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">coordinatorId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>之后客户端会发起第二次HTTP请求<code>queued/{queryId}/{slug}/{token}</code>，slug和token只是Presto用来验证接收到的请求是否是合法的，slug在生成后就不会变，token在生成nextURI的逻辑中每次会+1，Presto此时才会真正将查询提交到DispatchManager::createQueryInternal来执行。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ResourceSecurity</span><span class="p">(</span><span class="n">PUBLIC</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Path</span><span class="p">(</span><span class="s">&#34;queued/{queryId}/{slug}/{token}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Produces</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getStatus</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;queryId&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">QueryId</span><span class="w"> </span><span class="n">queryId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;slug&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">slug</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;token&#34;</span><span class="p">)</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&#34;maxWait&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">maxWait</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Context</span><span class="w"> </span><span class="n">UriInfo</span><span class="w"> </span><span class="n">uriInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Suspended</span><span class="w"> </span><span class="n">AsyncResponse</span><span class="w"> </span><span class="n">asyncResponse</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getQuery</span><span class="p">(</span><span class="n">queryId</span><span class="p">,</span><span class="w"> </span><span class="n">slug</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// wait for query to be dispatched, up to the wait timeout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ListenableFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">futureStateChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addTimeout</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">query</span><span class="p">.</span><span class="na">waitForDispatched</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">WAIT_ORDERING</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">MAX_WAIT_TIME</span><span class="p">,</span><span class="w"> </span><span class="n">maxWait</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">timeoutExecutor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// when state changes, fetch the next result</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ListenableFuture</span><span class="o">&lt;</span><span class="n">QueryResults</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queryResultsFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Futures</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">futureStateChange</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ignored</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">query</span><span class="p">.</span><span class="na">getQueryResults</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">uriInfo</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">responseExecutor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// transform to Response</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ListenableFuture</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Futures</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">queryResultsFuture</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">queryResults</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">createQueryResultsResponse</span><span class="p">(</span><span class="n">queryResults</span><span class="p">,</span><span class="w"> </span><span class="n">compressionEnabled</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">directExecutor</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bindAsyncResponse</span><span class="p">(</span><span class="n">asyncResponse</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">responseExecutor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">createQueryInternal</span><span class="p">(</span><span class="n">QueryId</span><span class="w"> </span><span class="n">queryId</span><span class="p">,</span><span class="w"> </span><span class="n">Slug</span><span class="w"> </span><span class="n">slug</span><span class="p">,</span><span class="w"> </span><span class="n">SessionContext</span><span class="w"> </span><span class="n">sessionContext</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceGroupManager</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resourceGroupManager</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">PreparedQuery</span><span class="w"> </span><span class="n">preparedQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 检查查询长度是否超过限制，超过报错</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxQueryLength</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">queryLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">maxQueryLength</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PrestoException</span><span class="p">(</span><span class="n">QUERY_TEXT_TOO_LARGE</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="s">&#34;Query text length (%s) exceeds the maximum length (%s)&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">queryLength</span><span class="p">,</span><span class="w"> </span><span class="n">maxQueryLength</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 创建查询会话</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionSupplier</span><span class="p">.</span><span class="na">createSession</span><span class="p">(</span><span class="n">queryId</span><span class="p">,</span><span class="w"> </span><span class="n">sessionContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 检查查询执行权限</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">accessControl</span><span class="p">.</span><span class="na">checkCanExecuteQuery</span><span class="p">(</span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getIdentity</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// sql解析，生成抽象语法树</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">preparedQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryPreparer</span><span class="p">.</span><span class="na">prepareQuery</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 选择Query并执行对应的ResourceGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queryType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getQueryType</span><span class="p">(</span><span class="n">preparedQuery</span><span class="p">.</span><span class="na">getStatement</span><span class="p">().</span><span class="na">getClass</span><span class="p">()).</span><span class="na">map</span><span class="p">(</span><span class="n">Enum</span><span class="p">::</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SelectionContext</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">selectionContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceGroupManager</span><span class="p">.</span><span class="na">selectGroup</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SelectionCriteria</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getIdentity</span><span class="p">().</span><span class="na">getPrincipal</span><span class="p">().</span><span class="na">isPresent</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getIdentity</span><span class="p">().</span><span class="na">getUser</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getIdentity</span><span class="p">().</span><span class="na">getGroups</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getSource</span><span class="p">()),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getClientTags</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getResourceEstimates</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">queryType</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// apply system default session properties (does not override user set properties)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionPropertyDefaults</span><span class="p">.</span><span class="na">newSessionWithDefaultProperties</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">queryType</span><span class="p">,</span><span class="w"> </span><span class="n">selectionContext</span><span class="p">.</span><span class="na">getResourceGroupId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// mark existing transaction as active</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">transactionManager</span><span class="p">.</span><span class="na">activateTransaction</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">isTransactionControlStatement</span><span class="p">(</span><span class="n">preparedQuery</span><span class="p">.</span><span class="na">getStatement</span><span class="p">()),</span><span class="w"> </span><span class="n">accessControl</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 生成DispatchQuery</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DispatchQuery</span><span class="w"> </span><span class="n">dispatchQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dispatchQueryFactory</span><span class="p">.</span><span class="na">createDispatchQuery</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">session</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">query</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">preparedQuery</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">slug</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">selectionContext</span><span class="p">.</span><span class="na">getResourceGroupId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 向ResourceGroupManager提交查询请求并执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">queryAdded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryCreated</span><span class="p">(</span><span class="n">dispatchQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">queryAdded</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dispatchQuery</span><span class="p">.</span><span class="na">isDone</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">resourceGroupManager</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">dispatchQuery</span><span class="p">,</span><span class="w"> </span><span class="n">selectionContext</span><span class="p">,</span><span class="w"> </span><span class="n">dispatchExecutor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// dispatch query has already been registered, so just fail it directly</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">dispatchQuery</span><span class="p">.</span><span class="na">fail</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">throwable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// creation must never fail, so register a failed query in this case</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">session</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Session</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SessionPropertyManager</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setQueryId</span><span class="p">(</span><span class="n">queryId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setIdentity</span><span class="p">(</span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getIdentity</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">setSource</span><span class="p">(</span><span class="n">sessionContext</span><span class="p">.</span><span class="na">getSource</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">preparedSql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">preparedQuery</span><span class="p">).</span><span class="na">flatMap</span><span class="p">(</span><span class="n">PreparedQuery</span><span class="p">::</span><span class="n">getPrepareSql</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DispatchQuery</span><span class="w"> </span><span class="n">failedDispatchQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">failedDispatchQueryFactory</span><span class="p">.</span><span class="na">createFailedDispatchQuery</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">preparedSql</span><span class="p">,</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">(),</span><span class="w"> </span><span class="n">throwable</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">queryCreated</span><span class="p">(</span><span class="n">failedDispatchQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<h3 id="词法与语法分析并生成抽象语法树">词法与语法分析并生成抽象语法树</h3>
<p>SqlParser使用Antlr4作为解析工具，通过词法和语法解析通过SQL字符串生成抽象语法树。抽象语法树是用一种树形结构表示SQL想要表述的语义，将一段SQL字符串结构化，以支持SQL执行引擎根据抽象语法树生成SQL执行计划。在Presto中，Node表示树的节点的抽象，根据语义不同，SQL抽象语法树中有多种不同类型的节点，都继承了Node节点。</p>
<p>抽象语法树在我看来只是将字符串转成结构更加严谨的树状结构，和sql的文本表述类似，除了将文本转成树状结构外，没有做额外的操作，比如FunctionCall并没有真的生成调用的函数，而只是描述，这一步最终会生成一个用Statement表示的根的抽象语法树。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FunctionCall</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">extends</span><span class="w"> </span><span class="n">Expression</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 函数名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">QualifiedName</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Window</span><span class="o">&gt;</span><span class="w"> </span><span class="n">window</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">OrderBy</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orderBy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">distinct</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">NullTreatment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nullTreatment</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 函数参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arguments</span><span class="p">;</span></span></span></code></pre></div></div>
<h3 id="创建并提交queryexecution">创建并提交QueryExecution</h3>
<p><code>dispatchQueryFactory.createDispatchQuery</code>方法在执行中，会根据Statement的类型生成QueryExecution，对于DML操作(Data Manipulatioin language)生成SqlQueryExecution，对于DDL (Data Definition language)生成DataDefinitionExecution，然后进一步包装成LocalDispatchQuery，提交到resourceGroupManager等待运行。</p>
<p>resourceGroup应该是Presto用来支持资源隔离的方法，如果某个组内cpu或者内存资源不足，则会等待资源可用或者超时失败。<code>io.prestosql.execution.resourcegroups.InternalResourceGroup#canRunMore</code>会根据资源组对cpu和内存的限制决定当前查询是否可以执行，<code>io.prestosql.dispatcher.LocalDispatchQuery#waitForMinimumWorkers</code>等待获取需要的worker数量。</p>
<p>经过一系列的异步操作（各种Future），代码执行到<code>SqlQueryExecution.start</code>方法，该方法串起来执行计划的生成和调度。</p>
<h2 id="执行计划的调度">执行计划的调度</h2>
<h3 id="创建sqlstageexecution">创建SqlStageExecution</h3>
<p>在Presto的执行模型中，SQL的执行被划分为如下几个层次：</p>
<ul>
<li>查询：用户提交一个SQL，触发Presto的一次查询，在代码中对应一个QueryInfo。每个查询都有一个字符串形式的QueryId</li>
<li>查询执行阶段：Presto生成查询的执行计划时，根据是否需要做跨查询执行节点的数据交换来划分PlanFragment。调度执行计划时，每个PlanFragment对应一个查询执行阶段，在代码中对应一个StageInfo，其中有StageId，StageId的形式为QueryId + 从0自增id。查询执行阶段之间有数据依赖关系，即不能并行执行，存在执行上的顺序关系，需要注意的是，StageId越小，这个查询执行阶段的执行顺序越靠后。Presto的查询执行阶段类似于Spark的查询执行阶段的概念，他们的不同是Presto不像Spark批式处理那样，需要前面的查询执行阶段执行完再执行后面的查询执行阶段，Presto采用的是流水线（Pipeline）处理机制。</li>
<li>任务（Task）：任务是Presto分布式任务的执行单元，每个查询执行阶段可以有多个任务，这些任务可以并行执行，同一个查询执行阶段中的所有任务的执行逻辑完全相同。一个查询执行阶段的任务个数就是此查询执行阶段的并发度。在Presto的任务调度代码中，可以看到任务的个数是根据查询执行阶段的数据分布方式（Source，Fixed，Single）以及查询执行节点的个数来决定的。</li>
</ul>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">planDistribution</span><span class="p">(</span><span class="n">PlanRoot</span><span class="w"> </span><span class="n">plan</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 遍历执行计划PlanNode树，找到所有的TableScanNode（也就是连接器对应的PlanNode），获取到他们的ConnectorSplit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DistributedExecutionPlanner</span><span class="w"> </span><span class="n">distributedPlanner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DistributedExecutionPlanner</span><span class="p">(</span><span class="n">splitManager</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicFilterService</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">StageExecutionPlan</span><span class="w"> </span><span class="n">outputStageExecutionPlan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distributedPlanner</span><span class="p">.</span><span class="na">plan</span><span class="p">(</span><span class="n">plan</span><span class="p">.</span><span class="na">getRoot</span><span class="p">(),</span><span class="w"> </span><span class="n">stateMachine</span><span class="p">.</span><span class="na">getSession</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ensure split sources are closed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stateMachine</span><span class="p">.</span><span class="na">addStateChangeListener</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="na">isDone</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">closeSplitSources</span><span class="p">(</span><span class="n">outputStageExecutionPlan</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 如果查询被取消了，跳过创建调度器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stateMachine</span><span class="p">.</span><span class="na">isDone</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// record output field</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">stateMachine</span><span class="p">.</span><span class="na">setColumns</span><span class="p">(</span><span class="n">outputStageExecutionPlan</span><span class="p">.</span><span class="na">getFieldNames</span><span class="p">(),</span><span class="w"> </span><span class="n">outputStageExecutionPlan</span><span class="p">.</span><span class="na">getFragment</span><span class="p">().</span><span class="na">getTypes</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 创建最后一个查询执行阶段的Outputbuffer，这个OutputBuffer用于给Presto SQL客户端输出查询的最终计算结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">PartitioningHandle</span><span class="w"> </span><span class="n">partitioningHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plan</span><span class="p">.</span><span class="na">getRoot</span><span class="p">().</span><span class="na">getFragment</span><span class="p">().</span><span class="na">getPartitioningScheme</span><span class="p">().</span><span class="na">getPartitioning</span><span class="p">().</span><span class="na">getHandle</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">OutputBuffers</span><span class="w"> </span><span class="n">rootOutputBuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createInitialEmptyOutputBuffers</span><span class="p">(</span><span class="n">partitioningHandle</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">withBuffer</span><span class="p">(</span><span class="n">OUTPUT_BUFFER_ID</span><span class="p">,</span><span class="w"> </span><span class="n">BROADCAST_PARTITION_ID</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">withNoMoreBufferIds</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 创建SqlStageExecution，并将其封装在SqlQueryScheduler里面返回</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 这里只是创建Stage，但是不会去调度执行它</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SqlQueryScheduler</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createSqlQueryScheduler</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stateMachine</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">outputStageExecutionPlan</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">nodePartitioningManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">nodeScheduler</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">remoteTaskFactory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stateMachine</span><span class="p">.</span><span class="na">getSession</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">plan</span><span class="p">.</span><span class="na">isSummarizeTaskInfos</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">scheduleSplitBatchSize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">queryExecutor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">schedulerExecutor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">failureDetector</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">rootOutputBuffers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">nodeTaskMap</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">executionPolicy</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">schedulerStats</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dynamicFilterService</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">queryScheduler</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">scheduler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// if query was canceled during scheduler creation, abort the scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// directly since the callback may have already fired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stateMachine</span><span class="p">.</span><span class="na">isDone</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">scheduler</span><span class="p">.</span><span class="na">abort</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">queryScheduler</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>从数据源连接器中获取到所有的分片。分片是Presto中分块组织数据的方式，Presto连接器会将待处理的所有数据划分为若干分片让Presto读取，而这些分片也会被安排到多个Presto查询执行节点上来处理以实现分布式高性能计算。分布式OLAP引擎几乎全都有分片的抽象设计，例如Spark、Flink等。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ConnectorAwareSplitSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">SplitSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CatalogName</span><span class="w"> </span><span class="n">catalogName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ConnectorSplitSource</span><span class="w"> </span><span class="n">source</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FixedSplitSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">ConnectorSplitSource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ConnectorSplit</span><span class="o">&gt;</span><span class="w"> </span><span class="n">splits</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TpcdsSplitManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">ConnectorSplitManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">ConnectorSplitSource</span><span class="w"> </span><span class="nf">getSplits</span><span class="p">(</span><span class="n">ConnectorTransactionHandle</span><span class="w"> </span><span class="n">transaction</span><span class="p">,</span><span class="w"> </span><span class="n">ConnectorSession</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">ConnectorTableLayoutHandle</span><span class="w"> </span><span class="n">layout</span><span class="p">,</span><span class="w"> </span><span class="n">SplitSchedulingStrategy</span><span class="w"> </span><span class="n">splitSchedulingStrategy</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodeManager</span><span class="p">.</span><span class="na">getRequiredWorkerNodes</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">checkState</span><span class="p">(</span><span class="o">!</span><span class="n">nodes</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;No TPCDS nodes available&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">totalParts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">splitsPerNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">partNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Split the data using split and skew by the number of nodes available.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">ConnectorSplit</span><span class="o">&gt;</span><span class="w"> </span><span class="n">splits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">builder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">nodes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">splitsPerNode</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">splits</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TpcdsSplit</span><span class="p">(</span><span class="n">partNumber</span><span class="p">,</span><span class="w"> </span><span class="n">totalParts</span><span class="p">,</span><span class="w"> </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">getHostAndPort</span><span class="p">()),</span><span class="w"> </span><span class="n">noSexism</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">partNumber</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FixedSplitSource</span><span class="p">(</span><span class="n">splits</span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ConnectorSplit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 这个信息定义了分片是否可以非分片所在的节点访问到，对于计算存储分离的情况，这里需要返回true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isRemotelyAccessible</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// 这个信息定义了分片可以从哪些节点访问（这些节点，并不需要是Presto集群的节点，例如对于计算存储分离的情况，大概率Presto的节点与数据源分片所在的节点不是相同的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">HostAddress</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAddresses</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// 这里允许连接器设置一些自己的信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="nf">getInfo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>注意，这一步只是生成数据源分片，既不会将分片安排到某个Presto查询执行节点上，也不会真正使用分片读取连接器的数据。</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="nf">SqlQueryScheduler</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">QueryStateMachine</span><span class="w"> </span><span class="n">queryStateMachine</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">StageExecutionPlan</span><span class="w"> </span><span class="n">plan</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">NodePartitioningManager</span><span class="w"> </span><span class="n">nodePartitioningManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">NodeScheduler</span><span class="w"> </span><span class="n">nodeScheduler</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RemoteTaskFactory</span><span class="w"> </span><span class="n">remoteTaskFactory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">summarizeTaskInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">splitBatchSize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">queryExecutor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ScheduledExecutorService</span><span class="w"> </span><span class="n">schedulerExecutor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FailureDetector</span><span class="w"> </span><span class="n">failureDetector</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">OutputBuffers</span><span class="w"> </span><span class="n">rootOutputBuffers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">NodeTaskMap</span><span class="w"> </span><span class="n">nodeTaskMap</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExecutionPolicy</span><span class="w"> </span><span class="n">executionPolicy</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SplitSchedulerStats</span><span class="w"> </span><span class="n">schedulerStats</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DynamicFilterService</span><span class="w"> </span><span class="n">dynamicFilterService</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">queryStateMachine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">queryStateMachine</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;queryStateMachine is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">executionPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">executionPolicy</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;schedulerPolicyFactory is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">schedulerStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">schedulerStats</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;schedulerStats is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">summarizeTaskInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">summarizeTaskInfo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">dynamicFilterService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">dynamicFilterService</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;dynamicFilterService is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// todo come up with a better way to build this, or eliminate this map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ImmutableMap</span><span class="p">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">StageId</span><span class="p">,</span><span class="w"> </span><span class="n">StageScheduler</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stageSchedulers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableMap</span><span class="p">.</span><span class="na">builder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ImmutableMap</span><span class="p">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">StageId</span><span class="p">,</span><span class="w"> </span><span class="n">StageLinkage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stageLinkages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableMap</span><span class="p">.</span><span class="na">builder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Only fetch a distribution once per query to assure all stages see the same machine assignments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">PartitioningHandle</span><span class="p">,</span><span class="w"> </span><span class="n">NodePartitionMap</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitioningCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">OutputBufferId</span><span class="w"> </span><span class="n">rootBufferId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iterables</span><span class="p">.</span><span class="na">getOnlyElement</span><span class="p">(</span><span class="n">rootOutputBuffers</span><span class="p">.</span><span class="na">getBuffers</span><span class="p">().</span><span class="na">keySet</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SqlStageExecution</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createStages</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">(</span><span class="n">fragmentId</span><span class="p">,</span><span class="w"> </span><span class="n">tasks</span><span class="p">,</span><span class="w"> </span><span class="n">noMoreExchangeLocations</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">updateQueryOutputLocations</span><span class="p">(</span><span class="n">queryStateMachine</span><span class="p">,</span><span class="w"> </span><span class="n">rootBufferId</span><span class="p">,</span><span class="w"> </span><span class="n">tasks</span><span class="p">,</span><span class="w"> </span><span class="n">noMoreExchangeLocations</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">plan</span><span class="p">.</span><span class="na">withBucketToPartition</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">nodeScheduler</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">remoteTaskFactory</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">session</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">splitBatchSize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">partitioningHandle</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">partitioningCache</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">partitioningHandle</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">nodePartitioningManager</span><span class="p">.</span><span class="na">getNodePartitioningMap</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">nodePartitioningManager</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">queryExecutor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">schedulerExecutor</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">failureDetector</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">nodeTaskMap</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stageSchedulers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stageLinkages</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SqlStageExecution</span><span class="w"> </span><span class="n">rootStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rootStage</span><span class="p">.</span><span class="na">setOutputBuffers</span><span class="p">(</span><span class="n">rootOutputBuffers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">rootStageId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rootStage</span><span class="p">.</span><span class="na">getStageId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">stages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stages</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">toImmutableMap</span><span class="p">(</span><span class="n">SqlStageExecution</span><span class="p">::</span><span class="n">getStageId</span><span class="p">,</span><span class="w"> </span><span class="n">identity</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">stageSchedulers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageSchedulers</span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">stageLinkages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageLinkages</span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryExecutor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>createSqlQueryScheduler会为执行计划的每一个PlanFragment创建一个SqlStageExecution。每个SqlStageExecution对应一个StageScheduler，不同数据分区类型（PartitioningHandle）的查询执行计划阶段对应不同的StageScheduler。后面在调度查询执行阶段的任务时，主要依赖的是这个StageScheduler的具体实现。</p>
<h3 id="调度并分发执行计划">调度并分发执行计划</h3>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">schedule</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">SetThreadName</span><span class="w"> </span><span class="n">ignored</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SetThreadName</span><span class="p">(</span><span class="s">&#34;Query-%s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">queryStateMachine</span><span class="p">.</span><span class="na">getQueryId</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">StageId</span><span class="o">&gt;</span><span class="w"> </span><span class="n">completedStages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 根据执行策略确定查询执行阶段的调度顺序和调度时机，默认是AllAtOnceExecutionPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 会按照查询执行阶段执行的上下游关系依次调度查询执行阶段，生成任务并全部分发给Presto查询执行节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 另一种策略是PhasedExeuctionPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExecutionSchedule</span><span class="w"> </span><span class="n">executionSchedule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executionPolicy</span><span class="p">.</span><span class="na">createExecutionSchedule</span><span class="p">(</span><span class="n">stages</span><span class="p">.</span><span class="na">values</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">executionSchedule</span><span class="p">.</span><span class="na">isFinished</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ListenableFuture</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">blockedStages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">SqlStageExecution</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">executionSchedule</span><span class="p">.</span><span class="na">getStagesToSchedule</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">stage</span><span class="p">.</span><span class="na">beginScheduling</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 拿到与当前查询执行阶段对应的StageScheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">// 绑定Presto查询执行节点与上游数据源分片的关系，创建任务并调度到Presto查询执行节点上</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ScheduleResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stageSchedulers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getStageId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">schedule</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// modify parent and children based on the results of the scheduling</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">isFinished</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">stage</span><span class="p">.</span><span class="na">schedulingComplete</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="na">getBlocked</span><span class="p">().</span><span class="na">isDone</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">blockedStages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getBlocked</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">// 将上一步在当前查询执行阶段上刚创建的任务注册到下游查询执行阶段的soruceTask阶段里，</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">// 这样下游查询执行阶段的任务就知道他们要去哪些上游任务拉取数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">stageLinkages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getStageId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">.</span><span class="na">processScheduleResults</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getState</span><span class="p">(),</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getNewTasks</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">schedulerStats</span><span class="p">.</span><span class="na">getSplitsScheduledPerIteration</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getSplitsScheduled</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getBlockedReason</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getBlockedReason</span><span class="p">().</span><span class="na">get</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="n">WRITER_SCALING</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="c1">// no-op</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="n">WAITING_FOR_SOURCE</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">schedulerStats</span><span class="p">.</span><span class="na">getWaitingForSource</span><span class="p">().</span><span class="na">update</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="n">SPLIT_QUEUES_FULL</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">schedulerStats</span><span class="p">.</span><span class="na">getSplitQueuesFull</span><span class="p">().</span><span class="na">update</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="n">MIXED_SPLIT_QUEUES_FULL_AND_WAITING_FOR_SOURCE</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="n">NO_ACTIVE_DRIVER_GROUP</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UnsupportedOperationException</span><span class="p">(</span><span class="s">&#34;Unknown blocked reason: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getBlockedReason</span><span class="p">().</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// make sure to update stage linkage at least once per loop to catch async state changes (e.g., partial cancel)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">SqlStageExecution</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">stages</span><span class="p">.</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">completedStages</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getStageId</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getState</span><span class="p">().</span><span class="na">isDone</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">stageLinkages</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getStageId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">.</span><span class="na">processScheduleResults</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getState</span><span class="p">(),</span><span class="w"> </span><span class="n">ImmutableSet</span><span class="p">.</span><span class="na">of</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">completedStages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">stage</span><span class="p">.</span><span class="na">getStageId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// wait for a state change and then schedule again</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">blockedStages</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">TimeStat</span><span class="p">.</span><span class="na">BlockTimer</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">schedulerStats</span><span class="p">.</span><span class="na">getSleepTime</span><span class="p">().</span><span class="na">time</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">tryGetFutureValue</span><span class="p">(</span><span class="n">whenAnyComplete</span><span class="p">(</span><span class="n">blockedStages</span><span class="p">),</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ListenableFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">blockedStage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">blockedStages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">blockedStage</span><span class="p">.</span><span class="na">cancel</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">SqlStageExecution</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">stages</span><span class="p">.</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">StageState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getState</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SCHEDULED</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RUNNING</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">FLUSHING</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">state</span><span class="p">.</span><span class="na">isDone</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PrestoException</span><span class="p">(</span><span class="n">GENERIC_INTERNAL_ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="s">&#34;Scheduling is complete, but stage %s is in state %s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">stage</span><span class="p">.</span><span class="na">getStageId</span><span class="p">(),</span><span class="w"> </span><span class="n">state</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">queryStateMachine</span><span class="p">.</span><span class="na">transitionToFailed</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">closeError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">StageScheduler</span><span class="w"> </span><span class="n">scheduler</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">stageSchedulers</span><span class="p">.</span><span class="na">values</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">scheduler</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">queryStateMachine</span><span class="p">.</span><span class="na">transitionToFailed</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// Self-suppression not permitted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">closeError</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">closeError</span><span class="p">.</span><span class="na">addSuppressed</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">closeError</span><span class="p">.</span><span class="na">getSuppressed</span><span class="p">().</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">closeError</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<h4 id="创建当前查询执行阶段对应的stagescheduler">创建当前查询执行阶段对应的StageScheduler</h4>
<p>不同数据分区类型（PartitioningHandle）的PlanFragment的查询执行阶段对应不同类型的StageScheduler，后面在调度查询执行阶段时，主要依赖的是这样StageScheduler的实现。SqlQueryScheduler中通过Map&lt;StageId, StageScheduler&gt; stageSchedulers这样一个Map数据结构维护了当前查询所有查询执行阶段的StageScheduler。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StageScheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">extends</span><span class="w"> </span><span class="n">Closeable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Schedules as much work as possible without blocking.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The schedule results is a hint to the query scheduler if and
</span></span></span><span class="line"><span class="cl"><span class="cm">     * when the stage scheduler should be invoked again.  It is
</span></span></span><span class="line"><span class="cl"><span class="cm">     * important to note that this is only a hint and the query
</span></span></span><span class="line"><span class="cl"><span class="cm">     * scheduler may call the schedule method at any time.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ScheduleResult</span><span class="w"> </span><span class="nf">schedule</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>到目前为止，StageScheduler有4个实现类，分别对应了4种不同的查询执行阶段调度方式，最常用到的是SourcePartitionedScheduler和FixedCountScheduler。</p>
<h4 id="调度分片和任务">调度分片和任务</h4>
<p>StageScheduler的职责是绑定查询执行节点与上游数据源分片的关系，创建任务并调度到查询执行节点上。</p>
<p>对于stage使用数据源连接器，从存储系统拉取数据，这些stage的任务调度使用SourcePartitionedScheduler。</p>
<p>从数据源连接器那里获取一批分片，并准备调度这些分片。Presto的默认配置为每批最多调度1000个分片。FixedSplitSourc预先准备好所有的分片，Presto框架的SplitSource::getNextBlock每次会根据需要获取一批分片，FixedSplitSource根据需要的分片个数来返回。几乎所有的连接器都是用的FixedSplitSource，只有少数几个连接器（如Hive）实现了自己的ConnectorSplitSource。</p>
<p>根据SplitPlacementPolicy为这一批分片挑选对应的节点，建立一个map，key是节点， value是分片列表。</p>
<p>生成任务并调度到Presto查询执行节点上，任务的调度需要先绑定节点和分片的关系，再绑定分片和任务的关系，再将任务调度到查询执行节点上。分片选择了哪些查询执行节点，那么查询执行节点就会创建任务，分片选择了多少查询执行节点，就会有多少个查询执行节点创建任务，这会影响查询执行阶段的并发度。创建任务即创建某个RemoteTask的实例化对象，Presto默认实现和使用的是HttpRemoteTask。任务绑定分配到当前节点的分片之后，Presto会调用HttpRemoteTask.start，将任务分发到查询执行节点上。SqlStageExecution::scheduleTask详细描述了分发过程，构造了一个携带PlanFgragment和分片信息的HTTP Post请求，请求对应Presto查询执行节点的URI：<code>/v1/task/{taskId}</code>，Presto查询执行节点在收到请求后，会解析PlanFragment中的执行计划并创建SqlTaskExecution，开始执行任务。</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">RemoteTask</span><span class="w"> </span><span class="nf">scheduleTask</span><span class="p">(</span><span class="n">InternalNode</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">TaskId</span><span class="w"> </span><span class="n">taskId</span><span class="p">,</span><span class="w"> </span><span class="n">Multimap</span><span class="o">&lt;</span><span class="n">PlanNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Split</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sourceSplits</span><span class="p">,</span><span class="w"> </span><span class="n">OptionalInt</span><span class="w"> </span><span class="n">totalPartitions</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">checkArgument</span><span class="p">(</span><span class="o">!</span><span class="n">allTasks</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">taskId</span><span class="p">),</span><span class="w"> </span><span class="s">&#34;A task with id %s already exists&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">taskId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ImmutableMultimap</span><span class="p">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">PlanNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Split</span><span class="o">&gt;</span><span class="w"> </span><span class="n">initialSplits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableMultimap</span><span class="p">.</span><span class="na">builder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 添加来自上游的数据源Connector的Split</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">initialSplits</span><span class="p">.</span><span class="na">putAll</span><span class="p">(</span><span class="n">sourceSplits</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// 添加来自上游查询执行阶段的任务的数据输出，注册为RemoteSplit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sourceTasks</span><span class="p">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">planNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TaskStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="na">getTaskStatus</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TaskState</span><span class="p">.</span><span class="na">FINISHED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">initialSplits</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">planNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">createRemoteSplitFor</span><span class="p">(</span><span class="n">taskId</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">.</span><span class="na">getSelf</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">OutputBuffers</span><span class="w"> </span><span class="n">outputBuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">outputBuffers</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">checkState</span><span class="p">(</span><span class="n">outputBuffers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Initial output buffers must be set before a task can be scheduled&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 创建HttpRemoteTask</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">RemoteTask</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remoteTaskFactory</span><span class="p">.</span><span class="na">createRemoteTask</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stateMachine</span><span class="p">.</span><span class="na">getSession</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">taskId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">node</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stateMachine</span><span class="p">.</span><span class="na">getFragment</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">initialSplits</span><span class="p">.</span><span class="na">build</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">totalPartitions</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">outputBuffers</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">nodeTaskMap</span><span class="p">.</span><span class="na">createPartitionedSplitCountTracker</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">taskId</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">summarizeTaskInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">completeSources</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">task</span><span class="p">::</span><span class="n">noMoreSplits</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 将刚创建的TaskId添加到当前查询执行阶段的TaskId列表中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">allTasks</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">taskId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 将刚创建的任务添加到当前查询执行阶段的节点与任务映射的map中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tasks</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">newConcurrentHashSet</span><span class="p">()).</span><span class="na">add</span><span class="p">(</span><span class="n">task</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nodeTaskMap</span><span class="p">.</span><span class="na">addTask</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">task</span><span class="p">.</span><span class="na">addStateChangeListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StageTaskListener</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">task</span><span class="p">.</span><span class="na">addFinalTaskInfoListener</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">updateFinalTaskInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stateMachine</span><span class="p">.</span><span class="na">getState</span><span class="p">().</span><span class="na">isDone</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 向Presto查询执行节点发请求，将刚创建的任务调度起来，开始执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">task</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// stage finished while we were scheduling this task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">task</span><span class="p">.</span><span class="na">abort</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">task</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>如果stage的数据源只有上游查询执行阶段的任务输出，使用FixedCountScheduler在选中的节点上调度任务。这些任务在Presto查询执行节点上执行时，将从上游查询执行阶段的任务OutputBuffer拉取数据计算结果。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FixedCountScheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">StageScheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">TaskScheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">RemoteTask</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">scheduleTask</span><span class="p">(</span><span class="n">InternalNode</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">partition</span><span class="p">,</span><span class="w"> </span><span class="n">OptionalInt</span><span class="w"> </span><span class="n">totalPartitions</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// taskScheduler就是SqlStageExecution::schedulerTask方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TaskScheduler</span><span class="w"> </span><span class="n">taskScheduler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 任务将调度到下面的节点上（Presto查询执行节点，每个节点对应一个任务）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">InternalNode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitionToNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ScheduleResult</span><span class="w"> </span><span class="nf">schedule</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">OptionalInt</span><span class="w"> </span><span class="n">totalPartitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OptionalInt</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">partitionToNode</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RemoteTask</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newTasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">partitionToNode</span><span class="p">.</span><span class="na">size</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">mapToObj</span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">taskScheduler</span><span class="p">.</span><span class="na">scheduleTask</span><span class="p">(</span><span class="n">partitionToNode</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">partition</span><span class="p">),</span><span class="w"> </span><span class="n">partition</span><span class="p">,</span><span class="w"> </span><span class="n">totalPartitions</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">isPresent</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Optional</span><span class="p">::</span><span class="n">get</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">toImmutableList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ScheduleResult</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">newTasks</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<h4 id="关联exchangelocation">关联ExchangeLocation</h4>
<p>查询执行阶段的数据来源有两种，一种是数据源连接器，一种是上游查询执行阶段的任务可以输出到OutputBuffer的数据。对于下游的查询执行阶段来说，上游查询执行阶段的任务可以称为数据上游任务（upstream source task）。这些数据上游任务是通过SqlStageExecution::addExchangeLocations注册到下游的SqlStageExecution中的，让下游查询执行阶段知道去哪里取数据。无论是哪一种数据源，Presto都统一抽象为ConnectorSplit，当上游查询执行阶段作为数据源时，Presto把它看做是一种特殊的连接器。它的catalog name = $remote，其实就是一个假的目录，ConnectorSplit的实现类是RemoteSplit。</p>
<h2 id="执行计划的执行">执行计划的执行</h2>
<h3 id="算子operator">算子Operator</h3>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">extends</span><span class="w"> </span><span class="n">AutoCloseable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ListenableFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">NOT_BLOCKED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Futures</span><span class="p">.</span><span class="na">immediateFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">OperatorContext</span><span class="w"> </span><span class="nf">getOperatorContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns a future that will be completed when the operator becomes
</span></span></span><span class="line"><span class="cl"><span class="cm">     * unblocked.  If the operator is not blocked, this method should return
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@code NOT_BLOCKED}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="n">ListenableFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">isBlocked</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NOT_BLOCKED</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns true if and only if this operator can accept an input page.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">needsInput</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Adds an input page to the operator.  This method will only be called if
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@code needsInput()} returns true.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">addInput</span><span class="p">(</span><span class="n">Page</span><span class="w"> </span><span class="n">page</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Gets an output page from the operator.  If no output data is currently
</span></span></span><span class="line"><span class="cl"><span class="cm">     * available, return null.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Page</span><span class="w"> </span><span class="nf">getOutput</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After calling this method operator should revoke all reserved revocable memory.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * As soon as memory is revoked returned future should be marked as done.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Spawned threads cannot modify OperatorContext because it&#39;s not thread safe.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * For this purpose implement {@link #finishMemoryRevoke()}
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Since memory revoking signal is delivered asynchronously to the Operator, implementation
</span></span></span><span class="line"><span class="cl"><span class="cm">     * must gracefully handle the case when there no longer is any revocable memory allocated.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * After this method is called on Operator the Driver is disallowed to call any
</span></span></span><span class="line"><span class="cl"><span class="cm">     * processing methods on it (isBlocked/needsInput/addInput/getOutput) until
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link #finishMemoryRevoke()} is called.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="n">ListenableFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">startMemoryRevoke</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NOT_BLOCKED</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Clean up and release resources after completed memory revoking. Called by driver
</span></span></span><span class="line"><span class="cl"><span class="cm">     * once future returned by startMemoryRevoke is completed.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">finishMemoryRevoke</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Notifies the operator that no more pages will be added and the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * operator should finish processing and flush results. This method
</span></span></span><span class="line"><span class="cl"><span class="cm">     * will not be called if the Task is already failed or canceled.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">finish</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Is this operator completely finished processing and no more
</span></span></span><span class="line"><span class="cl"><span class="cm">     * output pages will be produced.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isFinished</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * This method will always be called before releasing the Operator reference.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<ul>
<li>TableScanOperator：用于读取数据源连接器的数据</li>
<li>AggregationOperator：用于聚合计算，内部可以指定一个或多个聚合函数，如sum，avg等</li>
<li>TaskOutputOperator：查询执行阶段之间的任务做数据交换用的，上游查询执行阶段的任务通过此算子将计算结果输出到当前任务所在节点的OutputBuffer</li>
<li>ExchangeOperator: 用于查询执行阶段之间进行任务的数据交换，下游查询执行阶段的ExchangeClient从上游OutputBuffer获取数据</li>
</ul>
<h3 id="pageblockslice">Page、Block、Slice</h3>
<p>Slice表示一个值（Single Value），Block表示一列，类似于Parquet中的列（Column），Page表示多行记录。但是他们是以多列多个block的方式组织在一起，类似Parquet中的Row Group，这种组织方式，不同行相同列的字段都顺序相临，对应数据更容易按列读取与计算。</p>
<h3 id="taskexecutordriver">TaskExecutor/Driver</h3>
<p>TaskExecutor是Presto任务的执行池，它以单例的方式在Presto查询执行节点上启动，内部维护了一个Java线程池-ExecutorService用于提交运行任务，所以无论某个Presto查询执行节点上有多少个任务在运行，TaskExecutor都只有一个。</p>
<p>Driver是任务的算子链执行的驱动器，由它来推动数据穿梭于算子。在具体的实现上，火山模型是自顶而下的拉取（Pull）数据，Presto Driver和火山模型不一样，它是自底而上的推送（Push）数据。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">ListenableFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">processInternal</span><span class="p">(</span><span class="n">OperationTimer</span><span class="w"> </span><span class="n">operationTimer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">activeOperators</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">driverContext</span><span class="p">.</span><span class="na">isDone</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Operator</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeOperators</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Operator</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeOperators</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// skip blocked operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getBlockedFuture</span><span class="p">(</span><span class="n">current</span><span class="p">).</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 如果当前算子未完成任务，且下一个算子未被阻塞且需要输入</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="p">.</span><span class="na">isFinished</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">getBlockedFuture</span><span class="p">(</span><span class="n">next</span><span class="p">).</span><span class="na">isEmpty</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">next</span><span class="p">.</span><span class="na">needsInput</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 从当前算子中获取计算输出的Page</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Page</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="na">getOutput</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">current</span><span class="p">.</span><span class="na">getOperatorContext</span><span class="p">().</span><span class="na">recordGetOutput</span><span class="p">(</span><span class="n">operationTimer</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 如果能拿到一个Page，将其给到下一个算子</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">page</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="na">getPositionCount</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">next</span><span class="p">.</span><span class="na">addInput</span><span class="p">(</span><span class="n">page</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">next</span><span class="p">.</span><span class="na">getOperatorContext</span><span class="p">().</span><span class="na">recordAddInput</span><span class="p">(</span><span class="n">operationTimer</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">movedPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">SourceOperator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">movedPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// if current operator is finished...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="na">isFinished</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// let next operator know there will be no more data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">next</span><span class="p">.</span><span class="na">finish</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">next</span><span class="p">.</span><span class="na">getOperatorContext</span><span class="p">().</span><span class="na">recordFinish</span><span class="p">(</span><span class="n">operationTimer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  </span></span></span></code></pre></div></div>
<h3 id="分批返回查询计算结果给sql客户端">分批返回查询计算结果给SQL客户端</h3>
<p>Presto采用的是流水线的处理方式，数据在Presto的计算过程中是持续流动的，是分批执行和返回的，在某个任务内不需要前面的算子计算完所有数据再输出结果给后面的算子，在某个查询内也不需要前面的查询执行阶段的所有任务都计算完所有数据再输出结果给后面的查询执行阶段。因此，从SQL客户端来看，Presto也支持分批返回查询计算结果给SQL客户端。Presto这种流水线的机制，与Flink非常类似，他们都不像Spark批式处理那样，需要前面的查询执行阶段执行完再执行后米娜的查询执行阶段。</p>
<p>如果你用过MYSQL这类关系型数据库，一定听说过游标（cursor），也用过各种编程语言的JDBC驱动的getNext，通过这样的方式来每次获取SQL执行结果的一部分数据。Presto也提供了类似的机制，它会给SQL客户端一个QueryResult，其中包含一个nextUri。对于某个查询，每次请求QueryResult，都会得到一个新的nextUri，它的作用类似于游标。</p>
<ul>
<li>StatementClientV1::advance</li>
<li>ExecutingStatementResource::getQueryResults</li>
<li>Query::getNextResult</li>
</ul>
<h2 id="执行计划生成的设计实现">执行计划生成的设计实现</h2>
<h3 id="从sql到抽象语法树">从SQL到抽象语法树</h3>
<p>所有提供SQL查询的数据库、查询引擎都需要语法分析能力，它把非结构化的SQL字符串转换成一系列的词法符号（Token），然后通过特定规则解析词法符号，返回一个语法分析树（ParseTree），最终得到一个结构化的树状结构，这就是抽象语法树（AST）。</p>
<p>访问者模式的优点：</p>
<ul>
<li>避免修改元素类，遵循开闭原则</li>
<li>分离操作逻辑</li>
<li>支持新的操作拓展</li>
<li>多态分派</li>
</ul>
<p>不同的Node类通过accept方法适配访问者模式，入参是当前访问者对象以及一个上下文对象。当前的节点会接受访问这，并调用访问者的特定方法，这里以抽象语法树的节点为例，Node类调用visitNode方法，Statement类调用visitStatement方法</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Node</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">accept</span><span class="p">(</span><span class="n">AstVisitor</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">visitor</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitNode</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Statement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">extends</span><span class="w"> </span><span class="n">Node</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">accept</span><span class="p">(</span><span class="n">AstVisitor</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">visitor</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitStatement</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>对一个抽象语法树使用访问者模式的时候，无论根节点是什么类型，仅需要使用node.accept(visitor)语句，节点会帮我们导航到对应的访问者方法。</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="nf">invokeParser</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">sql</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="o">&lt;</span><span class="n">SqlBaseParser</span><span class="p">,</span><span class="w"> </span><span class="n">ParserRuleContext</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parseFunction</span><span class="p">,</span><span class="w"> </span><span class="n">ParsingOptions</span><span class="w"> </span><span class="n">parsingOptions</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 从sql字符串构建字节流，忽略大小写</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SqlBaseLexer</span><span class="w"> </span><span class="n">lexer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SqlBaseLexer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CaseInsensitiveStream</span><span class="p">(</span><span class="n">CharStreams</span><span class="p">.</span><span class="na">fromString</span><span class="p">(</span><span class="n">sql</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CommonTokenStream</span><span class="w"> </span><span class="n">tokenStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CommonTokenStream</span><span class="p">(</span><span class="n">lexer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SqlBaseParser</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SqlBaseParser</span><span class="p">(</span><span class="n">tokenStream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">initializer</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">parser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Override the default error strategy to not attempt inserting or deleting a token.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Otherwise, it messes up error reporting</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">parser</span><span class="p">.</span><span class="na">setErrorHandler</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DefaultErrorStrategy</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="nf">recoverInline</span><span class="p">(</span><span class="n">Parser</span><span class="w"> </span><span class="n">recognizer</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">throws</span><span class="w"> </span><span class="n">RecognitionException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextTokensContext</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputMismatchException</span><span class="p">(</span><span class="n">recognizer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">InputMismatchException</span><span class="p">(</span><span class="n">recognizer</span><span class="p">,</span><span class="w"> </span><span class="n">nextTokensState</span><span class="p">,</span><span class="w"> </span><span class="n">nextTokensContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">// PostProcessor用来显示捕捉某种语法错误并给出精确的错误提示</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 使用观察者模式，在语法分析的过程中触发回调</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">parser</span><span class="p">.</span><span class="na">addParseListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PostProcessor</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">parser</span><span class="p">.</span><span class="na">getRuleNames</span><span class="p">()),</span><span class="w"> </span><span class="n">parser</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lexer</span><span class="p">.</span><span class="na">removeErrorListeners</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">lexer</span><span class="p">.</span><span class="na">addErrorListener</span><span class="p">(</span><span class="n">LEXER_ERROR_LISTENER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">parser</span><span class="p">.</span><span class="na">removeErrorListeners</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">parser</span><span class="p">.</span><span class="na">addErrorListener</span><span class="p">(</span><span class="n">PARSER_ERROR_HANDLER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ParserRuleContext</span><span class="w"> </span><span class="n">tree</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// first, try parsing with potentially faster SLL mode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">parser</span><span class="p">.</span><span class="na">getInterpreter</span><span class="p">().</span><span class="na">setPredictionMode</span><span class="p">(</span><span class="n">PredictionMode</span><span class="p">.</span><span class="na">SLL</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  					</span><span class="c1">// 生成语法分析树对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseFunction</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">parser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ParseCancellationException</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// if we fail, parse with LL mode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">tokenStream</span><span class="p">.</span><span class="na">seek</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// rewind input stream</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">parser</span><span class="p">.</span><span class="na">reset</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">parser</span><span class="p">.</span><span class="na">getInterpreter</span><span class="p">().</span><span class="na">setPredictionMode</span><span class="p">(</span><span class="n">PredictionMode</span><span class="p">.</span><span class="na">LL</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseFunction</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">parser</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">// 使用访问者模式生成以Node为父类的抽象语法树结构</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AstBuilder</span><span class="p">(</span><span class="n">parsingOptions</span><span class="p">).</span><span class="na">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">StackOverflowError</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParsingException</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; is too large (stack overflow while parsing)&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p>通过访问者模式的一系列转换，Antlr的语法分析树结构终于被转换成Presto内部的抽象语法树结构。语法树节点不是扁平的结果，里面还存在很多抽象类。</p>
<ul>
<li>Statement：定义了最上层的SQL语句，Presto最常用的就是OLAP查询能力，即DQL语句（数据查询语言，对应Query），还有其他类型的SQL语句，如INSERT, EXPALIN, CREATE</li>
<li>Relation：表示关系代数中的关系类型，可以是一张表或视图，一个查询，也可以是任意复杂的关联操作</li>
<li>QeuryBody：表示DQL类型语法树的SQL结构，可以是集合操作组成的复杂SQL，也可以是基础的QuerySpecification结构，此外还支持特殊的Table查询和Values常量，一个查询本身也是一种关系，所以它归在了Relation下</li>
<li>Expression：表示表达式的结构。表达式是比较特殊的一类结构，它是一种计算逻辑（或者说是计算表达式），由操作符号和操作数组成，比如a+1 , a&gt;b</li>
</ul>
<p>QueryBody是查询的主体结构，QuerySpecification指定了最常见的查询主体，Relation则是关系，表示数据的来源，最后几乎所有元素都会依赖表达式，从列名引用、表名、WHERE语句中的过滤谓词等都在表达式的范畴内。</p>
<h3 id="语义分析">语义分析</h3>
<p>经过语法分析流程，一个SQL从最初的字符串转换成Presto引擎内部的抽象语法树结构。到了语义分析阶段，会结合元数据对抽象语法树做进一步的分析，主要是结合上下文验证SQL的正确性以及记录抽象语法树相关元数据。值得注意的是Presto在语义分析阶段没有生成新的树结构，分析所得到的元数据信息存放在一个Analysis类中，通过多个Map结构记录每个语法树节点（Key）的元数据信息（Value）。后续流程通过查找Analysis结构来获取对应的元数据。</p>
<p>数据源信息读取：包括表、视图、物化视图的表信息TableHandle，列信息ColumnHandle以及对应的表元数据TableMetadata，列元数据ColumnMetadata。查询这些元数据一方面是为了将其应用于后续的执行计划生成，另一个方面用于语义检查。</p>
<p>语义检查：有很多SQL规则是需要上下文信息共同维护的，包括对多节点的内容进行联合比对。比如SELECT语句的非聚合函数列是否和GROUP BY语句匹配，该约束在语义分析中由AggregationAnalyzer进行检查，这些是语法分析做不了的。</p>
<p>语义理解：包括消除歧义以及语法糖展开等操作</p>
<ul>
<li>a.b，指的是a表的b列还是Row Type类型a列的b字段，语法规则可能会产生二义性，语义分析阶段需要解决这些问题</li>
<li>select * from xxx，将*展开成所有列</li>
</ul>
<p>元数据分析：所有下游需要的信息都会在语义分析阶段记录下来，记录在Analysis对象中</p>
<ul>
<li>数据域（scope）分析：每个关系节点当前可用的列信息，通过自底向上的方式计算出来</li>
<li>聚合函数分析：收集每个QuerySpecification结构的聚合函数</li>
<li>类型分析：对表达式结构Expression的每个节点进行自底向上的类型推导，其中包含隐式转换信息的记录</li>
<li>函数解析：表达式的内容包含函数调用和操作符，本质上都可以看做是函数调用，引擎需要分析与抽象语法树对应的函数结构FunctionCall是否存在，参数类型是否匹配等</li>
</ul>
<p>语义分析阶段有两个核心的分析器StatementAnalyzer和ExpressionAnalyzer，一个用于分析Statement对象，一个用于分析Expression表达式对象。上文提到的类型分析、函数解析就是在ExpressionAnalyzer中完成的。他们的关注点不一样，这也是语法树节点为什么会有不同的抽象类。</p>
<h4 id="数据域分析">数据域分析</h4>
<p>Scope是StatementAnalyzer访问者的返回值，它表示当前抽象语法树节点能被引用的列信息，这里称为数据域。它的用途是记录可用的列信息，在语义分析中用来验证列名字符串是否存在于数据域中（合法性校验）。</p>
<ul>
<li>列信息用Field表示，它不仅包含了列名Name，类型信息Type，还包含了所属关系的别名relationAlias，比如Join节点，可以引用两个子关系的列，这个时候需要加上子表的名称才能构成唯一标识符。</li>
<li>RealtionType表示当前节点的关系，底层是Field列表，它封装了所有对关系的操作，是一个工具类</li>
<li>Scope建模了更加复杂的情况，对于关联、子查询等特殊场景（如semi-join/lateral join），除了当前的关系，还能引用外层的关系。通过parent字段（父级数据域）可以建模这种情况，验证字段合法性的时候可以查找父级数据域来判断字段是否存在。</li>
</ul>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sql">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">--- schema 为 tpch.sf1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">regionkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">regionkey</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">AS</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nation_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">nation</span><span class="w"> </span><span class="n">n</span></span></span></code></pre></div></div>
<p>region和nation这两个关系分别有自己的数据域，但是region所在域的parent指向了nation域，所以在子查询内不仅可以使用region表的列，还能使用外层nation表的列。</p>
<p>另外，CTE（Common Table Expression）特性使得查询中可以使用一些自定义的视图（表），通过namedQueries可以记录这些信息，注意它用来验证“表名字符串”是否合法，不是用来验证列信息的。</p>
<p>数据域的核心功能是识别语法结构中的字符串，判断它是否是一个合法的列引用（ColumnReference）信息。该过程主要发生在表达式分析器ExpressionAnalyzer的visitIdentifier方法和visitDereferenceExpression方法中，他们分别用来判断字符串和带&quot;.&ldquo;分隔符的字符串是否合法。识别动作的入口是Scope.resolveField函数，Field的名称包括列名以及底层关系名或者关系别名。Field的名称包括列名以及底层关系名或者关系别名。</p>
<h4 id="数据源信息读取">数据源信息读取</h4>
<p>对于查询类的SQL语句来说，元数据读取主要发生在Table节点，Presto引擎需获取以下信息：</p>
<ul>
<li>TableHandle：通过连接器获取表的数据结构，它的内容和底层数据源有关。Presto仅定义了一个抽象的ConnectorTablehandle接口，里面的内容为空。使用场景比如PageSourceProvder.createPageSource是Presto建模的数据读取接口，里面就有TableHandle作为入参，所以它需要包含数据表读取所需的内容。</li>
<li>ColumnHandle：通过连接器获取当前表的列信息，和TableHandle一样它也是一个抽象的定义</li>
<li>元数据信息：包括ConnectorTableMetadata和ColumnMetadata，两者分别是表和列的元数据信息，主要包括名称、类型、注释、属性。列的类型信息（Type)是最底层的类型，它是Presto定义的类型信息，Field的类型信息就是从元数据获取的。</li>
</ul>
<h4 id="语义理解">语义理解</h4>
<p>语义分析需要正确地理解表达式含义，处理有歧义的逻辑并提供归一化的数据结构，尽量为下游的执行计划模块屏蔽语法细节。Presto的列名和RowType的子字段其实代表不同的语义，但是复用了相同的语法结构DereferenceExpression。</p>
<p>DereferenceExpression节点的语义理解过程如下，Presto中的Dereference表示类似x.y.z这样的表达式，包含至少一个&rdquo;.&ldquo;分隔符，参考g4文件的定义，base=primaryExpression&rsquo;.&lsquo;fieldName=identifier，其中suffix是标识符类型，prefix可以是任意表达式类型。</p>
<p>对于x.y.z这样的DereferenceExpression结构，可以表示为如下几种情况：</p>
<ol>
<li>数据库为x，表为y，列为z的列名（如果一个语法结构指向一个列名，那么它是一个ColumnReference）</li>
<li>x表y列的z字段，其中y是RowType类型（类似于Hive的Struct结构）</li>
<li>x列的y列的z字段，x列和y列都是RowType类型</li>
</ol>
<p>因为存在上述多种情况，所以第一步尝试获取该结构的QualifiedName，此时DeferenceExpression需要满足每一段都是标识符，这样才可能是一个列引用。针对QualifiedName非空的情况使用数据域的tryRosolveField方法识别当前字段，有如下3种可能：</p>
<ol>
<li>列引用识别成功，命中刚刚提到的情况1</li>
<li>未能识别到列引用，此时调用数据域的isColumnReference判断表达式的所有Prefix前缀子集是否能识别为列引用，即情况2、3，识别成功，则进入下面主逻辑，调用process递归处理base部分的语法结构。</li>
<li>识别失败，说明当前DereferenceExpression非法，抛出异常</li>
</ol>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="nf">visitDereferenceExpression</span><span class="p">(</span><span class="n">DereferenceExpression</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">StackableAstVisitorContext</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c1">// 尝试转换成QualifiedName，这种情况下要求每个部分都是表示符</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">QualifiedName</span><span class="w"> </span><span class="n">qualifiedName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DereferenceExpression</span><span class="p">.</span><span class="na">getQualifiedName</span><span class="p">(</span><span class="n">node</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// 如果这个Dereference结构看起来像是带有库表限定的列名，先尝试匹配到列</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">qualifiedName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Scope</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">getScope</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="c1">// 尝试识别该字段</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">ResolvedField</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resolvedField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scope</span><span class="p">.</span><span class="na">tryResolveField</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">qualifiedName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resolvedField</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">return</span><span class="w"> </span><span class="n">handleResolvedField</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">resolvedField</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="c1">// 是一个非法的结构</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">scope</span><span class="p">.</span><span class="na">isColumnReference</span><span class="p">(</span><span class="n">qualifiedName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">throw</span><span class="w"> </span><span class="n">missingAttributeException</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">qualifiedName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c1">// 前缀存在列引用，进入递归解析，递归分析base结构</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="n">baseType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">getBase</span><span class="p">(),</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">baseType</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">RowType</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="n">semanticException</span><span class="p">(</span><span class="n">TYPE_MISMATCH</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">getBase</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;Expression %s is not of type ROW&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">getBase</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c1">// baseType一定是RowType</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">RowType</span><span class="w"> </span><span class="n">rowType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RowType</span><span class="p">)</span><span class="w"> </span><span class="n">baseType</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c1">// 根据fieldName确定子列名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">fieldName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">getField</span><span class="p">().</span><span class="na">getValue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Type</span><span class="w"> </span><span class="n">rowFieldType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="c1">// 验证fieldNmae是否真的存在</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">RowType</span><span class="p">.</span><span class="na">Field</span><span class="w"> </span><span class="n">rowField</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">rowType</span><span class="p">.</span><span class="na">getFields</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fieldName</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">rowField</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">rowFieldType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rowField</span><span class="p">.</span><span class="na">getType</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rowFieldType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="n">missingAttributeException</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">qualifiedName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">setExpressionType</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">rowFieldType</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span></span></span></code></pre></div></div>
<h3 id="生成初始逻辑执行计划">生成初始逻辑执行计划</h3>
<p>语法分析生成了抽象语法树，语义分析通过查询元数据和进一步解析生成了一个Analysis元数据对象。语义分析、执行计划是两套不同的体系，理论上是相互独立、各自演进。执行计划本质上是一种中间表达式（Intermidiate Representation, IR)，一种偏底层的描述语言，还是一种树状结构。IR使得优化器能够对SQL更好地进行优化。PlanNode类是所有执行计划节点的父类，它定义了IR结构的通用方法。生成初始逻辑执行计划就是遍历AST（抽象语法树），结合Analysis元数据生成IR的过程。优化器则是按照某些优化规则修改执行计划树的过程。</p>
<p>初始逻辑执行计划整体上在做如下两件事情。</p>
<ul>
<li>Statement结构转换：本质上是AST到IR结构的转变，结合语义分析阶段的Analysis结构，Presto通过访问者模式自底向上把AST结构转换成不同PlanNode结构。</li>
<li>Expression改写：对Expression结构进行重写，将变量名替换成Symbol唯一标识符，同时保留元数据信息，将ResolvedFunction信息编码到函数名称中。</li>
</ul>
<p>这不是独立发生的两件事情，Statement结构的转换会伴随着Expression的改写，只不过Expression的处理方式比较特别。</p>
<h4 id="statement结构转换">Statement结构转换</h4>
<p>AST的核心骨架是Statement结构，SQL语句最外层是Query，通过追踪LogicalPlanner的实现可以定位到createRelationPlan函数，它也是基于访问者模式来生成初始执行计划的，这里依赖两个核心类来完成执行计划的生成。</p>
<ul>
<li>RelationPlanner: 一个访问者，它专门处理关系结构之间的运算，比如关联JOIN、集合Union、底层表、表抽样等关系类型</li>
<li>QueryPlanner：对单个关系进行的变换操作，它包括过滤、投影变换、聚合、窗口函数、排序、分页等操作，核心就是把QuerySpecification结构包含的操作转换成执行计划节点</li>
</ul>
<p>RelationPlanner和QueryPlanner之间是相互嵌套的，遇到Relation就是调用RelationPlanner，遇到Query就会使用QueryPlanner。</p>
<h4 id="expression改写">Expression改写</h4>
<p>Presto引擎的核心模块之间存在耦合的情况，虽然AST和IR有着本质的区别，但是具体到Expression结构（Expression的子类），由于它表达的是一种逻辑运算，所以表达式在语法树和执行计划之间是复用的，语法分析生成的Expression结构一直被沿用到执行阶段。</p>
<p>IR使用Symbol作为全局唯一标识符来代替AST里面的变量名。AST中的变量名有很多表示方法，可能会出现重复，比如a + 1 as a，虽然AST把SQL结构化成语法分析树，但AST的表达式只有人能够理解，OLAP引擎还不能理解表达式之间变量的引用关系，如果t.col_a或者col_a指代的是哪一列，OLAP引擎无法解决。</p>
<p>为了复用AST的Expresssion结构，Presto为Symbol引入了一个SymbolReference表达式，它表示的是一个内部符号（Symbol），以取代AST里面的Identifier等变量名。内部符号本质就是字符串，它是唯一标识符，全局唯一。Symbol的生成逻辑位于SymbolAllocator中。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Symbol</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">Comparable</span><span class="o">&lt;</span><span class="n">Symbol</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Symbol</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">Expression</span><span class="w"> </span><span class="n">expression</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 必须是SymbolReference类型的表达式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">checkArgument</span><span class="p">(</span><span class="n">expression</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">SymbolReference</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Unexpected expression: %s&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Symbol</span><span class="p">(((</span><span class="n">SymbolReference</span><span class="p">)</span><span class="w"> </span><span class="n">expression</span><span class="p">).</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@JsonCreator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Symbol</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;name is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@JsonValue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 生成Symbol，name是唯一的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getName</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// Symbol转SymbolReference</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SymbolReference</span><span class="w"> </span><span class="nf">toSymbolReference</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SymbolReference</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Symbol的wrapper，复用Expression体系</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SymbolReference</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">extends</span><span class="w"> </span><span class="n">Expression</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SymbolReference</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  </span></span></span></code></pre></div></div>
<p>这里执行计划会用到如下两种元数据信息：</p>
<ul>
<li>表达式的类型信息：即Presto的Type，通过一个TypeAnalyzer工具类在执行计划期间重新进行语义分析来获取Expression类型信息</li>
<li>函数元数据信息ResolvedFunction，在语义分析阶段通过函数解析获取，参考ExpressionAnalyzer.visitFunctionCall方法，后续常量折叠等优化器需要用到它。该信息直接通过序列化+ZSTD（一种压缩算法名称）压缩+BASE32编码的方式集成到函数名称的字符串中。</li>
</ul>
<h4 id="使用plannode表达逻辑执行计划">使用PlanNode表达逻辑执行计划</h4>
<p>PlanNode是一个抽象类，包含以下核心函数：</p>
<ul>
<li>getSources：用于遍历执行计划，它会返回当前节点的子节点（从数据流的角度看，子节点是数据的上游）</li>
<li>replaceChildren：替换子节点，在访问者模式中递归生成新的执行计划</li>
<li>getOutputSymbols：向父节点提供的字段集合，类型是Symbol</li>
<li>accept：访问者模式的通用接口，执行计划节点的访问者父类是PlanVisitor</li>
</ul>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PlanNode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">PlanNodeId</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="nf">PlanNode</span><span class="p">(</span><span class="n">PlanNodeId</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;id is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">PlanNodeId</span><span class="w"> </span><span class="nf">getId</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PlanNode</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getSources</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Symbol</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getOutputSymbols</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">PlanNode</span><span class="w"> </span><span class="nf">replaceChildren</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">PlanNode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newChildren</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">accept</span><span class="p">(</span><span class="n">PlanVisitor</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="n">visitor</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitPlan</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div></div>
<p><strong>TableScanNode</strong></p>
<p>数据读取节点，一个TableScanNdoe代表一个底层数据源的读取操作，核心是如下3个变量：</p>
<ul>
<li>TableHandle：描述了如何读取一张表，里面包含了这个数据的位置信息，以及下推后的元数据信息，比如limit下推、聚合下推等信息</li>
<li>outputSymbols：当前节点提供的输出列，父类的重载方法getOutputSymbols会返回这个变量</li>
<li>assignments：记录了数据源的列信息到Symbol的映射关系。ColumnHandle建模了一个数据列，它可能存储额外的信息，比如ProjectionPushDown优化会裁剪复合列的读取，它仅读取复合结构中所需的子列，Hive连接器把这个信息记录在HiveColumnHandle中。注意这里的Symbol并不对应某个表达式结构，因为这里已经是Symbol血缘关系的最上游，其他Symbol都是通过重写表达式生成的。</li>
</ul>
<p><strong>FilterNode</strong></p>
<p>数据过滤节点，FilterNode对应了WHERE语句的数据过滤结构，它是一个表达式，记录在predicate变量中。source变量存储了上游的节点引用。结合前面提到的Symbol替换操作和上游节点的getOutputSymbols函数可以知道，在生成FilterNode的时候会把predicate表达式中的变量替换成上游的Symbol，这样表达式结构就从AST结构转换成IR结构了，引擎也就知道这个Symbol是从哪里来的，所以Symbol本质上是一种血缘信息。</p>
<p><strong>ProjectNode</strong></p>
<p>投影变换节点，投影变换节点是很常见的节点，可以对应SELECT语句中的变换操作，在引擎中也承担了很多非用户指定的转换操作，这些转换也是表达式结构。它的核心结构是Assignments，它使用了一个哈希表来记录与投影变换表达式对应的输出列（同样是Symbol类型）</p>
<p><strong>ExchangeNode</strong></p>
<p>数据交换节点，ExchangeNode用来描述数据交换的相关参数，它的地位很特殊，仅存在于逻辑执行计划阶段，后续分布式执行计划生成的时候，Fragmenter会依据此节点切分成多个查询执行阶段（Stage）。</p>
<p><strong>AggregateNode</strong></p>
<p>聚合操作节点，它专门处理当前查询结构的所有聚合操作</p>
<h2 id="执行计划优化的目的基本原理和基础算法">执行计划优化的目的、基本原理和基础算法</h2>
<h3 id="执行计划优化的基本原理">执行计划优化的基本原理</h3>
<p>SQL作为一项图灵奖级别的发明，其重要意义不仅在于发明了一种可以用作数据查询的语言，更重要的是发明了关系代数（relation algebra)这一工具，使得计算机理解和处理查询的语义更加方便。SQL查询语言的优化也是基于关系代数这一模型进行的。</p>
<p>所谓关系代数，是SQL从语句到执行计划的一种中间表示，首先它不是单纯的AST，而是一种经过进一步处理得到的中间表示，可以类比一般编程语言的中间语言（Intermidate representation），SQL优化的本质是对关系代数的优化。</p>
<p>总结使用关系代数进行查询优化的要点：</p>
<ul>
<li>SQL查询可以表示为关系代数</li>
<li>关系代数作为一种树形结构，实质上也可以表示查询的物理实现方案</li>
<li>关系代数可以进行局部的等价变换，变换前后返回的结果不变，但执行的成本不同</li>
<li>通过寻找执行成本最低的关系代数表示，就可以将一个SQL查询优化成更为高效的方案</li>
</ul>
<p>此外，很重要的一点是：实现关系代数的化简和优化，要依赖数据系统的物理性质，如存储设备的特性（顺序读性能、随机读性能、吞吐量）、存储内容的格式和排列（列式存储、行式存储、对某列进行分片）、包含的元数据和预计算结果（是否存在索引或物化视图）、聚合和计算单元的特性（单线程、并发计算、分布式计算、特殊加速硬件）。</p>
<p>综上所述，对SQL查询进行优化，既要在原先逻辑算子的基础上进行变换，又要考虑物理实现的特性，这就是很多查询系统存在逻辑方案和物理方案区别的原因。在优化时，往往存在一个从逻辑方案到物理方案进行变换的阶段。</p>
<p>事实上，从逻辑方案到物理方案的变换也可以划归为一种关系代数的优化问题，因为其本质上仍然是按照一定的规则将原模型中的局部等价地变换成一种可以物理执行的模型或算子。</p>
<h3 id="执行计划优化的基本算法">执行计划优化的基本算法</h3>
<p>现行主流的执行计划优化算法分为两类，基于规则的优化（RBO）和基于成本的优化（RBO）。</p>
<p>基于规则的优化的思路很简单，根据经验事先定义一些规则，比如谓词下推、topN优化等，将原先的执行计划转换成新的执行计划。</p>
<p>基于规则的优化算法在实际使用中仍然面对很多问题：</p>
<ul>
<li>变换规则的选择问题：哪些规则应该被应用？以什么顺序被使用？</li>
<li>变换效果评估的问题：经过变换的查询性能是否会变好？各种可能得方案那个更优？</li>
</ul>
<p>现阶段主流的方法都是基于成本估算的方法。也就是说，给定某一关系代数代表的执行方案，对这一方案的执行成本进行估算，最终选择估算成本最低的方案。虽然被称为基于成本的估算，但这类算法仍然需要结合规则进行方案探索。也就是说，基于成本的方法其实是通过不断的应用规则进行变换得到新的执行方案，然后对于方案的成本优劣进行最终选择。</p>
<p>Volcano Optimizer（火山优化器）是一种基于成本的优化算法，其目的是基于一些假设和工程算法的实现，在获得成本较优的执行计划的同时，可以通过剪枝和缓存中间结果（动态规划）的方法降低计算消耗。</p>
<p><strong>成本最优假设</strong></p>
<p>成本最优假设是理解Volcano Optimizer实现的要点之一。这一假设认为，在最优的方案当中，取局部的结果来看其方案也是最优的。成本最优假设利用了贪心算法的思想，在计算的过程中，如果一个方案是由几个局部区域组合而成的，那么在计算总成本时，我们只需要考虑每个局部目前已知的最优方案和成本即可。对于成本最优假设的更直观的描述是，如果关系代数局部的某个输入的计算成本上升，那么这一子树的整体成本趋向于上升，反之会下降。上述假设对于大部分关系代数算子都是有效的，但是并非百分之百准确。</p>
<p><strong>动态规划算法与等价集合</strong></p>
<p>由于引入了成本最优假设，在优化过程中就可以对任意子树目前已知的最优方案和最优成本进行缓存。在此后的计算过程中，如果需要利用这一子树，可以直接使用之前缓存的结果，这里应用了动态规则算法的思想。要实现这一算法，只需要建立缓存结果到子树双向映射，某一刻子树所有可能的变换方案组成的集合称为等价集合（Equivalent Set），等价集合将会维护自身元素当中具有最优成本的方案。</p>
<p><strong>自底向上和自顶向下</strong></p>
<p>自底向上的动态规划算法最为直观：当我们试图计算节点A的最优方案时，其子树上的每个节点对应的等价结合和最优方案都已经计算完成了，我们只需要在A节点上不断寻找可以应用的规则，并利用已经计算好的子树成本计算出母树的成本，就可以得到最优方案。然而这一方案存在以下难以解决的问题：</p>
<ul>
<li>不方便应用剪枝技巧：在查询中可能会遇到在父节点的某一种方案成本很高，后续完全无需考虑的情况，尽管如果，需要被利用的子计算都已经完成，这部分计算不可避免。</li>
<li>难以实现启发式计算和限制计算层数：由于程序要不断递归到最后才能得到比较好的方案，因此即使计算量比较大也无法提前获取到一个可行的方案并停止运行。</li>
</ul>
<p>因此，Volcano Optimizer采用了自顶向下的计算方法，在计算开始，每棵子树先按照原先的样子计算成本并作为初始结果。在不断应用规则的过程中，如果出现一种新的结构被加入当前的等价集合中，且这种等价集合具有更优的成本，这时需要向上冒泡到所有依赖这一子集合的父亲等价集合，更新集合里每个元素的成本并得到新的最优成本和方案。值得注意的是，在向上冒泡的过程中需要遍历父亲集合内的每一个方案，这是因为不同方案对于投入成本变化的敏感性不同，不能假设之前的最优方案仍然是最优的。自顶向上的方案尽管解决了一些问题，但是也带来了对关系代数节点操作繁琐、要不断维护父子等价集合的关系等问题，实现相对复杂。推荐Calcite。</p>
<h3 id="执行计划优化的设计实现">执行计划优化的设计实现</h3>
<p>Presto的执行计划包括初始逻辑执行计划（LogicalPlanner.planStatement）、优化后的逻辑执行计划（PlanOptimizer.optimize）、分布式执行计划（PlanFragmenter.createSubPlans）和物理执行计划（LocalExecutionPlanner.plan）4种。</p>
<p>逻辑执行计划：对SQL的语法分析树进行翻译，转换中间表达式IR，这个时候就是一个初始逻辑执行计划，它比声明式语言更丰富、更底层，比如GROUP BY语句会被翻译为（ProjectNode/GroupIdNode + AggregationNode），这种中间结构使得优化器能够很好地对它进行转换。</p>
<p>优化器：初始逻辑执行计划可以做进一步的优化，比如谓词下推、TopN转换等，这个时候初始逻辑执行计划变成优化后的逻辑执行计划。Presto有迭代式优化器和非迭代式优化器两种，主要是RBO规则，它们根据PlanOptimizers中定义的顺序来执行。这里其实还有一个基于CBO的ReorderJoin优化器，它使用查并集（Disjoint Set）结构计算出等价的JOIN结构，然后运用动态规划算法计算出成本最低的JOIN顺序，Presto没有在全局的维度维护多个执行计划，这一点和业界的CBO算法不一样。</p>
<p>分布式执行计划和物理执行计划：因为逻辑执行计划最终是为了转成物理执行计划，而优化器在优化的过程中也会借助底层的特性，所以在优化的过程中，从逻辑执行计划到物理执行计划是一个渐变的过程，两者之间没有明显的边界。优化后的逻辑计划其实是介于物理执行计划和逻辑执行计划之间的。Fragmenter最后把优化后的逻辑执行计划进行分片转换成分布式执行计划，每个分片就是一个查询执行阶段，这个Fragment结构在查询执行节点（Worker）上稍加转换就变成了最终的物理计划。</p>
<p>在Presto中所有优化器都需要实现PlanOptimizer接口，优化器主要分为迭代式优化器和非迭代式优化器（相对于迭代优化器而言，实际它不是显式分类）。<strong>迭代式优化器</strong>指多个功能相似的优化规则（Rule）组成一个规则组，每个规则专注一种逻辑，每个规则的逻辑相对简单，规则组内的所有优化规则会被尝试应用到当前的执行计划，如果执行计划有更新，会不断循环应用规则组的规则，直到执行计划不再改变。<strong>非迭代式优化器</strong>是Presto项目早期使用较多的优化器，这类优化器都需要实现一个完整的逻辑执行计划树访问者（visitor）并通过层层遍历完成优化逻辑。它擅长通过自顶向下或自底向上的方式来遍历逻辑执行计划树，从而完成一些逻辑复杂，需要状态的优化操作。很多经典的优化器（比如AddExchanges）就是基于访问者模式实现了插入全局数据交换节点（ExchangeNode）功能的。</p>
<h4 id="迭代式优化器">迭代式优化器</h4>
<p>每个优化规则都有特定的目标节点，可能还有一些附加的触发条件，判断当前执行计划节点是否能应用某个优化规则，这类需求称为模式匹配，它提供一下几个功能：</p>
<ul>
<li>指定作用的目标节点</li>
<li>指定节点需要满足的条件，这是一个逻辑表达式，可以由多个语句组成一个逻辑与结构</li>
<li>捕获匹配到的节点，方便优化器引用它们</li>
</ul>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PushPartialAggregationThroughExchange</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">Rule</span><span class="o">&lt;</span><span class="n">AggregationNode</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PushPartialAggregationThroughExchange</span><span class="p">(</span><span class="n">Metadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;metadata is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Capture</span><span class="o">&lt;</span><span class="n">ExchangeNode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EXCHANGE_NODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Capture</span><span class="p">.</span><span class="na">newCapture</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// pattern，目标节点为AggregationNode，且子节点为ExchangeNode，且数据交换节点不能有排序要求</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 因为在排序情况下聚合函数无法进行预聚合优化，只能在单个任务中完成聚合，captureAs捕获命中的exchange节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Pattern</span><span class="o">&lt;</span><span class="n">AggregationNode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PATTERN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aggregation</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="n">source</span><span class="p">().</span><span class="na">matching</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">exchange</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">.</span><span class="na">matching</span><span class="p">(</span><span class="n">node</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">getOrderingScheme</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">.</span><span class="na">capturedAs</span><span class="p">(</span><span class="n">EXCHANGE_NODE</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Pattern</span><span class="o">&lt;</span><span class="n">AggregationNode</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPattern</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PATTERN</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">AggregationNode</span><span class="w"> </span><span class="n">aggregationNode</span><span class="p">,</span><span class="w"> </span><span class="n">Captures</span><span class="w"> </span><span class="n">captures</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExchangeNode</span><span class="w"> </span><span class="n">exchangeNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">captures</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">EXCHANGE_NODE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">decomposable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aggregationNode</span><span class="p">.</span><span class="na">isDecomposable</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span></span></span></code></pre></div></div>
<p>Memo原本在Cascacd优化算法中是用来存储每个Group节点下面的等价执行计划片段，因为Presto始终只有一个执行计划，所有Memo的作用变成维护一个可变执行计划，同时Memo可以自动识别需要删除的节点，因为执行计划只有替换和插入操作，不会进行显式删除，所以需要一种识别机制来删除已废弃的节点。通过调用Memo.insertRecursive进行初始化，执行计划的每个节点都被映射成一个分组，也就是Memo.Group结构，原本PlanNode.getSources返回的下游节点，在这里全部替换成虚拟的GroupReference节点，通过它的id可以定位到一个分组，分组里存储着实际的执行计划节点，通过这种方式，节点之间的关系就解耦了，所以Memo的本质是：</p>
<ul>
<li>把一个执行计划变成一个Map结构，键是分组的id，值是对应的Group节点，里面存储了实际的执行计划节点</li>
<li>把执行计划节点的下游节点替换成GroupReference，这个分组是不变的，但是分组里面的计划节点可以发生变化</li>
</ul>
<p>IterativeOptimizer初始化时接收多个功能相似的优化规则作为入参并构建一个RuleIndex结构，它的key是优化规则中Pattern匹配的目标节点，这样在遍历执行计划的时候可以更高效地过滤无关规则。optimize逻辑将待优化的执行计划转换成一个Memo结构，然后对执行计划进行自顶向下的遍历，由以下3中explore函数负责特定范围的遍历逻辑。</p>
<ul>
<li>exploreGroup：完成当前节点所在子树的遍历，它由exploreNode和exploreChildren组成，外加一些条件判断语句</li>
<li>exploreNode：对当前节点应用规则组的所有优化规则</li>
<li>exploreChildren：对当前节点的所有子节点进行遍历</li>
</ul>
<p>optimize重载了父类的方法，new Memo命令把执行计划转换成Memo结构，调用getRootGroup获取根节点进行exploreGroup遍历操作。注意所有exploreXXX函数都会返回布尔值变量来标识是否更新了执行计划。如果有进展，exploreGroup内部的exploreNode+exploreChildren会重新执行一次。执行计划树的PlanNode本身是不可变的，如果当前节点有变更，需要递归更新所有父节点，而优化器会频繁变更执行计划树，所以通过Memo来支持可变执行计划。</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-java">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">IterativeOptimizer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">PlanOptimizer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RuleStatsRecorder</span><span class="w"> </span><span class="n">stats</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">StatsCalculator</span><span class="w"> </span><span class="n">statsCalculator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CostCalculator</span><span class="w"> </span><span class="n">costCalculator</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PlanOptimizer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">legacyRules</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RuleIndex</span><span class="w"> </span><span class="n">ruleIndex</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Session</span><span class="o">&gt;</span><span class="w"> </span><span class="n">useLegacyRules</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">IterativeOptimizer</span><span class="p">(</span><span class="n">RuleStatsRecorder</span><span class="w"> </span><span class="n">stats</span><span class="p">,</span><span class="w"> </span><span class="n">StatsCalculator</span><span class="w"> </span><span class="n">statsCalculator</span><span class="p">,</span><span class="w"> </span><span class="n">CostCalculator</span><span class="w"> </span><span class="n">costCalculator</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Rule</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">rules</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span><span class="w"> </span><span class="n">statsCalculator</span><span class="p">,</span><span class="w"> </span><span class="n">costCalculator</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">of</span><span class="p">(),</span><span class="w"> </span><span class="n">rules</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">IterativeOptimizer</span><span class="p">(</span><span class="n">RuleStatsRecorder</span><span class="w"> </span><span class="n">stats</span><span class="p">,</span><span class="w"> </span><span class="n">StatsCalculator</span><span class="w"> </span><span class="n">statsCalculator</span><span class="p">,</span><span class="w"> </span><span class="n">CostCalculator</span><span class="w"> </span><span class="n">costCalculator</span><span class="p">,</span><span class="w"> </span><span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Session</span><span class="o">&gt;</span><span class="w"> </span><span class="n">useLegacyRules</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PlanOptimizer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">legacyRules</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Rule</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">newRules</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;stats is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">statsCalculator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">statsCalculator</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;statsCalculator is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">costCalculator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">costCalculator</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;costCalculator is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">useLegacyRules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requireNonNull</span><span class="p">(</span><span class="n">useLegacyRules</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;useLegacyRules is null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">legacyRules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">copyOf</span><span class="p">(</span><span class="n">legacyRules</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 初始化，构造ruleIndex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">ruleIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RuleIndex</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">newRules</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">stats</span><span class="p">.</span><span class="na">registerAll</span><span class="p">(</span><span class="n">newRules</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// 优化逻辑，重写PlanOptimizer中的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">PlanNode</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="n">PlanNode</span><span class="w"> </span><span class="n">plan</span><span class="p">,</span><span class="w"> </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">TypeProvider</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="n">SymbolAllocator</span><span class="w"> </span><span class="n">symbolAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">PlanNodeIdAllocator</span><span class="w"> </span><span class="n">idAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">WarningCollector</span><span class="w"> </span><span class="n">warningCollector</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// only disable new rules if we have legacy rules to fall back to</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">useLegacyRules</span><span class="p">.</span><span class="na">test</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">legacyRules</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">PlanOptimizer</span><span class="w"> </span><span class="n">optimizer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">legacyRules</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">optimizer</span><span class="p">.</span><span class="na">optimize</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">symbolAllocator</span><span class="p">.</span><span class="na">getTypes</span><span class="p">(),</span><span class="w"> </span><span class="n">symbolAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">idAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">warningCollector</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">plan</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">// 转换成Memo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Memo</span><span class="w"> </span><span class="n">memo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Memo</span><span class="p">(</span><span class="n">idAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">plan</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Lookup</span><span class="w"> </span><span class="n">lookup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lookup</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">planNode</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">memo</span><span class="p">.</span><span class="na">resolve</span><span class="p">(</span><span class="n">planNode</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">// 超时控制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Duration</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemSessionProperties</span><span class="p">.</span><span class="na">getOptimizerTimeout</span><span class="p">(</span><span class="n">session</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Context</span><span class="p">(</span><span class="n">memo</span><span class="p">,</span><span class="w"> </span><span class="n">lookup</span><span class="p">,</span><span class="w"> </span><span class="n">idAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">symbolAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">(),</span><span class="w"> </span><span class="n">timeout</span><span class="p">.</span><span class="na">toMillis</span><span class="p">(),</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">warningCollector</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">exploreGroup</span><span class="p">(</span><span class="n">memo</span><span class="p">.</span><span class="na">getRootGroup</span><span class="p">(),</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">// 从Memo结构转换成执行计划</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">memo</span><span class="p">.</span><span class="na">extract</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">exploreGroup</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">// progress变量跟踪当前Group或者子节点是否由于应用了优化规则而发生变换</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 对当前节点进行优化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exploreNode</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="c1">// 递归遍历子节点进行优化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">exploreChildren</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="n">如果子节点发生变更</span><span class="err">，</span><span class="n">再次尝试对当前节点进行优化</span><span class="err">，</span><span class="n">也许能应用新的规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exploreNode</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 当前节点无更新，退出</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">progress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">exploreNode</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 根据GroupID获取真正的执行计划节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PlanNode</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">memo</span><span class="p">.</span><span class="na">getNode</span><span class="p">(</span><span class="n">group</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="na">checkTimeoutNotExhausted</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="c1">// getCandicates可以快速过滤无关的优化规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Rule</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">possiblyMatchingRules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ruleIndex</span><span class="p">.</span><span class="na">getCandidates</span><span class="p">(</span><span class="n">node</span><span class="p">).</span><span class="na">iterator</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">possiblyMatchingRules</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Rule</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">possiblyMatchingRules</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rule</span><span class="p">.</span><span class="na">isEnabled</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">session</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">								</span><span class="c1">// 对当前节点应用一个优化规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Rule</span><span class="p">.</span><span class="na">Result</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transform</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">								</span><span class="c1">// 成功应用了规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getTransformedPlan</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  	</span><span class="c1">// 用优化后的结果替换当前节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">memo</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">getTransformedPlan</span><span class="p">().</span><span class="na">get</span><span class="p">(),</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">progress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Rule</span><span class="p">.</span><span class="na">Result</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">PlanNode</span><span class="w"> </span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">Rule</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Capture</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nodeCapture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCapture</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Pattern</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="na">getPattern</span><span class="p">().</span><span class="na">capturedAs</span><span class="p">(</span><span class="n">nodeCapture</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="c1">// 调用match函数进行模式匹配</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Match</span><span class="o">&gt;</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pattern</span><span class="p">.</span><span class="na">match</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">lookup</span><span class="p">).</span><span class="na">iterator</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">matches</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Match</span><span class="w"> </span><span class="n">match</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matches</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">duration</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Rule</span><span class="p">.</span><span class="na">Result</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">// 应用单条优化规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="na">capture</span><span class="p">(</span><span class="n">nodeCapture</span><span class="p">),</span><span class="w"> </span><span class="n">match</span><span class="p">.</span><span class="na">captures</span><span class="p">(),</span><span class="w"> </span><span class="n">ruleContext</span><span class="p">(</span><span class="n">context</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">stats</span><span class="p">.</span><span class="na">recordFailure</span><span class="p">(</span><span class="n">rule</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stats</span><span class="p">.</span><span class="na">record</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getTransformedPlan</span><span class="p">().</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Rule</span><span class="p">.</span><span class="na">Result</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">exploreChildren</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PlanNode</span><span class="w"> </span><span class="n">expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">memo</span><span class="p">.</span><span class="na">getNode</span><span class="p">(</span><span class="n">group</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">PlanNode</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">expression</span><span class="p">.</span><span class="na">getSources</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">checkState</span><span class="p">(</span><span class="n">child</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">GroupReference</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Expected child to be a group reference. Found: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exploreGroup</span><span class="p">(((</span><span class="n">GroupReference</span><span class="p">)</span><span class="w"> </span><span class="n">child</span><span class="p">).</span><span class="na">getGroupId</span><span class="p">(),</span><span class="w"> </span><span class="n">context</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">// 记录执行计划是否发生变更</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">progress</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span></span></span></code></pre></div></div>
<p>核心步骤在于单个执行计划节点的优化，即exploreNode函数，注意explore的入参都是GroupID，需要查找Memo获取真正的执行计划节点。这里有如下两个变量：</p>
<ul>
<li>done：用来表示是否还需要对当前节点应用优化规则，如果有优化规则被成功地应用到当前节点，则说明还可以继续尝试</li>
<li>progress：只要有优化规则被成功应用，progress=true</li>
</ul>
<p>transform函数会使用Pattern进行匹配，如果规则被成功应用，那么该函数返回的结果不为空，此时调用Memo.replace原执行计划节点替换成新的执行计划节点，transform函数执行分成两步：</p>
<ul>
<li>获取当前规则的Pattern进行模式匹配，通过这一步确定是否应用当前规则</li>
<li>如果匹配成功，那么会调用Rule.apply函数执行优化规则，第一个入参是Pattern指定的目标节点，第二个入参是Captures对象，通过它可以找到Pattern中的某个执行计划节点</li>
</ul>
<h4 id="非迭代式优化器">非迭代式优化器</h4>
<p>非迭代式优化器只需要实现PlanOptimizer接口，具体的优化方式不限，一般来说，这类优化器都需要通过访问者模式遍历执行计划树，适用于需要在执行计划节点之间建立密切联系的优化规则。这类优化器大多数都能通过自顶向下+自底向上的方式来计算当前子树的某些属性，当不满足属性或者满足特定条件的时候，会插入特定的执行计划节点或者修改当前节点的某些属性。</p>
<ul>
<li>AddExchanges: 添加查询分布式执行时的数据交换节点，对应的节点是ExchangeNode[scope=REMOTE]</li>
<li>AddLocalExchanges：添加单个任务执行时内部的数据交换节点，对应的节点是ExchangeNode[scope=LOCAL]</li>
<li>HashGenerationOptimizer：为需要分区的执行计划节点根据分区用到的列提前计算好哈希值，减少重复计算</li>
<li>PredicatePushDown：自顶向下把过滤谓词尽量下推，使其靠近数据源读取的算子，此外动态过滤（dynamic filtering）特性也被当做一种下推操作在这个优化器中实现</li>
<li>UnaliasSymbolReference：将多余的投影映射简化，因为初始逻辑执行计划和优化器都会引入一些类似col_a as col_b的投影变换，这些变换可能是多余的，优化后整个逻辑执行计划看起来更易懂、清晰。</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-07-09</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/presto_query_submission/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on X" data-sharer="x" data-url="http://example.org/posts/presto_query_submission/" data-title="Presto查询提交流程" data-hashtags="Presto,Trino"><i class="fab fa-x-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Threads" data-sharer="threads" data-url="http://example.org/posts/presto_query_submission/" data-title="Presto查询提交流程"><i class="fab fa-threads fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/posts/presto_query_submission/" data-hashtag="Presto"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://example.org/posts/presto_query_submission/" data-title="Presto查询提交流程"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.org/posts/presto_query_submission/" data-title="Presto查询提交流程"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@14.9.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://example.org/posts/presto_query_submission/" data-title="Presto查询提交流程"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Diaspora" data-sharer="diaspora" data-url="http://example.org/posts/presto_query_submission/" data-title="Presto查询提交流程" data-description=""><i class="fab fa-diaspora fa-fw" aria-hidden="true"></i></a><a href="https://t.me/share/url?url=http%3a%2f%2fexample.org%2fposts%2fpresto_query_submission%2f&amp;text=Presto%e6%9f%a5%e8%af%a2%e6%8f%90%e4%ba%a4%e6%b5%81%e7%a8%8b" target="_blank" title="Share on Telegram"><i class="fab fa-telegram fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/presto/">Presto</a>,&nbsp;<a href="/tags/trino/">Trino</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/file_lock/" class="prev" rel="prev" title="文件锁"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>文件锁</a>
            <a href="/posts/trino-filter-project/" class="next" rel="next" title="Presto数据过滤和投影">Presto数据过滤和投影<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.140.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2026</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">xxxx</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js"></script><script>window.config={"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"ShadowUnderMoon/ShadowUnderMoon.github.io"}},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
