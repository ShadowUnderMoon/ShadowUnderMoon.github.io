<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Grpc源码分析 - 爱吃芒果</title><meta name=Description content="This is my cool site"><meta property="og:url" content="http://example.org/posts/grpc-in-practice/">
<meta property="og:site_name" content="爱吃芒果"><meta property="og:title" content="Grpc源码分析"><meta property="og:description" content="gprc流程概括 grpc的流程可以大致分成两个阶段，分别为grpc连接阶段和grpc交互阶段，如图所示（此图来自后面的参考文献）。
在RPC连接阶段，client和server之间建立起TCP连接，grpc底层依赖于HTTP2，因此client和server还需要协调frame的相关设置，例如frame的大小，滑动窗口的大小等。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-02T13:26:57+08:00"><meta property="article:modified_time" content="2025-05-02T13:26:57+08:00"><meta property="article:tag" content="Grpc"><meta name=twitter:card content="summary"><meta name=twitter:title content="Grpc源码分析"><meta name=twitter:description content="gprc流程概括 grpc的流程可以大致分成两个阶段，分别为grpc连接阶段和grpc交互阶段，如图所示（此图来自后面的参考文献）。
在RPC连接阶段，client和server之间建立起TCP连接，grpc底层依赖于HTTP2，因此client和server还需要协调frame的相关设置，例如frame的大小，滑动窗口的大小等。"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://example.org/posts/grpc-in-practice/><link rel=prev href=http://example.org/posts/java-concurrency-jmm/><link rel=next href=http://example.org/posts/spark-base/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Grpc源码分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/example.org\/posts\/grpc-in-practice\/"},"genre":"posts","keywords":"grpc","wordcount":23845,"url":"http:\/\/example.org\/posts\/grpc-in-practice\/","datePublished":"2025-05-02T13:26:57+08:00","dateModified":"2025-05-02T13:26:57+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"爱吃芒果"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=爱吃芒果>My cool site</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/page/archives/ title=Archives>Archives </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/page/search/ title=Search>Search </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=爱吃芒果>My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/page/archives/ title=Archives>Archives</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/page/search/ title=Search>Search</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Grpc源码分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>爱吃芒果</a></span>&nbsp;<span class=post-category>included in <a href=/categories/grpc/><i class="far fa-folder fa-fw" aria-hidden=true></i>Grpc</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-05-02>2025-05-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;23845 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;48 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#gprc流程概括>gprc流程概括</a><ul><li><a href=#client的流程>Client的流程</a></li><li><a href=#server流程>Server流程</a></li></ul></li><li><a href=#grpc-server的rpc连接阶段>grpc Server的rpc连接阶段</a><ul><li><a href=#grpc服务端http2握手>grpc服务端HTTP2握手</a></li></ul></li><li><a href=#grpc-server的rpc交互阶段>grpc server的rpc交互阶段</a><ul><li><a href=#headers-frame的处理>Headers Frame的处理</a></li><li><a href=#data-frame的处理>Data Frame的处理</a></li><li><a href=#setting-frame的处理>Setting Frame的处理</a></li></ul></li><li><a href=#server如何发送frame>server如何发送frame</a></li><li><a href=#grpc-server的流量控制>grpc server的流量控制</a><ul><li><a href=#采样流量控制-bdp估算和动态流量控制窗口>采样流量控制 BDP估算和动态流量控制窗口</a></li><li><a href=#controlbuffer数据结构>controlBuffer数据结构</a></li><li><a href=#connection-level流量控制>connection level流量控制</a></li><li><a href=#stream-level流量控制>stream level流量控制</a></li><li><a href=#grpc流量控制小结>grpc流量控制小结</a></li></ul></li><li><a href=#grpc-timeout实现>grpc timeout实现</a><ul><li><a href=#grpc-deadline在java中的实现>grpc deadline在java中的实现</a></li></ul></li><li><a href=#grpc-keepalive实现>grpc keepalive实现</a></li><li><a href=#参考文献>参考文献</a></li></ul></nav></div></div><div class=content id=content><h2 id=gprc流程概括>gprc流程概括</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/grpc-in-practice/grpc%E6%B5%81%E7%A8%8B%E6%A6%82%E6%8B%AC.png data-srcset="/posts/grpc-in-practice/grpc%E6%B5%81%E7%A8%8B%E6%A6%82%E6%8B%AC.png, /posts/grpc-in-practice/grpc%E6%B5%81%E7%A8%8B%E6%A6%82%E6%8B%AC.png 1.5x, /posts/grpc-in-practice/grpc%E6%B5%81%E7%A8%8B%E6%A6%82%E6%8B%AC.png 2x" data-sizes=auto alt=/posts/grpc-in-practice/grpc%E6%B5%81%E7%A8%8B%E6%A6%82%E6%8B%AC.png title=Image.png width=837 height=884></p><p>grpc的流程可以大致分成两个阶段，分别为grpc连接阶段和grpc交互阶段，如图所示（此图来自后面的参考文献）。</p><p>在RPC连接阶段，client和server之间建立起TCP连接，grpc底层依赖于HTTP2，因此client和server还需要协调frame的相关设置，例如frame的大小，滑动窗口的大小等。</p><p>在RPC交互阶段，client将数据发送给server，并等待server执行执行method之后返回结果。</p><h3 id=client的流程>Client的流程</h3><p>在RPC连接阶段，client接收到一个目标地址和一系列的DialOptions，然后</p><ol><li>配置连接参数，interceptor等，启动resolver</li><li>Rosovler根据目标地址获取server的地址列表（比如一个DNS name可能会指向多个server ip，dnsResolver是grpc内置的resolver之一），启动balancer</li><li>Balancer根据平衡策略，从诸多server地址中选择一个或者多个建立TCP连接</li><li>client在TCP连接建立完成之后，等待server发来的HTTP2 Setting frame，并调整自身的HTTP2相关配置，随后向server发送HTTP2 Setting frame</li></ol><p>在RPC交互阶段，某个rpc方法被调用后</p><ol><li>Client创建一个stream对象用来管理整个交互流程</li><li>Client将service name, method name等信息放到header frame中并发送给server</li><li>client将method的参数信息放到data frame中并发送给server</li><li>client等待server传回的header frame和data frame，一次rpc call的result status会被包含在header frame中，而method的返回值被包含在data frame中</li></ol><h3 id=server流程>Server流程</h3><p>在rpc连接阶段，server在完成一些初始化的配置之后，开始监听某个tcp端口，在和某个client建立了tcp连接之后完成http2 settting frame的交互。</p><p>在rpc交互阶段：</p><ol><li>server等待client发来的header frame，从而创建出一个stream对象来管理真个交互流程，根据header frame中的信息，server知道client请求的是哪一个service的那一个method</li><li>server接受到client发来的data frame，并执行method</li><li>server将执行是否成功等信息放在header frame中发送给client</li><li>server将method执行的结果（返回值）放在data frame中发送给client</li></ol><h2 id=grpc-server的rpc连接阶段>grpc Server的rpc连接阶段</h2><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%d&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterGreeterServer</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>server</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;server listening at %v&#34;</span><span class=p>,</span> <span class=nx>lis</span><span class=p>.</span><span class=nf>Addr</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>如上是一个简单的服务端程序，流程如下</p><ol><li>首先通过<code>net.Listener</code>监听tcp端口，毕竟grpc服务是基于tcp的</li><li>创建grpc server，并注册服务，<code>&amp;server{}</code>实际上就是服务的实现</li><li>阻塞等待来自client的访问</li></ol><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Listener</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>serve</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rawConn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>lis</span><span class=p>.</span><span class=nf>Accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>serveWG</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nf>handleRawConn</span><span class=p>(</span><span class=nx>lis</span><span class=p>.</span><span class=nf>Addr</span><span class=p>().</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>rawConn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nx>serveWG</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>grpc在一个for循环中等待来自client的访问，每次有新的client端访问，创建一个<code>net.Conn</code>，并创建一个新的goroutine处理这个<code>net.Conn</code>，所以这个连接上的请求，无论客户端调用哪一个远程访问或者调用几次，都会由这个goroutine处理。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>handleRawConn</span><span class=p>(</span><span class=nx>lisAddr</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>rawConn</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果grpc server已经关闭，那么同样关闭这个tcp连接
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>quit</span><span class=p>.</span><span class=nf>HasFired</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rawConn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置tcp超时时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rawConn</span><span class=p>.</span><span class=nf>SetDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>connectionTimeout</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Finish handshaking (HTTP2)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>st</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>newHTTP2Transport</span><span class=p>(</span><span class=nx>rawConn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 清理tcp超时时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rawConn</span><span class=p>.</span><span class=nf>SetDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>  <span class=c1>// rpc交互阶段，创建新的goroutine处理来自client的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nf>serveStreams</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>st</span><span class=p>,</span> <span class=nx>rawConn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nf>removeConn</span><span class=p>(</span><span class=nx>lisAddr</span><span class=p>,</span> <span class=nx>st</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>在这里，首先判断gprc server是否关闭，如果关闭，则同样关闭tcp连接。然后进行HTTP2的握手，这里专门设置了tcp超时时间，避免握手迟迟不结束，导致资源占用，在握手结束后，清理tcp超时时间，避免对后面请求的影响。最后新启动一个goroutine，用来处理实际的请求。</p><h3 id=grpc服务端http2握手>grpc服务端HTTP2握手</h3><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>newHTTP2Transport</span><span class=p>(</span><span class=nx>c</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>)</span> <span class=nx>transport</span><span class=p>.</span><span class=nx>ServerTransport</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 组装 serverconfig
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>config</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>transport</span><span class=p>.</span><span class=nx>ServerConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>MaxStreams</span><span class=p>:</span>            <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>maxConcurrentStreams</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ConnectionTimeout</span><span class=p>:</span>     <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>connectionTimeout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 根据config的配置项，和client进行http2的握手
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>st</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>transport</span><span class=p>.</span><span class=nf>NewServerTransport</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>config</span><span class=p>)</span></span></span></code></pre></div></div><p>根据使用者在启动grpc server时的配置项，或者默认的配置项，调用<code>transport.NewServerTransport</code>完成和client的http2握手。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>writeBufSize</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>WriteBufferSize</span>
</span></span><span class=line><span class=cl>	<span class=nx>readBufSize</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ReadBufferSize</span>
</span></span><span class=line><span class=cl>	<span class=nx>maxHeaderListSize</span> <span class=o>:=</span> <span class=nx>defaultServerMaxHeaderListSize</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>MaxHeaderListSize</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>maxHeaderListSize</span> <span class=p>=</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>MaxHeaderListSize</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>framer</span> <span class=o>:=</span> <span class=nf>newFramer</span><span class=p>(</span><span class=nx>conn</span><span class=p>,</span> <span class=nx>writeBufSize</span><span class=p>,</span> <span class=nx>readBufSize</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>SharedWriteBuffer</span><span class=p>,</span> <span class=nx>maxHeaderListSize</span><span class=p>)</span></span></span></code></pre></div></div><p>首先创建framer，用来负责接受和发送HTTP2 frame，是server和client交流的实际接口。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Send initial settings as connection preface to client.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>isettings</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>http2</span><span class=p>.</span><span class=nx>Setting</span><span class=p>{{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ID</span><span class=p>:</span>  <span class=nx>http2</span><span class=p>.</span><span class=nx>SettingMaxFrameSize</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Val</span><span class=p>:</span> <span class=nx>http2MaxFrameLen</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>MaxStreams</span> <span class=o>!=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>MaxUint32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>isettings</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>isettings</span><span class=p>,</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>Setting</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ID</span><span class=p>:</span>  <span class=nx>http2</span><span class=p>.</span><span class=nx>SettingMaxConcurrentStreams</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Val</span><span class=p>:</span> <span class=nx>config</span><span class=p>.</span><span class=nx>MaxStreams</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>framer</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nf>WriteSettings</span><span class=p>(</span><span class=nx>isettings</span><span class=o>...</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>connectionErrorf</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=s>&#34;transport: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>grpc server端首先明确自己的HTTP2的初始配置，比如MaxFrameSize等，并将这些配置信息通过<code>frame.fr</code>发送给client，<code>frame.fr</code>实际上就是golang原生的<code>http2.Framer</code>，在底层，这些配置信息会被包装成一个Setting Frame发送给client。</p><p>client在收到Setting Frame后，根据自身情况调整参数，同样发送一个Setting Frame给sever。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>t</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http2Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>:</span>              <span class=nx>done</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>conn</span><span class=p>:</span>              <span class=nx>conn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>peer</span><span class=p>:</span>              <span class=nx>peer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>framer</span><span class=p>:</span>            <span class=nx>framer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>readerDone</span><span class=p>:</span>        <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>  <span class=nx>loopyWriterDone</span><span class=p>:</span>   <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>  <span class=nx>maxStreams</span><span class=p>:</span>        <span class=nx>config</span><span class=p>.</span><span class=nx>MaxStreams</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>inTapHandle</span><span class=p>:</span>       <span class=nx>config</span><span class=p>.</span><span class=nx>InTapHandle</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>fc</span><span class=p>:</span>                <span class=o>&amp;</span><span class=nx>trInFlow</span><span class=p>{</span><span class=nx>limit</span><span class=p>:</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>icwz</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span><span class=p>:</span>             <span class=nx>reachable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>activeStreams</span><span class=p>:</span>     <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>uint32</span><span class=p>]</span><span class=o>*</span><span class=nx>ServerStream</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>stats</span><span class=p>:</span>             <span class=nx>config</span><span class=p>.</span><span class=nx>StatsHandlers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>kp</span><span class=p>:</span>                <span class=nx>kp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>idle</span><span class=p>:</span>              <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>  <span class=nx>kep</span><span class=p>:</span>               <span class=nx>kep</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>initialWindowSize</span><span class=p>:</span> <span class=nx>iwz</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>bufferPool</span><span class=p>:</span>        <span class=nx>config</span><span class=p>.</span><span class=nx>BufferPool</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// controlbuf用来缓存Setting Frame等和设置相关的Frame的缓存
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span> <span class=p>=</span> <span class=nf>newControlBuffer</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>done</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 自增连接id
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>t</span><span class=p>.</span><span class=nx>connectionID</span> <span class=p>=</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>AddUint64</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>serverConnectionCounter</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// flush framer，确保向client发送了setting frame
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>t</span><span class=p>.</span><span class=nx>framer</span><span class=p>.</span><span class=nx>writer</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span></span></span></code></pre></div></div><p>grpc server在发送了setting frame之后，创建好<code>http2Server</code>对象，并等待client的后续消息。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Check the validity of client preface.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>preface</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>clientPreface</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// 读取客户端发来的client preface，并验证是否和预期一致
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadFull</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>conn</span><span class=p>,</span> <span class=nx>preface</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// In deployments where a gRPC server runs behind a cloud load balancer
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// which performs regular TCP level health checks, the connection is
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// closed immediately by the latter.  Returning io.EOF here allows the
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// grpc server implementation to recognize this scenario and suppress
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// logging to reduce spam.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>connectionErrorf</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=s>&#34;transport: http2Server.HandleStreams failed to receive the preface from client: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>!</span><span class=nx>bytes</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>preface</span><span class=p>,</span> <span class=nx>clientPreface</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>connectionErrorf</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;transport: http2Server.HandleStreams received bogus greeting from client: %q&#34;</span><span class=p>,</span> <span class=nx>preface</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 读取client端发来的frame
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>frame</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>framer</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nf>ReadFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=o>||</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>ErrUnexpectedEOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>connectionErrorf</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=s>&#34;transport: http2Server.HandleStreams failed to read initial settings frame: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>atomic</span><span class=p>.</span><span class=nf>StoreInt64</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>t</span><span class=p>.</span><span class=nx>lastRead</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>UnixNano</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1>// 转成SettingFrame
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>sf</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>frame</span><span class=p>.(</span><span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>SettingsFrame</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>connectionErrorf</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;transport: http2Server.HandleStreams saw invalid preface type %T from client&#34;</span><span class=p>,</span> <span class=nx>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 处理SettingFrame
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>t</span><span class=p>.</span><span class=nf>handleSettings</span><span class=p>(</span><span class=nx>sf</span><span class=p>)</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>handleSettings</span><span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>SettingsFrame</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果是ack frame，则直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nf>IsAck</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>ss</span> <span class=p>[]</span><span class=nx>http2</span><span class=p>.</span><span class=nx>Setting</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>updateFuncs</span> <span class=p>[]</span><span class=kd>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nf>ForeachSetting</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>s</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>Setting</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>s</span><span class=p>.</span><span class=nx>ID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 更新http2Server中的配置信息
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>SettingMaxHeaderListSize</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>updateFuncs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>updateFuncs</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>t</span><span class=p>.</span><span class=nx>maxSendHeaderListSize</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=kt>uint32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=o>*</span><span class=nx>t</span><span class=p>.</span><span class=nx>maxSendHeaderListSize</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Val</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>ss</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>ss</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 这里又遇到了controlBuf
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 执行updateFuncs()，然后将incommingSetting加入到controlBuf的队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>executeAndPut</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>f</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>updateFuncs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=o>&amp;</span><span class=nx>incomingSettings</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ss</span><span class=p>:</span> <span class=nx>ss</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>在HTTP2中，client和server都要求在建立连接前发送一个connection preface，作为对所使用协议的最终确认，并确定HTTP2连接的初始设置，client发送的preface一一个24字节的序列开始，之后紧跟着一个setting frame，用来表示client端最终决定的HTTP2配置参数。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>t</span><span class=p>.</span><span class=nx>loopy</span> <span class=p>=</span> <span class=nf>newLoopyWriter</span><span class=p>(</span><span class=nx>serverSide</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>framer</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bdpEst</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>conn</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>logger</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>outgoingGoAwayHandler</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bufferPool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>loopy</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nb>close</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>loopyWriterDone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>!</span><span class=nf>isIOError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>timer</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>timer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>readerDone</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>timer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=k>go</span> <span class=nx>t</span><span class=p>.</span><span class=nf>keepalive</span><span class=p>()</span></span></span></code></pre></div></div><p>此时server和client之间的HTTP2链接已经建立完成，RPC连接阶段完毕。在<code>NewServerTransport</code>的最后启动了<code>loopyWriter</code>，开始了rpc交互阶段，<code>loopyWriter</code>不断从<code>controlBuf</code>中读取control frames（包括setting frame)，并将缓存中的frame发送给client，可以说<code>loopyWriter</code>就是grpc server控制流量已经发送数据的地方。</p><p>这里另外启动了一个keepalive的goroutine，这个goroutine应该和grpc的keepalive机制有关。</p><h2 id=grpc-server的rpc交互阶段>grpc server的rpc交互阶段</h2><p>HTTP2中定义了很多类型的frame，包括data, headers等，具体如下，对于不同的frame类型，HTTP2 server应该有不同的处理逻辑。在grpc中，对frame类型的分类和处理，被包含在<code>func (s *Server) serveStreams</code>中。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// FrameType represents the type of an HTTP/2 Frame.
</span></span></span><span class=line><span class=cl><span class=c1>// See [Frame Type].
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// [Frame Type]: https://httpwg.org/specs/rfc7540.html#FrameType
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>FrameType</span> <span class=kt>uint8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Frame types defined in the HTTP/2 Spec.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>FrameTypeData</span>         <span class=nx>FrameType</span> <span class=p>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>	<span class=nx>FrameTypeHeaders</span>      <span class=nx>FrameType</span> <span class=p>=</span> <span class=mh>0x1</span>
</span></span><span class=line><span class=cl>	<span class=nx>FrameTypeRSTStream</span>    <span class=nx>FrameType</span> <span class=p>=</span> <span class=mh>0x3</span>
</span></span><span class=line><span class=cl>	<span class=nx>FrameTypeSettings</span>     <span class=nx>FrameType</span> <span class=p>=</span> <span class=mh>0x4</span>
</span></span><span class=line><span class=cl>	<span class=nx>FrameTypePing</span>         <span class=nx>FrameType</span> <span class=p>=</span> <span class=mh>0x6</span>
</span></span><span class=line><span class=cl>	<span class=nx>FrameTypeGoAway</span>       <span class=nx>FrameType</span> <span class=p>=</span> <span class=mh>0x7</span>
</span></span><span class=line><span class=cl>	<span class=nx>FrameTypeWindowUpdate</span> <span class=nx>FrameType</span> <span class=p>=</span> <span class=mh>0x8</span>
</span></span><span class=line><span class=cl>	<span class=nx>FrameTypeContinuation</span> <span class=nx>FrameType</span> <span class=p>=</span> <span class=mh>0x9</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>serveStreams</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>st</span> <span class=nx>transport</span><span class=p>.</span><span class=nx>ServerTransport</span><span class=p>,</span> <span class=nx>rawConn</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>streamQuota</span> <span class=o>:=</span> <span class=nf>newHandlerQuota</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>maxConcurrentStreams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 阻塞并接受来自client的frame
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>st</span><span class=p>.</span><span class=nf>HandleStreams</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>stream</span> <span class=o>*</span><span class=nx>transport</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>handlersWG</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>streamQuota</span><span class=p>.</span><span class=nf>acquire</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>defer</span> <span class=nx>streamQuota</span><span class=p>.</span><span class=nf>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>handlersWG</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 当一个新的stream被创建之后，进行一些配置
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>s</span><span class=p>.</span><span class=nf>handleStream</span><span class=p>(</span><span class=nx>st</span><span class=p>,</span> <span class=nx>stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>numServerWorkers</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>s</span><span class=p>.</span><span class=nx>serverWorkerChannel</span> <span class=o>&lt;-</span> <span class=nx>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=c1>// If all stream workers are busy, fallback to the default code path.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>st.HandleStreams</code>会阻塞当前goroutine，并等待来自client的frame，在一个for循环中等待并读取来自client的frame，并采取不同的处理方式。</p><p>grpc服务端使用一个goroutine向外发送数据<code>loopyWriter</code>，使用另一个goroutine读取数据<code>serverStreams</code>。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>HandleStreams</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>handle</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>ServerStream</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>readerDone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>loopyWriterDone</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// for循环，持续处理一个连接的上请求
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 限流
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>throttle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取frame
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>frame</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>framer</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nf>ReadFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>atomic</span><span class=p>.</span><span class=nf>StoreInt64</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>t</span><span class=p>.</span><span class=nx>lastRead</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>UnixNano</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 根据frame的类型分别处理
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>switch</span> <span class=nx>frame</span> <span class=o>:=</span> <span class=nx>frame</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// MetaHeaderFrame并不是http2的frame类型，而是经过包装的类型
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// headers frame + zero or more continuation frame + hspack编码内容的解码
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>MetaHeadersFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>operateHeaders</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>frame</span><span class=p>,</span> <span class=nx>handle</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Any error processing client headers, e.g. invalid stream ID,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// is considered a protocol violation.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>goAway</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>code</span><span class=p>:</span>      <span class=nx>http2</span><span class=p>.</span><span class=nx>ErrCodeProtocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>debugData</span><span class=p>:</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>closeConn</span><span class=p>:</span> <span class=nx>err</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>})</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>DataFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nf>handleData</span><span class=p>(</span><span class=nx>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>RSTStreamFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nf>handleRSTStream</span><span class=p>(</span><span class=nx>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>SettingsFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nf>handleSettings</span><span class=p>(</span><span class=nx>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>PingFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nf>handlePing</span><span class=p>(</span><span class=nx>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>WindowUpdateFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nf>handleWindowUpdate</span><span class=p>(</span><span class=nx>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>GoAwayFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// TODO: Handle GoAway from the client appropriately.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=nx>logLevel</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>t</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Received unsupported frame type %T&#34;</span><span class=p>,</span> <span class=nx>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h3 id=headers-frame的处理>Headers Frame的处理</h3><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>operateHeaders</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>frame</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>MetaHeadersFrame</span><span class=p>,</span> <span class=nx>handle</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>ServerStream</span><span class=p>))</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Acquire max stream ID lock for entire duration
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span><span class=p>.</span><span class=nx>maxStreamMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>t</span><span class=p>.</span><span class=nx>maxStreamMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 从客户端frame中获取streamID
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>streamID</span> <span class=o>:=</span> <span class=nx>frame</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>StreamID</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 校验stream id
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>streamID</span><span class=o>%</span><span class=mi>2</span> <span class=o>!=</span> <span class=mi>1</span> <span class=o>||</span> <span class=nx>streamID</span> <span class=o>&lt;=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>maxStreamID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// illegal gRPC stream id.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;received an illegal stream id: %v. headers frame: %+v&#34;</span><span class=p>,</span> <span class=nx>streamID</span><span class=p>,</span> <span class=nx>frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将获得的streamID设置到http2Server
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span><span class=p>.</span><span class=nx>maxStreamID</span> <span class=p>=</span> <span class=nx>streamID</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 无界message缓冲
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>buf</span> <span class=o>:=</span> <span class=nf>newRecvBuffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 创建stream
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ServerStream</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Stream</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>Stream</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>id</span><span class=p>:</span>  <span class=nx>streamID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>buf</span><span class=p>:</span> <span class=nx>buf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>fc</span><span class=p>:</span>  <span class=o>&amp;</span><span class=nx>inFlow</span><span class=p>{</span><span class=nx>limit</span><span class=p>:</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>initialWindowSize</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>st</span><span class=p>:</span>               <span class=nx>t</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>headerWireLength</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=nx>frame</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Length</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></div></div><p>在grpc server和client端，存在这一个stream的概念，用来表征一次grpc call。一个grpc call总是以一个来自client的headers frame开始，因此server会在<code>operateHeaders</code>中创建一个<code>Stream</code>对象，stream有一个client和server端一致的id，也有一个buf缓存。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>hf</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>frame</span><span class=p>.</span><span class=nx>Fields</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=nx>hf</span><span class=p>.</span><span class=nx>Name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=s>&#34;grpc-encoding&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>recvCompress</span> <span class=p>=</span> <span class=nx>hf</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=s>&#34;:method&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>// POST, GET这些
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>httpMethod</span> <span class=p>=</span> <span class=nx>hf</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=s>&#34;:path&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用grpc那个服务的那个方法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>s</span><span class=p>.</span><span class=nx>method</span> <span class=p>=</span> <span class=nx>hf</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=s>&#34;grpc-timeout&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nx>timeoutSet</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>timeout</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>decodeTimeout</span><span class=p>(</span><span class=nx>hf</span><span class=p>.</span><span class=nx>Value</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>headerError</span> <span class=p>=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Newf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>Internal</span><span class=p>,</span> <span class=s>&#34;malformed grpc-timeout: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>grpc server会遍历frame中的field，并将filed中的信息记录在stream中。<code>:method</code>和<code>:path</code>这两个field需要特别注意，client端需要填写好这两个field来明确地指定要调用server端提供的那一个方法，也就是说，调用哪一个server方法的信息是和调用方法的参数分开在不同的frame中的。</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>frame</span><span class=p>.</span><span class=nf>StreamEnded</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// s is just created by the caller. No lock needed.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>s</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>streamReadDone</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 超时设置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>timeoutSet</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>cancel</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>cancel</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>uint32</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>activeStreams</span><span class=p>))</span> <span class=o>&gt;=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>maxStreams</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>t</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cleanupStream</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>streamID</span><span class=p>:</span> <span class=nx>streamID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>rst</span><span class=p>:</span>      <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>rstCode</span><span class=p>:</span>  <span class=nx>http2</span><span class=p>.</span><span class=nx>ErrCodeRefusedStream</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>onWrite</span><span class=p>:</span>  <span class=kd>func</span><span class=p>()</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 将stream加入activeStreams map
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>t</span><span class=p>.</span><span class=nx>activeStreams</span><span class=p>[</span><span class=nx>streamID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>s</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>activeStreams</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>t</span><span class=p>.</span><span class=nx>idle</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Start a timer to close the stream on reaching the deadline.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>timeoutSet</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We need to wait for s.cancel to be updated before calling
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// t.closeStream to avoid data races.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>cancelUpdated</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>  <span class=nx>timer</span> <span class=o>:=</span> <span class=nx>internal</span><span class=p>.</span><span class=nf>TimeAfterFunc</span><span class=p>(</span><span class=nx>timeout</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;-</span><span class=nx>cancelUpdated</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>.</span><span class=nf>closeStream</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>ErrCodeCancel</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=nx>oldCancel</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>cancel</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>cancel</span> <span class=p>=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>oldCancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>timer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nb>close</span><span class=p>(</span><span class=nx>cancelUpdated</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>s</span><span class=p>.</span><span class=nx>trReader</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>transportReader</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>reader</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>recvBufferReader</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>:</span>     <span class=nx>s</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctxDone</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>ctxDone</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>recv</span><span class=p>:</span>    <span class=nx>s</span><span class=p>.</span><span class=nx>buf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>windowHandler</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>.</span><span class=nf>updateWindow</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Register the stream with loopy.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>registerStream</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>streamID</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>wq</span><span class=p>:</span>       <span class=nx>s</span><span class=p>.</span><span class=nx>wq</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nf>handle</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span></span></span></code></pre></div></div><p>这个新建的stream对象会被放到server的<code>activeStreams</code> map中，并调用回调函数<code>handle(s)</code>来进一步处理这个stream，其中最重要的是调用<code>s.handleStream</code>。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>st</span><span class=p>.</span><span class=nf>HandleStreams</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>stream</span> <span class=o>*</span><span class=nx>transport</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>handlersWG</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>streamQuota</span><span class=p>.</span><span class=nf>acquire</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>f</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>streamQuota</span><span class=p>.</span><span class=nf>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>handlersWG</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nf>handleStream</span><span class=p>(</span><span class=nx>st</span><span class=p>,</span> <span class=nx>stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果设置了worker池，则先尝试提交任务到worker池中，如果不行，新起goroutine执行
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>numServerWorkers</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>s</span><span class=p>.</span><span class=nx>serverWorkerChannel</span> <span class=o>&lt;-</span> <span class=nx>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=c1>// If all stream workers are busy, fallback to the default code path.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>go</span> <span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// initServerWorkers creates worker goroutines and a channel to process incoming
</span></span></span><span class=line><span class=cl><span class=c1>// connections to reduce the time spent overall on runtime.morestack.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>initServerWorkers</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>serverWorkerChannel</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>func</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>serverWorkerChannelClose</span> <span class=p>=</span> <span class=nx>sync</span><span class=p>.</span><span class=nf>OnceFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>serverWorkerChannel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nb>uint32</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>numServerWorkers</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nx>s</span><span class=p>.</span><span class=nf>serverWorker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>回调函数中会将处理stream的任务提交到其他goroutine中，如果可用的worker，则由worker执行，否则另起goroutine来执行。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>handleStream</span><span class=p>(</span><span class=nx>t</span> <span class=nx>transport</span><span class=p>.</span><span class=nx>ServerTransport</span><span class=p>,</span> <span class=nx>stream</span> <span class=o>*</span><span class=nx>transport</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取grpc路径
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sm</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Method</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pos</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>LastIndex</span><span class=p>(</span><span class=nx>sm</span><span class=p>,</span> <span class=s>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用的grpc service name
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>service</span> <span class=o>:=</span> <span class=nx>sm</span><span class=p>[:</span><span class=nx>pos</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用的grpc method name
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>method</span> <span class=o>:=</span> <span class=nx>sm</span><span class=p>[</span><span class=nx>pos</span><span class=o>+</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 从grpc server注册的service和method中找是否存在
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>srv</span><span class=p>,</span> <span class=nx>knownService</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>services</span><span class=p>[</span><span class=nx>service</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>knownService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// unary rpc
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>md</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>methods</span><span class=p>[</span><span class=nx>method</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nf>processUnaryRPC</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>stream</span><span class=p>,</span> <span class=nx>srv</span><span class=p>,</span> <span class=nx>md</span><span class=p>,</span> <span class=nx>ti</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// stream rpc
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>sd</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>streams</span><span class=p>[</span><span class=nx>method</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nf>processStreamingRPC</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>stream</span><span class=p>,</span> <span class=nx>srv</span><span class=p>,</span> <span class=nx>sd</span><span class=p>,</span> <span class=nx>ti</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>从这里也可以看出来，不同stream不会相互阻塞，不会因为应用层处理某个stream时间过长而导致其他stream失去响应。</p><p>根据handers frame中service和method的信息，grpc server找到注册好的method并执行，这里区分unary调用和streaming调用，分别对应<code>s.processUnaryRPC</code>和<code>s.processStreamingRPC</code>。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>processUnaryRPC</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>stream</span> <span class=o>*</span><span class=nx>transport</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>,</span> <span class=nx>info</span> <span class=o>*</span><span class=nx>serviceInfo</span><span class=p>,</span> <span class=nx>md</span> <span class=o>*</span><span class=nx>MethodDesc</span><span class=p>,</span> <span class=nx>trInfo</span> <span class=o>*</span><span class=nx>traceInfo</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 接收message并且解压缩
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>d</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>recvAndDecompress</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>parser</span><span class=p>{</span><span class=nx>r</span><span class=p>:</span> <span class=nx>stream</span><span class=p>,</span> <span class=nx>bufferPool</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>bufferPool</span><span class=p>},</span> <span class=nx>stream</span><span class=p>,</span> <span class=nx>dc</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>maxReceiveMessageSize</span><span class=p>,</span> <span class=nx>payInfo</span><span class=p>,</span> <span class=nx>decomp</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>df</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>v</span> <span class=nx>any</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nf>dataFree</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用proto codec将获取到的数据unmarshal到对应的请求类型
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>getCodec</span><span class=p>(</span><span class=nx>stream</span><span class=p>.</span><span class=nf>ContentSubtype</span><span class=p>()).</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>d</span><span class=p>,</span> <span class=nx>v</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>Internal</span><span class=p>,</span> <span class=s>&#34;grpc: error unmarshalling request: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=p>=</span> <span class=nf>NewContextWithServerTransportStream</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用实际的server端方法，得到返回结果
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>reply</span><span class=p>,</span> <span class=nx>appErr</span> <span class=o>:=</span> <span class=nx>md</span><span class=p>.</span><span class=nf>Handler</span><span class=p>(</span><span class=nx>info</span><span class=p>.</span><span class=nx>serviceImpl</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>df</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>unaryInt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Last=true表示stream最后的写操作，实际上好像没啥用
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>opts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>transport</span><span class=p>.</span><span class=nx>WriteOptions</span><span class=p>{</span><span class=nx>Last</span><span class=p>:</span> <span class=kc>true</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>sendResponse</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>stream</span><span class=p>,</span> <span class=nx>reply</span><span class=p>,</span> <span class=nx>cp</span><span class=p>,</span> <span class=nx>opts</span><span class=p>,</span> <span class=nx>comp</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>WriteStatus</span><span class=p>(</span><span class=nx>statusOK</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>可以看到处理UnaryRPC请求时，会先接受data frame消息，然后unmarshal到对应的请求类型，调用实际的server端方法，得到返回结果，最后将status <code>statusOK</code>发送给client，关闭stream。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>recvAndDecompress</span><span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>parser</span><span class=p>,</span> <span class=nx>s</span> <span class=nx>recvCompressor</span><span class=p>,</span> <span class=nx>dc</span> <span class=nx>Decompressor</span><span class=p>,</span> <span class=nx>maxReceiveMessageSize</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>payInfo</span> <span class=o>*</span><span class=nx>payloadInfo</span><span class=p>,</span> <span class=nx>compressor</span> <span class=nx>encoding</span><span class=p>.</span><span class=nx>Compressor</span><span class=p>,</span> <span class=nx>isServer</span> <span class=kt>bool</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=nx>out</span> <span class=nx>mem</span><span class=p>.</span><span class=nx>BufferSlice</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pf</span><span class=p>,</span> <span class=nx>compressed</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>recvMsg</span><span class=p>(</span><span class=nx>maxReceiveMessageSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>compressedLength</span> <span class=o>:=</span> <span class=nx>compressed</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>pf</span><span class=p>.</span><span class=nf>isCompressed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>compressed</span><span class=p>.</span><span class=nf>Free</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// To match legacy behavior, if the decompressor is set by WithDecompressor or RPCDecompressor,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// use this decompressor as the default.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>out</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>decompress</span><span class=p>(</span><span class=nx>compressor</span><span class=p>,</span> <span class=nx>compressed</span><span class=p>,</span> <span class=nx>dc</span><span class=p>,</span> <span class=nx>maxReceiveMessageSize</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>bufferPool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>out</span> <span class=p>=</span> <span class=nx>compressed</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>payInfo</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>payInfo</span><span class=p>.</span><span class=nx>compressedLength</span> <span class=p>=</span> <span class=nx>compressedLength</span>
</span></span><span class=line><span class=cl>		<span class=nx>out</span><span class=p>.</span><span class=nf>Ref</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>payInfo</span><span class=p>.</span><span class=nx>uncompressedBytes</span> <span class=p>=</span> <span class=nx>out</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>out</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>parser</span><span class=p>)</span> <span class=nf>recvMsg</span><span class=p>(</span><span class=nx>maxReceiveMessageSize</span> <span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=nx>payloadFormat</span><span class=p>,</span> <span class=nx>mem</span><span class=p>.</span><span class=nx>BufferSlice</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 读取message的header，总共5个字节
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nf>ReadMessageHeader</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>header</span><span class=p>[:])</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 是否压缩
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pf</span> <span class=o>:=</span> <span class=nf>payloadFormat</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>header</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 数据长度
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>length</span> <span class=o>:=</span> <span class=nx>binary</span><span class=p>.</span><span class=nx>BigEndian</span><span class=p>.</span><span class=nf>Uint32</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>header</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>length</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pf</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>recvMsg</code>根据http2的格式，读取message，<code>recvAndDecompress</code>如果数据被压缩过，返回解压缩后的数据。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>_Greeter_SayHello_Handler</span><span class=p>(</span><span class=nx>srv</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>dec</span> <span class=kd>func</span><span class=p>(</span><span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span><span class=p>,</span> <span class=nx>interceptor</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryServerInterceptor</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>in</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>HelloRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// unmarshal操作
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>dec</span><span class=p>(</span><span class=nx>in</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>interceptor</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>srv</span><span class=p>.(</span><span class=nx>GreeterServer</span><span class=p>).</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>info</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>UnaryServerInfo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Server</span><span class=p>:</span>     <span class=nx>srv</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>FullMethod</span><span class=p>:</span> <span class=nx>Greeter_SayHello_FullMethodName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>handler</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>srv</span><span class=p>.(</span><span class=nx>GreeterServer</span><span class=p>).</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>.(</span><span class=o>*</span><span class=nx>HelloRequest</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>interceptor</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>in</span><span class=p>,</span> <span class=nx>info</span><span class=p>,</span> <span class=nx>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>这里以入门的<code>sayHello</code>服务为例，可以看到最终没有使用反射，而是直接调用。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>payloadLen</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=nx>sizeLen</span>    <span class=p>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>	<span class=nx>headerLen</span>  <span class=p>=</span> <span class=nx>payloadLen</span> <span class=o>+</span> <span class=nx>sizeLen</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 这个方法很好理解，构造message header和payload
</span></span></span><span class=line><span class=cl><span class=c1>// msgHeader returns a 5-byte header for the message being transmitted and the
</span></span></span><span class=line><span class=cl><span class=c1>// payload, which is compData if non-nil or data otherwise.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>msgHeader</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>compData</span> <span class=nx>mem</span><span class=p>.</span><span class=nx>BufferSlice</span><span class=p>,</span> <span class=nx>pf</span> <span class=nx>payloadFormat</span><span class=p>)</span> <span class=p>(</span><span class=nx>hdr</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>payload</span> <span class=nx>mem</span><span class=p>.</span><span class=nx>BufferSlice</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>hdr</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>headerLen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>hdr</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>=</span> <span class=nb>byte</span><span class=p>(</span><span class=nx>pf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>length</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>pf</span><span class=p>.</span><span class=nf>isCompressed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>length</span> <span class=p>=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>compData</span><span class=p>.</span><span class=nf>Len</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nx>payload</span> <span class=p>=</span> <span class=nx>compData</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>length</span> <span class=p>=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nf>Len</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nx>payload</span> <span class=p>=</span> <span class=nx>data</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Write length of payload into buf
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>binary</span><span class=p>.</span><span class=nx>BigEndian</span><span class=p>.</span><span class=nf>PutUint32</span><span class=p>(</span><span class=nx>hdr</span><span class=p>[</span><span class=nx>payloadLen</span><span class=p>:],</span> <span class=nx>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>hdr</span><span class=p>,</span> <span class=nx>payload</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>sendResponse</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>stream</span> <span class=o>*</span><span class=nx>transport</span><span class=p>.</span><span class=nx>ServerStream</span><span class=p>,</span> <span class=nx>msg</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>cp</span> <span class=nx>Compressor</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>*</span><span class=nx>transport</span><span class=p>.</span><span class=nx>WriteOptions</span><span class=p>,</span> <span class=nx>comp</span> <span class=nx>encoding</span><span class=p>.</span><span class=nx>Compressor</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 编码
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>encode</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nf>getCodec</span><span class=p>(</span><span class=nx>stream</span><span class=p>.</span><span class=nf>ContentSubtype</span><span class=p>()),</span> <span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 压缩
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>compData</span><span class=p>,</span> <span class=nx>pf</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>compress</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>cp</span><span class=p>,</span> <span class=nx>comp</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>bufferPool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 构造header和payload
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hdr</span><span class=p>,</span> <span class=nx>payload</span> <span class=o>:=</span> <span class=nf>msgHeader</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>compData</span><span class=p>,</span> <span class=nx>pf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 交给http2server实际发送数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>hdr</span><span class=p>,</span> <span class=nx>payload</span><span class=p>,</span> <span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Write converts the data into HTTP2 data frame and sends it out. Non-nil error
</span></span></span><span class=line><span class=cl><span class=c1>// is returns if it fails (e.g., framing error, transport error).
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>write</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ServerStream</span><span class=p>,</span> <span class=nx>hdr</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>data</span> <span class=nx>mem</span><span class=p>.</span><span class=nx>BufferSlice</span><span class=p>,</span> <span class=nx>_</span> <span class=o>*</span><span class=nx>WriteOptions</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>reader</span> <span class=o>:=</span> <span class=nx>data</span><span class=p>.</span><span class=nf>Reader</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nf>isHeaderSent</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// Headers haven&#39;t been written yet.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>writeHeader</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=kc>nil</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>_</span> <span class=p>=</span> <span class=nx>reader</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Writing headers checks for this condition.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nf>getState</span><span class=p>()</span> <span class=o>==</span> <span class=nx>streamDone</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>_</span> <span class=p>=</span> <span class=nx>reader</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>t</span><span class=p>.</span><span class=nf>streamContextErr</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 构造 data frame
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>df</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>dataFrame</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>streamID</span><span class=p>:</span>    <span class=nx>s</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>:</span>           <span class=nx>hdr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>reader</span><span class=p>:</span>      <span class=nx>reader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>onEachWrite</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>setResetPingStrikes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 阻塞获取writeQuota
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>wq</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=nb>int32</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>hdr</span><span class=p>)</span> <span class=o>+</span> <span class=nx>df</span><span class=p>.</span><span class=nx>reader</span><span class=p>.</span><span class=nf>Remaining</span><span class=p>()));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span> <span class=p>=</span> <span class=nx>reader</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>t</span><span class=p>.</span><span class=nf>streamContextErr</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将data frame放入controlBuf，异步发送
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=nx>df</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span> <span class=p>=</span> <span class=nx>reader</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>t</span><span class=p>.</span><span class=nf>incrMsgSent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>writeStatus</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ServerStream</span><span class=p>,</span> <span class=nx>st</span> <span class=o>*</span><span class=nx>status</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>hdrMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>hdrMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nf>getState</span><span class=p>()</span> <span class=o>==</span> <span class=nx>streamDone</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Attach the trailer metadata.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>headerFields</span> <span class=p>=</span> <span class=nf>appendHeaderFieldsFromMD</span><span class=p>(</span><span class=nx>headerFields</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>trailer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>trailingHeader</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>headerFrame</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>streamID</span><span class=p>:</span>  <span class=nx>s</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>hf</span><span class=p>:</span>        <span class=nx>headerFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>endStream</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>onWrite</span><span class=p>:</span>   <span class=nx>t</span><span class=p>.</span><span class=nx>setResetPingStrikes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Send a RST_STREAM after the trailers if the client has not already half-closed.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rst</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>getState</span><span class=p>()</span> <span class=o>==</span> <span class=nx>streamActive</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用 finishStream关闭stream
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span><span class=p>.</span><span class=nf>finishStream</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>rst</span><span class=p>,</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>ErrCodeNo</span><span class=p>,</span> <span class=nx>trailingHeader</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>sendResponse</code>构造响应，并且将消息存储在<code>controlBuf</code>中，最后由<code>loopyWriter</code>异步发送给client，<code>writeStatus</code>发送<code>traling header</code>尾部头信息，然后关闭流。</p><h3 id=data-frame的处理>Data Frame的处理</h3><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>handleData</span><span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>DataFrame</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>size</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Length</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Select the right stream to dispatch.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>getStream</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nf>getState</span><span class=p>()</span> <span class=o>==</span> <span class=nx>streamReadDone</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nf>closeStream</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>ErrCodeStreamClosed</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>size</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nf>Data</span><span class=p>())</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>pool</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bufferPool</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=nx>recvMsg</span><span class=p>{</span><span class=nx>buffer</span><span class=p>:</span> <span class=nx>mem</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nf>Data</span><span class=p>(),</span> <span class=nx>pool</span><span class=p>)})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nf>StreamEnded</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Received the end of stream from the client.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>s</span><span class=p>.</span><span class=nf>compareAndSwapState</span><span class=p>(</span><span class=nx>streamActive</span><span class=p>,</span> <span class=nx>streamReadDone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=nx>recvMsg</span><span class=p>{</span><span class=nx>err</span><span class=p>:</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>在处理data frame时</p><ol><li>根据stream ID，从server的activeStreams map中找到stream对象</li><li>从<code>bufferPool</code>中拿到一块buffer，并将frame的数据写入到buffer</li><li>将这块buffer保存到stream的<code>recvBuffer</code>中</li><li>如果读取结束，修改流状态为<code>streamReadDone</code>，并且写入<code>io.EOF</code>标记</li></ol><p><code>recvBuffer</code>中缓存的数据，最终会被前面提到的<code>recvAndDecompress</code>函数读取，从而在server端重建rpc的参数。</p><h3 id=setting-frame的处理>Setting Frame的处理</h3><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>handleSettings</span><span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>SettingsFrame</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nf>IsAck</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>ss</span> <span class=p>[]</span><span class=nx>http2</span><span class=p>.</span><span class=nx>Setting</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>updateFuncs</span> <span class=p>[]</span><span class=kd>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nf>ForeachSetting</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>s</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>Setting</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>s</span><span class=p>.</span><span class=nx>ID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>SettingMaxHeaderListSize</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>updateFuncs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>updateFuncs</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>t</span><span class=p>.</span><span class=nx>maxSendHeaderListSize</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=kt>uint32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=o>*</span><span class=nx>t</span><span class=p>.</span><span class=nx>maxSendHeaderListSize</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Val</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>ss</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>ss</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>executeAndPut</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>f</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>updateFuncs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>f</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=o>&amp;</span><span class=nx>incomingSettings</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ss</span><span class=p>:</span> <span class=nx>ss</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>handleSettings</code>并没有直接将settting frame的参数应用在server上，而是将其放到了<code>controlBuf</code>中。</p><h2 id=server如何发送frame>server如何发送frame</h2><p>grpc server在每次收到一个新的来自client的连接后，会创建一个Framer，这个Framer就是实际上负责发送和接收HTTP2 frame的接口，每一个client都对应一个Framer来处理来自该client的所有frame，不管这些frame是否属于同一个stream。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>framer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 一个包含了buffer的net.Conn的writer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>writer</span> <span class=o>*</span><span class=nx>bufWriter</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 原生的http2.Framer，负责数据读写
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fr</span>     <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>Framer</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>framer</code>其实就是对golang原生<code>http2.Framer</code>的封装。</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>bufWriter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pool</span>      <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span>
</span></span><span class=line><span class=cl>	<span class=nx>buf</span>       <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>offset</span>    <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>batchSize</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>conn</span>      <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span>       <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newBufWriter</span><span class=p>(</span><span class=nx>conn</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>,</span> <span class=nx>batchSize</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>pool</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span><span class=p>)</span> <span class=o>*</span><span class=nx>bufWriter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>bufWriter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>batchSize</span><span class=p>:</span> <span class=nx>batchSize</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>conn</span><span class=p>:</span>      <span class=nx>conn</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>pool</span><span class=p>:</span>      <span class=nx>pool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// this indicates that we should use non shared buf
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>pool</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nx>buf</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>batchSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>w</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>bufWriter</span><span class=p>)</span> <span class=nf>Write</span><span class=p>(</span><span class=nx>b</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 在write之间检查上一次write是否发生了错误
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果batchsize为0，说明不需要写缓存，直接向net.Conn写数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>batchSize</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// Buffer has been disabled.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>n</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>n</span><span class=p>,</span> <span class=nf>toIOError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>buf</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=nf>Get</span><span class=p>().(</span><span class=o>*</span><span class=p>[]</span><span class=kt>byte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nx>buf</span> <span class=p>=</span> <span class=o>*</span><span class=nx>b</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>written</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果写入的数据少于batchSize，则缓存，暂时不写入conn
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 如果写入的数据多余batchSize，则调用flushKeepBuffer不断写数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nb>len</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>copied</span> <span class=o>:=</span> <span class=nb>copy</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>w</span><span class=p>.</span><span class=nx>offset</span><span class=p>:],</span> <span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span> <span class=p>=</span> <span class=nx>b</span><span class=p>[</span><span class=nx>copied</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>		<span class=nx>written</span> <span class=o>+=</span> <span class=nx>copied</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nx>offset</span> <span class=o>+=</span> <span class=nx>copied</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>offset</span> <span class=p>&lt;</span> <span class=nx>w</span><span class=p>.</span><span class=nx>batchSize</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>flushKeepBuffer</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>written</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>written</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>bufWriter</span><span class=p>)</span> <span class=nf>Flush</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 刷新数据到conn
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>flushKeepBuffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Only release the buffer if we are in a &#34;shared&#34; mode
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>buf</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>w</span><span class=p>.</span><span class=nx>pool</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>buf</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nx>buf</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>bufWriter</span><span class=p>)</span> <span class=nf>flushKeepBuffer</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>offset</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>err</span> <span class=p>=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>buf</span><span class=p>[:</span><span class=nx>w</span><span class=p>.</span><span class=nx>offset</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nx>err</span> <span class=p>=</span> <span class=nf>toIOError</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nx>offset</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>grpc server实现了一个简单的缓存写给<code>http2.framer</code>作为<code>io.Writer</code>。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 全局writeBufferPool
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>writeBufferPoolMap</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>writeBufferMutex</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newFramer</span><span class=p>(</span><span class=nx>conn</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>,</span> <span class=nx>writeBufferSize</span><span class=p>,</span> <span class=nx>readBufferSize</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>sharedWriteBuffer</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>maxHeaderListSize</span> <span class=kt>uint32</span><span class=p>)</span> <span class=o>*</span><span class=nx>framer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>writeBufferSize</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>writeBufferSize</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>r</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span> <span class=p>=</span> <span class=nx>conn</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>readBufferSize</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置io.Reader
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>r</span> <span class=p>=</span> <span class=nx>bufio</span><span class=p>.</span><span class=nf>NewReaderSize</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>readBufferSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>pool</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sharedWriteBuffer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pool</span> <span class=p>=</span> <span class=nf>getWriteBufferPool</span><span class=p>(</span><span class=nx>writeBufferSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置io.Writer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>w</span> <span class=o>:=</span> <span class=nf>newBufWriter</span><span class=p>(</span><span class=nx>conn</span><span class=p>,</span> <span class=nx>writeBufferSize</span><span class=p>,</span> <span class=nx>pool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 创建framer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>f</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>framer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>writer</span><span class=p>:</span> <span class=nx>w</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>fr</span><span class=p>:</span>     <span class=nx>http2</span><span class=p>.</span><span class=nf>NewFramer</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nf>SetMaxReadFrameSize</span><span class=p>(</span><span class=nx>http2MaxFrameLen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Opt-in to Frame reuse API on framer to reduce garbage.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Frames aren&#39;t safe to read from after a subsequent call to ReadFrame.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>f</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nf>SetReuseFrames</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nx>MaxHeaderListSize</span> <span class=p>=</span> <span class=nx>maxHeaderListSize</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nx>ReadMetaHeaders</span> <span class=p>=</span> <span class=nx>hpack</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>http2InitHeaderTableSize</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>f</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// writeBuffer 使用sync.Pool
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>getWriteBufferPool</span><span class=p>(</span><span class=nx>size</span> <span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>writeBufferMutex</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>writeBufferMutex</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pool</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>writeBufferPoolMap</span><span class=p>[</span><span class=nx>size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>pool</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pool</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>New</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=nx>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>b</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=o>&amp;</span><span class=nx>b</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>writeBufferPoolMap</span><span class=p>[</span><span class=nx>size</span><span class=p>]</span> <span class=p>=</span> <span class=nx>pool</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pool</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>传递给<code>http2.framer</code>的<code>io.Reader</code>使用了<code>bifio</code> package。</p><p><code>writeBuffer</code>使用了go标准库中的<code>sync.Pool</code>，根据需要的size获取对应的<code>sync.Pool</code>，如果池中有对应的<code>byte[]</code>，获取然后返回，如果没有，创建新的<code>byte[]</code>并返回。池中元素的回收时机，go允许在任何时候自动回收池中的元素（gc）。</p><p>grpc server为每一个client创建一个<code>loopyWriter</code>，有这个<code>loopyWriter</code>负责发送数据。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>loopyWriter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 客户端还是服务端
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>side</span>      <span class=nx>side</span>
</span></span><span class=line><span class=cl>  <span class=c1>// controlBuffer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cbuf</span>      <span class=o>*</span><span class=nx>controlBuffer</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 发送配额
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sendQuota</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 发送端初始窗口大小 outbound initial window size
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>oiws</span>      <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 已经建立未清理的stream，在客户端，指所有已经将Headers发送出去的stream，
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 在服务端，指所有已经接收到Headers的stream
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>estdStreams</span> <span class=kd>map</span><span class=p>[</span><span class=kt>uint32</span><span class=p>]</span><span class=o>*</span><span class=nx>outStream</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 活跃stream列表，有数据需要发送且包含stream-level流控，里面的每个stream内部都有一个数据列表用来存放发送的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>activeStreams</span> <span class=o>*</span><span class=nx>outStreamList</span>
</span></span><span class=line><span class=cl>  <span class=c1>// http2.Framer的包装，用来实际读写数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>framer</span>        <span class=o>*</span><span class=nx>framer</span>
</span></span><span class=line><span class=cl>	<span class=nx>hBuf</span>          <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>  <span class=c1>// The buffer for HPACK encoding.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hEnc</span>          <span class=o>*</span><span class=nx>hpack</span><span class=p>.</span><span class=nx>Encoder</span> <span class=c1>// HPACK encoder.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bdpEst</span>        <span class=o>*</span><span class=nx>bdpEstimator</span>
</span></span><span class=line><span class=cl>	<span class=nx>draining</span>      <span class=kt>bool</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 底层tcp连接
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span>          <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span>
</span></span><span class=line><span class=cl>	<span class=nx>logger</span>        <span class=o>*</span><span class=nx>grpclog</span><span class=p>.</span><span class=nx>PrefixLogger</span>
</span></span><span class=line><span class=cl>	<span class=nx>bufferPool</span>    <span class=nx>mem</span><span class=p>.</span><span class=nx>BufferPool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Side-specific handlers
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ssGoAwayHandler</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>goAway</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>loopyWriter</code>从control buffer中接收frame，每个frame被单独处理，<code>loopyWriter</code>所做的大部分工作都用在处理data frame。loopWriter维护一个活跃stream的队列，每个stream维护data frame的列表。当loopyWriter获取到data frame，它将被加入对应stream的队列中。</p><p>loopyWriter遍历活跃stream的列表，每次处理一个节点，可以视作在所有stream上做round-robin调度。当处理一个stream时，loopyWriter将数据发送到对端，但不能超过流控的最大值，即需要小于<code>http2MaxFrameLen</code>，也要小于connection-level流控和stream-level流控的限制。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>t</span><span class=p>.</span><span class=nx>loopy</span> <span class=p>=</span> <span class=nf>newLoopyWriter</span><span class=p>(</span><span class=nx>serverSide</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>framer</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bdpEst</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>conn</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>logger</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>outgoingGoAwayHandler</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bufferPool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>loopy</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nb>close</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>loopyWriterDone</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>!</span><span class=nf>isIOError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>timer</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>timer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>readerDone</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>timer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}()</span></span></span></code></pre></div></div><p>还记得之前在gprc server端rpc连接阶段启动的一个goroutine吗？在其中创建了<code>loopWriter</code>，并且调用了<code>loopyWriter#run</code>方法。</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>run</span><span class=p>()</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 阻塞获取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>it</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>cbuf</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理controlBuffer中取出的数据，对于dataFrame来说，会将dataFrame放到对应stream的itemList的末尾
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>handle</span><span class=p>(</span><span class=nx>it</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送acitveStreams中第一个stream中最多16kb的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>processData</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>gosched</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=nx>hasdata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 非阻塞获取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>it</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>cbuf</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>it</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>handle</span><span class=p>(</span><span class=nx>it</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>processData</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将controlBuffer中所有数据都处理完
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>continue</span> <span class=nx>hasdata</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 没有activeStreams或者没有connection-level write quota时isEmpty为true
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>isEmpty</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>processData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果还有数据需要处理，继续处理
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>!</span><span class=nx>isEmpty</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span> <span class=nx>hasdata</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>gosched</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>gosched</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 当framer的writer buffer中数据过少时，yield processor来让其他goroutine向controlBuffer中填充数据
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>l</span><span class=p>.</span><span class=nx>framer</span><span class=p>.</span><span class=nx>writer</span><span class=p>.</span><span class=nx>offset</span> <span class=p>&lt;</span> <span class=nx>minBatchSize</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>runtime</span><span class=p>.</span><span class=nf>Gosched</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span> <span class=nx>hasdata</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 将写数据刷新，返回到上层循环阻塞等待
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>l</span><span class=p>.</span><span class=nx>framer</span><span class=p>.</span><span class=nx>writer</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span> <span class=nx>hasdata</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>run</code>方法从<code>controlBuf</code>中读取control frame，然后更新loopyWriter的内部状态或者将http2 frame发送到对端。loopyWriter将有数据需要发送的活跃stream保存在链表中，所有在活跃stream链表中的stream必须同时满足两个条件：</p><ol><li>有数据需要发送</li><li>stream-level流控配额可用</li></ol><p>在每次run循环的迭代中，除了处理传入的control frame外，loopyWriter还会调用<code>processData</code>，每次处理activeStreams中的一个节点。这导致HTTP2 frame被写入底层的write buffer，当controlBuf没有更多的control frame可供读取时，loopyWriter会刷新写缓冲区。作为一种优化，如果批大小过小loopyWriter会让出处理器，从而给流的goroutine一个机会来填充controlBuf。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>i</span> <span class=nx>any</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>incomingWindowUpdate</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nf>incomingWindowUpdateHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>outgoingWindowUpdate</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>outgoingWindowUpdateHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>incomingSettings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>incomingSettingsHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>outgoingSettings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>outgoingSettingsHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>headerFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>headerHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>registerStream</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nf>registerStreamHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>cleanupStream</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>cleanupStreamHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>earlyAbortStream</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>earlyAbortStreamHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>incomingGoAway</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>incomingGoAwayHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>dataFrame</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nf>preprocessData</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>ping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>pingHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>goAway</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nf>goAwayHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>outFlowControlSizeRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nf>outFlowControlSizeRequestHandler</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>closeConnection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Just return a non-I/O error and run() will flush and close the
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>ErrConnClosing</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;transport: unknown control message type %T&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>preprocessData</span><span class=p>(</span><span class=nx>df</span> <span class=o>*</span><span class=nx>dataFrame</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>str</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>estdStreams</span><span class=p>[</span><span class=nx>df</span><span class=p>.</span><span class=nx>streamID</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// If we got data for a stream it means that
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// stream was originated and the headers were sent out.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>str</span><span class=p>.</span><span class=nx>itl</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>str</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>empty</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>active</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nx>activeStreams</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>handle</code>函数对于不同类型的消息，使用不同的处理函数进行处理，如果消息是data frame，会将data frame塞进对应stream的itemList，如果stream状态为empty，则将stream状态切换成active，并将stream加入到activeStreams。</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>processData</span><span class=p>()</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// connection level流量控制
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 取出activeStreams中的第一个stream
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>str</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>activeStreams</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>()</span> <span class=c1>// Remove the first stream.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>str</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 第一个item一定是dataFrame，dataFrame是grpc中定义的数据结构，可能转换成多个http2 data frame在网络中传输
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 每个dataFrame有两个buffer，h保存grpc-message的header，data保存实际数据， 为了降低网络通信流量，data中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 的数据会被拷贝到h中，从而使http2 frame尽可能大
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dataItem</span> <span class=o>:=</span> <span class=nx>str</span><span class=p>.</span><span class=nx>itl</span><span class=p>.</span><span class=nf>peek</span><span class=p>().(</span><span class=o>*</span><span class=nx>dataFrame</span><span class=p>)</span> <span class=c1>// Peek at the first data item this stream.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>dataItem</span><span class=p>.</span><span class=nx>h</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>reader</span><span class=p>.</span><span class=nf>Remaining</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// Empty data frame
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Figure out the maximum size we can send
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// http2MaxFrameLen是一个常数，16kb
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>maxSize</span> <span class=o>:=</span> <span class=nx>http2MaxFrameLen</span>
</span></span><span class=line><span class=cl>  <span class=c1>// stream-level流控，byteOutStanding 表示未收到确认的字节数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>strQuota</span> <span class=o>:=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>oiws</span><span class=p>)</span> <span class=o>-</span> <span class=nx>str</span><span class=p>.</span><span class=nx>bytesOutStanding</span><span class=p>;</span> <span class=nx>strQuota</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// stream-level flow control.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>str</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>waitingOnStreamQuota</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>maxSize</span> <span class=p>&gt;</span> <span class=nx>strQuota</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>maxSize</span> <span class=p>=</span> <span class=nx>strQuota</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// connection-level流控
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>maxSize</span> <span class=p>&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// connection-level flow control.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>maxSize</span> <span class=p>=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Compute how much of the header and data we can send within quota and max frame length
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hSize</span> <span class=o>:=</span> <span class=nb>min</span><span class=p>(</span><span class=nx>maxSize</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>dataItem</span><span class=p>.</span><span class=nx>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>dSize</span> <span class=o>:=</span> <span class=nb>min</span><span class=p>(</span><span class=nx>maxSize</span><span class=o>-</span><span class=nx>hSize</span><span class=p>,</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>reader</span><span class=p>.</span><span class=nf>Remaining</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>remainingBytes</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>dataItem</span><span class=p>.</span><span class=nx>h</span><span class=p>)</span> <span class=o>+</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>reader</span><span class=p>.</span><span class=nf>Remaining</span><span class=p>()</span> <span class=o>-</span> <span class=nx>hSize</span> <span class=o>-</span> <span class=nx>dSize</span>
</span></span><span class=line><span class=cl>	<span class=nx>size</span> <span class=o>:=</span> <span class=nx>hSize</span> <span class=o>+</span> <span class=nx>dSize</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>buf</span> <span class=o>*</span><span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>hSize</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>dSize</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>buf</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>dataItem</span><span class=p>.</span><span class=nx>h</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将header和data的一部分写入buf中
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>pool</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>bufferPool</span>
</span></span><span class=line><span class=cl>		<span class=nx>buf</span> <span class=p>=</span> <span class=nx>pool</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>pool</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>((</span><span class=o>*</span><span class=nx>buf</span><span class=p>)[:</span><span class=nx>hSize</span><span class=p>],</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>reader</span><span class=p>.</span><span class=nf>Read</span><span class=p>((</span><span class=o>*</span><span class=nx>buf</span><span class=p>)[</span><span class=nx>hSize</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 补充stream-level write quota
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>str</span><span class=p>.</span><span class=nx>wq</span><span class=p>.</span><span class=nf>replenish</span><span class=p>(</span><span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>endStream</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=c1>// If this is the last data message on this stream and all of it can be written in this iteration.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>endStream</span> <span class=o>&amp;&amp;</span> <span class=nx>remainingBytes</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>endStream</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>onEachWrite</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>dataItem</span><span class=p>.</span><span class=nf>onEachWrite</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 通过framer向client发送数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>framer</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nf>WriteData</span><span class=p>(</span><span class=nx>dataItem</span><span class=p>.</span><span class=nx>streamID</span><span class=p>,</span> <span class=nx>endStream</span><span class=p>,</span> <span class=p>(</span><span class=o>*</span><span class=nx>buf</span><span class=p>)[:</span><span class=nx>size</span><span class=p>]);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>str</span><span class=p>.</span><span class=nx>bytesOutStanding</span> <span class=o>+=</span> <span class=nx>size</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 更新connection-level流量控制
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span> <span class=o>-=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>dataItem</span><span class=p>.</span><span class=nx>h</span> <span class=p>=</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>h</span><span class=p>[</span><span class=nx>hSize</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>remainingBytes</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// All the data from that message was written out.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>_</span> <span class=p>=</span> <span class=nx>dataItem</span><span class=p>.</span><span class=nx>reader</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span><span class=p>.</span><span class=nx>itl</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>str</span><span class=p>.</span><span class=nx>itl</span><span class=p>.</span><span class=nf>isEmpty</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>empty</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>trailer</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>str</span><span class=p>.</span><span class=nx>itl</span><span class=p>.</span><span class=nf>peek</span><span class=p>().(</span><span class=o>*</span><span class=nx>headerFrame</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span> <span class=c1>// The next item is trailers.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>writeHeader</span><span class=p>(</span><span class=nx>trailer</span><span class=p>.</span><span class=nx>streamID</span><span class=p>,</span> <span class=nx>trailer</span><span class=p>.</span><span class=nx>endStream</span><span class=p>,</span> <span class=nx>trailer</span><span class=p>.</span><span class=nx>hf</span><span class=p>,</span> <span class=nx>trailer</span><span class=p>.</span><span class=nx>onWrite</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>cleanupStreamHandler</span><span class=p>(</span><span class=nx>trailer</span><span class=p>.</span><span class=nx>cleanup</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nb>int</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>oiws</span><span class=p>)</span><span class=o>-</span><span class=nx>str</span><span class=p>.</span><span class=nx>bytesOutStanding</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// Ran out of stream quota.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>str</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>waitingOnStreamQuota</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span> <span class=c1>// Otherwise add it back to the list of active streams.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果 stream 中还有数据待发送, 那么将这个 stream enqueue 回 activeStreams
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>l</span><span class=p>.</span><span class=nx>activeStreams</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>dataFrame</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>streamID</span>  <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=nx>endStream</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>h</span>         <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>reader</span>    <span class=nx>mem</span><span class=p>.</span><span class=nx>Reader</span>
</span></span><span class=line><span class=cl>	<span class=c1>// onEachWrite is called every time
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a part of data is written out.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>onEachWrite</span> <span class=kd>func</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>processData</code>从activeStreams中移除第一个stream，向对端发送最多16kb的数据，如果有更多数据需要发送且还具有stream-level流控配额的话，将stream加入到activeStreams的末尾。</p><h2 id=grpc-server的流量控制>grpc server的流量控制</h2><p>grpc在应用层实现了自己的流量控制，并将流量控制分成了三个层级</p><ul><li>sample level 流量控制</li><li>connection level 流量控制</li><li>stream level 流量控制</li></ul><p>流量控制可以说是grpc高性能的关键，通过动态地控制数据发送和接收的速率，grpc保证在任何网络情况下都能发挥最大的性能，尽量提高传输带宽并降低传输延迟。</p><h3 id=采样流量控制-bdp估算和动态流量控制窗口>采样流量控制 BDP估算和动态流量控制窗口</h3><p>BDP和动态流量控制窗口缩小了grpc和http1.1在高延迟网络中的性能表现。带宽延迟积（BDP，Bandwidth Delay Product）是网络连接的带宽和数据往返延迟的乘积，能够有效地表示在网络被完全利用时网络上有多少字节数据。</p><p>BDP算法基本思路如下：</p><p>每次接收方收到一个data frame时，它就会发送一个BDP ping（一个带有唯一数据、仅用于BDP估算的ping）。在这之后，接收方开始统计它接收到的字节数（包括触发该BDP ping的那部分数据），直到它收到该ping的ack为止。这个在大约1.5个RTT（round-trip time）内接收到的字节总数，约为BDP的1.5倍。如果这个总字节数接近当前的窗口（比如超过窗口的2/3），那么我们必须增大窗口。我们将窗口大小（包括stremaing和connection窗口）设为采样得到的BDP的两倍（也就是接收到的字节总数的两倍）。</p><p>在grpc server端定义了一个<code>bdpEstimator</code>，是用来计算BDP的核心。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// bdpLimit is the maximum value the flow control windows will be increased
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to.  TCP typically limits this to 4MB, but some systems go up to 16MB.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Since this is only a limit, it is safe to make it optimistic.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bdpLimit</span> <span class=p>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>20</span><span class=p>)</span> <span class=o>*</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>	<span class=c1>// alpha is a constant factor used to keep a moving average
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// of RTTs.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>alpha</span> <span class=p>=</span> <span class=mf>0.9</span>
</span></span><span class=line><span class=cl>	<span class=c1>// If the current bdp sample is greater than or equal to
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// our beta * our estimated bdp and the current bandwidth
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// sample is the maximum bandwidth observed so far, we
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// increase our bbp estimate by a factor of gamma.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>beta</span> <span class=p>=</span> <span class=mf>0.66</span>
</span></span><span class=line><span class=cl>	<span class=c1>// To put our bdp to be smaller than or equal to twice the real BDP,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// we should multiply our current sample with 4/3, however to round things out
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// we use 2 as the multiplication factor.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>gamma</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Adding arbitrary data to ping so that its ack can be identified.
</span></span></span><span class=line><span class=cl><span class=c1>// Easter-egg: what does the ping message say?
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>bdpPing</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>ping</span><span class=p>{</span><span class=nx>data</span><span class=p>:</span> <span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=kt>byte</span><span class=p>{</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>7</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>bdpEstimator</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// sentAt is the time when the ping was sent.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sentAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>	<span class=c1>// bdp is the current bdp estimate.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bdp</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=c1>// sample is the number of bytes received in one measurement cycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sample</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=c1>// bwMax is the maximum bandwidth noted so far (bytes/sec).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bwMax</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl>	<span class=c1>// bool to keep track of the beginning of a new measurement cycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>isSent</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Callback to update the window sizes.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>updateFlowControl</span> <span class=kd>func</span><span class=p>(</span><span class=nx>n</span> <span class=kt>uint32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// sampleCount is the number of samples taken so far.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sampleCount</span> <span class=kt>uint64</span>
</span></span><span class=line><span class=cl>	<span class=c1>// round trip time (seconds)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rtt</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>bdpEstimator</code>有两个主要的方法<code>add</code>和<code>calculate</code></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// add的返回值指示loopyWriter是否发送BDP ping frame给client
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>bdpEstimator</span><span class=p>)</span> <span class=nf>add</span><span class=p>(</span><span class=nx>n</span> <span class=kt>uint32</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果bdp已经达到上限，就不再发送bdp ping进行采样
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>b</span><span class=p>.</span><span class=nx>bdp</span> <span class=o>==</span> <span class=nx>bdpLimit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果在当前时间点没有bdp ping frame发送出去，就应该发送，来进行采样
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>b</span><span class=p>.</span><span class=nx>isSent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nx>isSent</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nx>sample</span> <span class=p>=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nx>sentAt</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nx>sampleCount</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 已经有bdp ping frame发送出去了，但是还没有收到ack，累加收到的字节数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>b</span><span class=p>.</span><span class=nx>sample</span> <span class=o>+=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>add</code>函数有两个作用：</p><ul><li>告知<code>loopyWriter</code>是否开始采样</li><li>记录采样开始的时间和初始数据量</li></ul><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>handleData</span><span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>DataFrame</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>size</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Length</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>sendBDPPing</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bdpEst</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sendBDPPing</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bdpEst</span><span class=p>.</span><span class=nf>add</span><span class=p>(</span><span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>w</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>fc</span><span class=p>.</span><span class=nf>onData</span><span class=p>(</span><span class=nx>size</span><span class=p>);</span> <span class=nx>w</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>outgoingWindowUpdate</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>streamID</span><span class=p>:</span>  <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>increment</span><span class=p>:</span> <span class=nx>w</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sendBDPPing</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Avoid excessive ping detection (e.g. in an L7 proxy)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// by sending a window update prior to the BDP ping.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>w</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>fc</span><span class=p>.</span><span class=nf>reset</span><span class=p>();</span> <span class=nx>w</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>outgoingWindowUpdate</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>streamID</span><span class=p>:</span>  <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>increment</span><span class=p>:</span> <span class=nx>w</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=nx>bdpPing</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Select the right stream to dispatch.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>getStream</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>handleData</code>函数是grpc serve收到来自client的http2 data frame之后执行的函数，可以看到，grpc server和每个client之间都维护着一个bdpEstimator，每次收到一个data frame，grpc server都会判断是否需要进行采样，如果需要采样，就向client发送一个bdpPing frame，这个frame也是加入controlBuffer，异步处理的。</p><p>这里也将连接的流量控制和应用程序读取数据的行为解耦，也就是说，连接级别的窗口更新不应该依赖于应用是否读取了数据。stream-level流控已经有这个限制（必须等待应用读取后才能更新窗口），所以如果某个stream很慢，发送方已经被阻塞（因为窗口耗尽）。解耦可以避免下面的情况发生，当某些strema很慢（或者压根没有读取数据）时，导致其他活跃的stream由于没有connection-level流控窗口而被阻塞。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>pingHandler</span><span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>ping</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>p</span><span class=p>.</span><span class=nx>ack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nx>bdpEst</span><span class=p>.</span><span class=nf>timesnap</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>l</span><span class=p>.</span><span class=nx>framer</span><span class=p>.</span><span class=nx>fr</span><span class=p>.</span><span class=nf>WritePing</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>ack</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>bdpEstimator</span><span class=p>)</span> <span class=nf>timesnap</span><span class=p>(</span><span class=nx>d</span> <span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>bdpPing</span><span class=p>.</span><span class=nx>data</span> <span class=o>!=</span> <span class=nx>d</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nx>sentAt</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>前面提到bdp ping frame是通过control framer异步发送出去的，这个时间点可能和之前决定发送ping的时间点有一定的距离，为了更准确的计算RTT，所以在使用<code>http2.framer</code>实际发送数据前，重新更新了bdp ping frame的发送时间。</p><p>Client端在收到一个bdp ping frame之后，会立刻返回一个ack，server会捕捉到这个ack。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>handlePing</span><span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>PingFrame</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nf>IsAck</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>Data</span> <span class=o>==</span> <span class=nx>goAwayPing</span><span class=p>.</span><span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>t</span><span class=p>.</span><span class=nx>drainEvent</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nx>drainEvent</span><span class=p>.</span><span class=nf>Fire</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Maybe it&#39;s a BDP ping.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nx>bdpEst</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nx>bdpEst</span><span class=p>.</span><span class=nf>calculate</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>Data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></div></div><p><code>handlePing</code>是server在收到一个http2 ping frame之后调用的函数，可以看到当ping frame是一个ack时，会调用<code>calculate</code>这个函数。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>bdpEstimator</span><span class=p>)</span> <span class=nf>calculate</span><span class=p>(</span><span class=nx>d</span> <span class=p>[</span><span class=mi>8</span><span class=p>]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Check if the ping acked for was the bdp ping.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>bdpPing</span><span class=p>.</span><span class=nx>data</span> <span class=o>!=</span> <span class=nx>d</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 这次RTT时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rttSample</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>sentAt</span><span class=p>).</span><span class=nf>Seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 最终得到的RTT是rtt的统计平均，越近的RTT时间权重越高
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>b</span><span class=p>.</span><span class=nx>sampleCount</span> <span class=p>&lt;</span> <span class=mi>10</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Bootstrap rtt with an average of first 10 rtt samples.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>b</span><span class=p>.</span><span class=nx>rtt</span> <span class=o>+=</span> <span class=p>(</span><span class=nx>rttSample</span> <span class=o>-</span> <span class=nx>b</span><span class=p>.</span><span class=nx>rtt</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>sampleCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Heed to the recent past more.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>b</span><span class=p>.</span><span class=nx>rtt</span> <span class=o>+=</span> <span class=p>(</span><span class=nx>rttSample</span> <span class=o>-</span> <span class=nx>b</span><span class=p>.</span><span class=nx>rtt</span><span class=p>)</span> <span class=o>*</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>alpha</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nx>isSent</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 1.5感觉是接收到一个data frame耗时 0.5 rtt，然后dbp ping frame以及ack花费 1 rtt
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bwCurrent</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>sample</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>rtt</span> <span class=o>*</span> <span class=nb>float64</span><span class=p>(</span><span class=mf>1.5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>bwCurrent</span> <span class=p>&gt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>bwMax</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nx>bwMax</span> <span class=p>=</span> <span class=nx>bwCurrent</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>sample</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=nx>beta</span><span class=o>*</span><span class=nb>float64</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>bdp</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>bwCurrent</span> <span class=o>==</span> <span class=nx>b</span><span class=p>.</span><span class=nx>bwMax</span> <span class=o>&amp;&amp;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>bdp</span> <span class=o>!=</span> <span class=nx>bdpLimit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sampleFloat</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nx>bdp</span> <span class=p>=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>gamma</span> <span class=o>*</span> <span class=nx>sampleFloat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>b</span><span class=p>.</span><span class=nx>bdp</span> <span class=p>&gt;</span> <span class=nx>bdpLimit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>b</span><span class=p>.</span><span class=nx>bdp</span> <span class=p>=</span> <span class=nx>bdpLimit</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>bdp</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>bdp</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>.</span><span class=nf>updateFlowControl</span><span class=p>(</span><span class=nx>bdp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>在<code>calculate</code>中，经过一系列的计算得到了最新的<code>bdp</code>值，如果需要更新流量控制，会调用之前注册在<code>bdpEstimator</code>中的<code>updateFlowControl</code>函数，并将新的bdp值传递进去。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>updateFlowControl</span><span class=p>(</span><span class=nx>n</span> <span class=kt>uint32</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>t</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将所有活跃activeStreams的inflow limit增加到n
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>s</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>t</span><span class=p>.</span><span class=nx>activeStreams</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>fc</span><span class=p>.</span><span class=nf>newLimit</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果新创建stream，会使用initialWindowSize作为inflow的limit，所以这里也进行了修改
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span><span class=p>.</span><span class=nx>initialWindowSize</span> <span class=p>=</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>t</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 告诉client，增加整个连接的发送窗口trInflow, n - limit,最终会修改sendQuota
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>outgoingWindowUpdate</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>streamID</span><span class=p>:</span>  <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>increment</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>fc</span><span class=p>.</span><span class=nf>newLimit</span><span class=p>(</span><span class=nx>n</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 发送setting frame，增加所有strema的发送配额
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>outgoingSettings</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ss</span><span class=p>:</span> <span class=p>[]</span><span class=nx>http2</span><span class=p>.</span><span class=nx>Setting</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>ID</span><span class=p>:</span>  <span class=nx>http2</span><span class=p>.</span><span class=nx>SettingInitialWindowSize</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Val</span><span class=p>:</span> <span class=nx>n</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>applySettings</span><span class=p>(</span><span class=nx>ss</span> <span class=p>[]</span><span class=nx>http2</span><span class=p>.</span><span class=nx>Setting</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>s</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ss</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>s</span><span class=p>.</span><span class=nx>ID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>SettingInitialWindowSize</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 修改outbound initial window size
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>o</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>oiws</span>
</span></span><span class=line><span class=cl>			<span class=nx>l</span><span class=p>.</span><span class=nx>oiws</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Val</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>o</span> <span class=p>&lt;</span> <span class=nx>l</span><span class=p>.</span><span class=nx>oiws</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// If the new limit is greater make all depleted streams active.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>stream</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>l</span><span class=p>.</span><span class=nx>estdStreams</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>stream</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>waitingOnStreamQuota</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>stream</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>active</span>
</span></span><span class=line><span class=cl>						<span class=nx>l</span><span class=p>.</span><span class=nx>activeStreams</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>SettingHeaderTableSize</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nf>updateHeaderTblSize</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>hEnc</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>setting frame最终会被<code>applySetting</code>函数处理，修改outbound initial window size并且将所有等待stream quota的stream加入到activeStreams中。</p><p>对于server来说，bdp影响的是incoming traffic，也就是说影响的是client发送数据的速率和server接收数据的速率，而并不会影响server发送数据的速率。bdp采样结果会影响connection-level的窗口大小以及stream-level的窗口大小。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// newLimit updates the inflow window to a new value n.
</span></span></span><span class=line><span class=cl><span class=c1>// It assumes that n is always greater than the old limit.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>inFlow</span><span class=p>)</span> <span class=nf>newLimit</span><span class=p>(</span><span class=nx>n</span> <span class=kt>uint32</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>limit</span> <span class=p>=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h3 id=controlbuffer数据结构>controlBuffer数据结构</h3><p>先介绍一个重要的数据结果<code>controlBuffer</code>，这个在之前已经提到过了，在向外发送数据前，其实都会加入<code>controlBuffer</code>中，然后再进行处理。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>controlBuffer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// wakeupch的作用是在阻塞读取缓存中的内容时，当有新的frame加入itemList，可以解决阻塞并返回itemList中的frame
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>wakeupCh</span> <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>   <span class=c1>// Unblocks readers waiting for something to read.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>done</span>     <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span> <span class=c1>// Closed when the transport is done.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Mutex guards all the fields below, except trfChan which can be read
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// atomically without holding mu.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>mu</span>              <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 和wakeupCh配置使用，确保不向wakeupCh中放入多余的struct，保证阻塞读取缓存不会因为wakeupCh中的多余元素错误解除阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>consumerWaiting</span> <span class=kt>bool</span>      <span class=c1>// True when readers are blocked waiting for new data.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>closed</span>          <span class=kt>bool</span>      <span class=c1>// True when the controlbuf is finished.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>list</span>            <span class=o>*</span><span class=nx>itemList</span> <span class=c1>// List of queued control frames.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// 记录排队的响应帧数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>transportResponseFrames</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 当transportResponseFrames &gt;= maxQueuedTransportResponseFrames时，
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 创建trfChan，用于控制是否继续从client读取frame
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>trfChan</span>                 <span class=nx>atomic</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>[</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>controlBuffer</code>中的数据被称为control frame，一个control frame不止表示向外发送的data、message、headers，也被用来指示<code>loopyWriter</code>更新自身的内部状态。control frame和http2 frame没有直接关系，尽管有些control frame，比如说 dataFrame和headerFrame确实作为http2 frame向外传输。</p><p>controlBuffer维护了一个<code>itemList</code>（单向链表），本质上是一块缓存区，这块缓存区主要有两个作用：</p><ol><li>缓存需要发送的frame</li><li>根据缓存中<code>transportResponseFrame</code>的数量，决定是否暂时停止读取从client发来的frame</li></ol><p>下面看<code>controlBuffer</code>中的一些主要函数，加深理解</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newControlBuffer</span><span class=p>(</span><span class=nx>done</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=o>*</span><span class=nx>controlBuffer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>controlBuffer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>wakeupCh</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{},</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>list</span><span class=p>:</span>     <span class=o>&amp;</span><span class=nx>itemList</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>done</span><span class=p>:</span>     <span class=nx>done</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>newControlBuffer</code>用于创建controlBuffer实例，其中wakeupCh是缓冲区为1的channel。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>controlBuffer</span><span class=p>)</span> <span class=nf>throttle</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>ch</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>trfChan</span><span class=p>.</span><span class=nf>Load</span><span class=p>();</span> <span class=nx>ch</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=p>(</span><span class=o>*</span><span class=nx>ch</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>c</span><span class=p>.</span><span class=nx>done</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>throttle</code>函数会被阻塞，如果controlBuffer中存在太多的响应帧，比如incommingSettings、cleanupStrema等。在grpc server的代码中，<code>throttle</code>函数通常出现在grpc server接收client frame的开头，也就是说，当<code>transportResponseFrames</code>数量过多时，grpc server会暂停接受来自client的frame，maxQueuedTransportResponseFrames为50。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>controlBuffer</span><span class=p>)</span> <span class=nf>executeAndPut</span><span class=p>(</span><span class=nx>f</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>it</span> <span class=nx>cbItem</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>closed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>ErrConnClosing</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>f</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nf>f</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// f wasn&#39;t successful
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>it</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>wakeUp</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>consumerWaiting</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>wakeUp</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>consumerWaiting</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将item加入到buffer中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>c</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>it</span><span class=p>.</span><span class=nf>isTransportResponseFrame</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>transportResponseFrames</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>transportResponseFrames</span> <span class=o>==</span> <span class=nx>maxQueuedTransportResponseFrames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// We are adding the frame that puts us over the threshold; create
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// a throttling channel.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>trfChan</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>ch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>wakeUp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>c</span><span class=p>.</span><span class=nx>wakeupCh</span> <span class=o>&lt;-</span> <span class=kd>struct</span><span class=p>{}{}:</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>executeAndPut</code>运行f函数，如果f函数返回true，添加给定的item到controlBuf。如果<code>consumerWaiting</code>为true，也就是<code>loopyWriter</code>发现没有消息可供处理，所以阻塞获取control frame，这里会向<code>wakeupCh</code>中放入一个元素，来通知消费者可以读取frame了。在这里也会检查响应帧的数量，如果超过阈值，则创建<code>trfChan</code>。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>controlBuffer</span><span class=p>)</span> <span class=nf>get</span><span class=p>(</span><span class=nx>block</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>(</span><span class=nx>any</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// for循环
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>frame</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>getOnceLocked</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>frame</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=p>!</span><span class=nx>block</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>frame</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 设置状态为consumerWaiting
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>c</span><span class=p>.</span><span class=nx>consumerWaiting</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Release the lock above and wait to be woken up.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// control buffer中没有control frame，阻塞等待
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>c</span><span class=p>.</span><span class=nx>wakeupCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>c</span><span class=p>.</span><span class=nx>done</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;transport closed by client&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>controlBuffer</span><span class=p>)</span> <span class=nf>getOnceLocked</span><span class=p>()</span> <span class=p>(</span><span class=nx>any</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>closed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>ErrConnClosing</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nf>isEmpty</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>h</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>().(</span><span class=nx>cbItem</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将controlframe移除响应帧，可能会解封对client请求的读取
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>h</span><span class=p>.</span><span class=nf>isTransportResponseFrame</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>transportResponseFrames</span> <span class=o>==</span> <span class=nx>maxQueuedTransportResponseFrames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// We are removing the frame that put us over the
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// threshold; close and clear the throttling channel.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>ch</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>trfChan</span><span class=p>.</span><span class=nf>Swap</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nb>close</span><span class=p>(</span><span class=o>*</span><span class=nx>ch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>transportResponseFrames</span><span class=o>--</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>h</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>get</code>从control buffer中获取下一个control frame，如果block参数为true并且control buffer中没有control frame，调用被阻塞直到有control frame或者buffer被关闭。</p><h3 id=connection-level流量控制>connection level流量控制</h3><p>connection level流量控制会控制对于某个client某一时刻能够发送的数据总量。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>loopyWriter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl>	<span class=nx>sendQuota</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>控制的方式就是在<code>loopyWriter</code>中用一个<code>sendQuota</code>来标记该client目前可发送数据的配额。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>processData</span><span class=p>()</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span> <span class=o>-=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>sendQuota</code>会被初始化为65535，并且每当有数据被grpc server发送给client的时候，<code>sendQuota</code>都会减少和被发送数据相等的大小。</p><p>为了配合server端的流量控制，client端在连接初始化时被分配了一个limit，默认为65536字节，client端会记录收到的数据量的总和unacked，当unacked超过了limit的1/4后，client就会向server段发送一个window update（数值为unacked）,通知server可以将quota加回来，同时将unacked置零。</p><p>可以看到为了避免频繁的发送window update占用网络带宽，client并不会在每次接收到数据之后就发送window update，而是等待接收的数据量达到某一阈值后再发送。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// trInFlow 是 client 端决定是否发送 window update 给 server 的核心
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>trInFlow</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// server 端能够发送数据的上限, 会被 server 端根据采用控制的结果更新
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>limit</span>               <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=c1>// client 端已经接收到的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>unacked</span>             <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 用于 metric 记录, 不影响流量控制
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>effectiveWindowSize</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 参数 n 是 client 接收到的数据大小, 返回值表示需要向 server 发送的 window update 中的数值大小.
</span></span></span><span class=line><span class=cl><span class=c1>// 返回 0 代表不需要发送 window update
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>trInFlow</span><span class=p>)</span> <span class=nf>onData</span><span class=p>(</span><span class=nx>n</span> <span class=kt>uint32</span><span class=p>)</span> <span class=kt>uint32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>unacked</span> <span class=o>+=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 超过 1/4 * limit 才会发送 window update, 且数值为已经接收到的数据总量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>unacked</span> <span class=o>&gt;=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>limit</span><span class=o>/</span><span class=mi>4</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>unacked</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>unacked</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nf>updateEffectiveWindowSize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>w</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nf>updateEffectiveWindowSize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>trInFlow</code>是client端控制是否发送window update的核心，limit会随server端发来的window update而改变。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>outgoingWindowUpdate</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>streamID</span>  <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=nx>increment</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>最终向对端发送的是WindowUpdate Frame，其中streamID为0，表示作用于整个连接，increment表示quota的增量。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>handleWindowUpdate</span><span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>WindowUpdateFrame</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>t</span><span class=p>.</span><span class=nx>controlBuf</span><span class=p>.</span><span class=nf>put</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>incomingWindowUpdate</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>streamID</span><span class=p>:</span>  <span class=nx>f</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>StreamID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>increment</span><span class=p>:</span> <span class=nx>f</span><span class=p>.</span><span class=nx>Increment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>服务端收到WindowUpdateFrame后，会将消息包装成<code>incomingWindowUpdate</code>放入controlBuf中</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>incomingWindowUpdateHandler</span><span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>incomingWindowUpdate</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Otherwise update the quota.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>streamID</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span> <span class=o>+=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>increment</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>当grpc server收到来自client的http2 FrameWindowUpdate frame时，才会将这一quota增加，也就是说<code>sendQuota</code>会在server发出数据时减少，在收到来自client的FrameWindowUpdate frame时增加，connection level的流量控制是server和client相互交互的结果，由双方共同决定窗口大小。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>processData</span><span class=p>()</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>maxSize</span> <span class=p>&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// connection-level flow control.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>maxSize</span> <span class=p>=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>sendQuota</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></div></div><p>当<code>loopyWriter</code>打算向外发送数据时，如果<code>sendQuota</code>为零，就停止向外发送数据，如果打算向外发送的数据超过sendquota，则只发送sendQuota大小的数据。</p><h3 id=stream-level流量控制>stream level流量控制</h3><p>一个stream的流量控制有三种状态，分别是</p><ul><li>active: stream中有数据且数据可以被发送</li><li>empty: stream中没有数据</li><li>waitingOnStreamQuota: stream的quota不足，等待有quota时再发送数据</li></ul><p>一个stream一开始的状态为empty，因为一个stream在被创建出来时还没有待发送的数据。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>preprocessData</span><span class=p>(</span><span class=nx>df</span> <span class=o>*</span><span class=nx>dataFrame</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>str</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nx>estdStreams</span><span class=p>[</span><span class=nx>df</span><span class=p>.</span><span class=nx>streamID</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// If we got data for a stream it means that
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// stream was originated and the headers were sent out.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>str</span><span class=p>.</span><span class=nx>itl</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>str</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>empty</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>str</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>active</span>
</span></span><span class=line><span class=cl>		<span class=nx>l</span><span class=p>.</span><span class=nx>activeStreams</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>当server处理controlBuffer时遇到某个stream的frame时，会将该stream转成active状态，active状态的stream可以发送数据。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>loopyWriter</span><span class=p>)</span> <span class=nf>processData</span><span class=p>()</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>strQuota</span> <span class=o>:=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>l</span><span class=p>.</span><span class=nx>oiws</span><span class=p>)</span> <span class=o>-</span> <span class=nx>str</span><span class=p>.</span><span class=nx>bytesOutStanding</span><span class=p>;</span> <span class=nx>strQuota</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// stream-level flow control.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>str</span><span class=p>.</span><span class=nx>state</span> <span class=p>=</span> <span class=nx>waitingOnStreamQuota</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl>	<span class=nx>str</span><span class=p>.</span><span class=nx>bytesOutStanding</span> <span class=o>+=</span> <span class=nx>size</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>发送数据之后，<code>byteOutStanding</code>会增加相应的数据大小，表明该stream有这些数据被发送给client，还没有收到回应。而当<code>byteOutStanding</code>的大小超过<code>loopyWriter.oiws</code>，也就是65535后，会拒绝为该stream继续发送数据，这种策略避免了不断向一个失去回应的client发送数据，避免浪费网络带宽。</p><p>stream level的流量控制和connenction level的流量控制原理基本上一直，主要的区别有两点：</p><ul><li>stream level的流量控制中的quota只针对单个stream，每个stream既受限于stream level流量控制，又受限于conection level流量控制</li><li>client端决定反馈给server windowUpdate frame的时机更负责一些</li></ul><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 入站流量控制（inbound flow control
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>inFlow</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>	<span class=c1>// stream能接受的数据上限，初始为65535字节，受到采样流量控制的影响
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>limit</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 收到但未被应用消费（未被读取）的数据量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pendingData</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 应用已经消费但还未发送windowUpdate frame的数据量，用于减低windowUpdate frame的发送频率
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pendingUpdate</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 是在limit基础上额外增加的数据量，当应用试着读取超过limit大小的数据是，会临时在limit上增加delta，来允许应用读取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>delta</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>steam level的流量控制不光要记录已经收到的数据量，还需要记录被stream消费掉的数据量，以达到更精准的流量控制，对应的数据结构为<code>inFlow</code>。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 当data frame被接收时，调用onData更新pendingData
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>inFlow</span><span class=p>)</span> <span class=nf>onData</span><span class=p>(</span><span class=nx>n</span> <span class=kt>uint32</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>pendingData</span> <span class=o>+=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>pendingData</span><span class=o>+</span><span class=nx>f</span><span class=p>.</span><span class=nx>pendingUpdate</span> <span class=p>&gt;</span> <span class=nx>f</span><span class=p>.</span><span class=nx>limit</span><span class=o>+</span><span class=nx>f</span><span class=p>.</span><span class=nx>delta</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>limit</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>limit</span>
</span></span><span class=line><span class=cl>		<span class=nx>rcvd</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>pendingData</span> <span class=o>+</span> <span class=nx>f</span><span class=p>.</span><span class=nx>pendingUpdate</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;received %d-bytes data exceeding the limit %d bytes&#34;</span><span class=p>,</span> <span class=nx>rcvd</span><span class=p>,</span> <span class=nx>limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>当client接收到来自server的data frame的时候，pendingData增加接收到的数据量。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 当应用读取数据时调用onRead，返回增加的窗口大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>inFlow</span><span class=p>)</span> <span class=nf>onRead</span><span class=p>(</span><span class=nx>n</span> <span class=kt>uint32</span><span class=p>)</span> <span class=kt>uint32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>pendingData</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>pendingData</span> <span class=o>-=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>n</span> <span class=p>&gt;</span> <span class=nx>f</span><span class=p>.</span><span class=nx>delta</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>n</span> <span class=o>-=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>delta</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>delta</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>delta</span> <span class=o>-=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>		<span class=nx>n</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>pendingUpdate</span> <span class=o>+=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>pendingUpdate</span> <span class=o>&gt;=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>limit</span><span class=o>/</span><span class=mi>4</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>wu</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>pendingUpdate</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>pendingUpdate</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>wu</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>当应用读取n字节数据时，pendingData减去n，pendingUpdate增加n，如果存在delta，则需要先还清之前delta的欠债，然后才能将余额增加到pengingUpdate，如果pendignUpdate超过1/4 limit，返回pendingUpdate作为增加的窗口大小，对端可以继续在stream上发送数据，这一切都是为了渐渐消除之前为了允许server发送大量数据而临时增加的额度。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>inFlow</span><span class=p>)</span> <span class=nf>maybeAdjust</span><span class=p>(</span><span class=nx>n</span> <span class=kt>uint32</span><span class=p>)</span> <span class=kt>uint32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>n</span> <span class=p>&gt;</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nx>MaxInt32</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>n</span> <span class=p>=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nx>MaxInt32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 接收者的视角下发送者可以继续发送的最大字节数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>estSenderQuota</span> <span class=o>:=</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>limit</span> <span class=o>-</span> <span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>pendingData</span> <span class=o>+</span> <span class=nx>f</span><span class=p>.</span><span class=nx>pendingUpdate</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 假设要读取n字节长度的grpc message，estUntransmittedData表示发送者可能还没有发送的最大字节数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>estUntransmittedData</span> <span class=o>:=</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>n</span> <span class=o>-</span> <span class=nx>f</span><span class=p>.</span><span class=nx>pendingData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 这意味着除非我们发送一个window update frame，否则发送者可能无法发送message的所有字节
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 由于有来自应用的活跃读请求，因此我们需要发送window update frame，允许超过原先的limit
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>estUntransmittedData</span> <span class=p>&gt;</span> <span class=nx>estSenderQuota</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>limit</span><span class=o>+</span><span class=nx>n</span> <span class=p>&gt;</span> <span class=nx>maxWindowSize</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>f</span><span class=p>.</span><span class=nx>delta</span> <span class=p>=</span> <span class=nx>maxWindowSize</span> <span class=o>-</span> <span class=nx>f</span><span class=p>.</span><span class=nx>limit</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 这里更新窗口到可以接受message，主要考虑到message可能存在padding
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>f</span><span class=p>.</span><span class=nx>delta</span> <span class=p>=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=nx>delta</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>maybeAdjust</code>的核心逻辑是保证grpc message一定有足够的窗口能够被发送，避免陷入停滞，如果由于message需要临时增加窗口大小，则增加delta，而不是limit。最终向对端发送window update frame，提示对端可以继续发送数据。</p><h3 id=grpc流量控制小结>grpc流量控制小结</h3><p>流量控制，一般是指在网络传输过程中，发送者主动限制自身发送数据的速率或者发送的数据量，以适应接收者处理数据的速度，当接收者的处理速度较慢是，来不及处理的数据会被存放在内存中，而当内存中的数据缓存区被填满后，新收到的数据就会被扔掉，导致发送者不得不重新发送，造成网络带宽的浪费。</p><p>流量控制是一个网络组件的基本功能，我们熟知的TCP协议就规定了流量控制算法，grpc建立在TCP之上，也依赖于http2 WindowUupdate Frame实现了自己在应用层的流量控制。</p><p>在grpc中，流量控制体现在三个维度：</p><ol><li>采样流量控制：grpc接收者检测一段时间内收到的数据量，从而推测出bdp，并指导发送者调整流量控制窗口</li><li>connection level流量控制：发送者在初始化时被分配一定的quota，quota随数据发送而降低，并在收到接收者的反馈之后增加，发送者在耗尽quota之后不能再发送数据</li><li>stream level流量控制：和connection level的流量控制类似，只不过connection level管理的是一个连接的所有流量，而stream level管理的是connection中诸多stream中的一个。</li></ol><p>grpc中的流量控制仅针对HTTP2 data frame。</p><h2 id=grpc-timeout实现>grpc timeout实现</h2><p><a href=https://grpc.io/docs/guides/deadlines/ target=_blank rel="noopener noreffer">Deadline</a>对于一个网络服务来说很重要，client可以指定一个deadline，从而当时间超过后，可以及时放弃请求，返回<code>DEADLINE_EXCEEDED</code>。可以解决类似于</p><ul><li>尾部延迟，某些请求相比于其他请求花费太多时间才返回</li><li>避免客户端无意义阻塞等待，比如服务器已经挂掉了，等待已经没有意义了</li><li>避免资源的不合理占用，rpc请求可能会持有一些资源，通过及时中断，可以释放这些资源</li></ul><p>怎么得到一个合理的<a href=https://grpc.io/blog/deadlines/ target=_blank rel="noopener noreffer">deadlines</a>，需要考虑多方面因素，包括整个系统的端到端延迟，哪些RPC是串行的，哪些是并行的，然后尝试估算每一阶段的耗时，最终得到一个粗略的估计。</p><p>在grpc中，client和server会分别独立和局地的判断rpc调用是否成功，这意味着client和server得到的结论可能不一致，一个在server端成功的rpc调用可能在client端被认为是失败的，比如服务器可以发送响应，但响应达到是client的超时已经触发，client最终会终止当前rpc调用调用并返回<code>DEADLINE_EXCEEDED</code>。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>clientDeadline</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=o>*</span><span class=nx>deadlineMs</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithDeadline</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>clientDeadline</span><span class=p>)</span></span></span></code></pre></div></div><p>在go中通过对<code>ctx</code>指定超时时间来设置grpc超时。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>blockingStub</span><span class=p>.</span><span class=na>withDeadlineAfter</span><span class=p>(</span><span class=n>deadlineMs</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>).</span><span class=na>sayHello</span><span class=p>(</span><span class=n>request</span><span class=p>);</span></span></span></code></pre></div></div><p>在java中通过调用client stub的方法<code>withDeadLineAfter</code>来设置超时时间。</p><p>在服务端，server可以查询某个rpc是否已经超时，在server可以处理rpc请求时，检查是否client还在等待非常重要，特别是在做一些很费时间的处理时。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span> <span class=o>==</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Canceled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>status</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>Canceled</span><span class=p>,</span> <span class=s>&#34;Client cancelled, abandoning.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>current</span><span class=p>().</span><span class=na>isCancelled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>responseObserver</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=n>Status</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>.</span><span class=na>withDescription</span><span class=p>(</span><span class=s>&#34;Cancelled by client&#34;</span><span class=p>).</span><span class=na>asRuntimeException</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><p><a href=https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md target=_blank rel="noopener noreffer">grpc over http2</a>规定了deadline是通过在请求的Headers frame中指定<code>grpc-timeout</code>字段实现的，其值的格式包含两部分：</p><ol><li>TimeoutValue ascii形式的正整数字符串，最多8位</li><li>TimeoutUnit 可以为Hour -> H / Minute -> M / Second -> S / Millisecond -> m / Microsecond -> u / Nanosecond -> n</li></ol><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>http2Server</span><span class=p>)</span> <span class=nf>operateHeaders</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>frame</span> <span class=o>*</span><span class=nx>http2</span><span class=p>.</span><span class=nx>MetaHeadersFrame</span><span class=p>,</span> <span class=nx>handle</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>ServerStream</span><span class=p>))</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>streamID</span> <span class=o>:=</span> <span class=nx>frame</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>StreamID</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ServerStream</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Stream</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>Stream</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>id</span><span class=p>:</span>  <span class=nx>streamID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>buf</span><span class=p>:</span> <span class=nx>buf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>fc</span><span class=p>:</span>  <span class=o>&amp;</span><span class=nx>inFlow</span><span class=p>{</span><span class=nx>limit</span><span class=p>:</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>initialWindowSize</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>st</span><span class=p>:</span>               <span class=nx>t</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>headerWireLength</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=nx>frame</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nx>Length</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 找到grpc-timeout字段
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>hf</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>frame</span><span class=p>.</span><span class=nx>Fields</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=s>&#34;grpc-timeout&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>timeoutSet</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>timeout</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>decodeTimeout</span><span class=p>(</span><span class=nx>hf</span><span class=p>.</span><span class=nx>Value</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>headerError</span> <span class=p>=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Newf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>Internal</span><span class=p>,</span> <span class=s>&#34;malformed grpc-timeout: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 为stream设置deadline
</span></span></span><span class=line><span class=cl><span class=c1></span> 	<span class=k>if</span> <span class=nx>timeoutSet</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>cancel</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>cancel</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 启动一个timer在超时的情况下关闭stream
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>timeoutSet</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// We need to wait for s.cancel to be updated before calling
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// t.closeStream to avoid data races.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>cancelUpdated</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>		<span class=nx>timer</span> <span class=o>:=</span> <span class=nx>internal</span><span class=p>.</span><span class=nf>TimeAfterFunc</span><span class=p>(</span><span class=nx>timeout</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>&lt;-</span><span class=nx>cancelUpdated</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 最终会发送http2 RST frame关闭stream
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>t</span><span class=p>.</span><span class=nf>closeStream</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>http2</span><span class=p>.</span><span class=nx>ErrCodeCancel</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=nx>oldCancel</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>cancel</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>cancel</span> <span class=p>=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>oldCancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>timer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>cancelUpdated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></div></div><p>server端获得headers frame后，在<code>operateHeaders</code>中进行处理。</p><h3 id=grpc-deadline在java中的实现>grpc deadline在java中的实现</h3><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>getUnchecked</span><span class=p>(</span><span class=n>Future</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>future</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>future</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 恢复中断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 抛出StatusRuntimeException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>CANCELLED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>withDescription</span><span class=p>(</span><span class=s>&#34;Thread interrupted&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>withCause</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>asRuntimeException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=n>toStatusRuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getCause</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><p>返回<code>future.get()</code>的结果，而且是可中断的，适用于不会抛出受检异常的任务，如果发生中断，线程在抛出异常前会先恢复中断。</p><ul><li>如果get抛出<code>CancellationException</code>，原样抛出异常</li><li>如果get抛出<code>ExecutionException</code>或者<code>InterruptedException</code>，则抛出<code>StatusRuntimeException</code></li></ul><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>StatusRuntimeException</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>RuntimeException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1950934672280720624L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Status</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Metadata</span><span class=w> </span><span class=n>trailers</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>StatusRuntimeException</span><span class=p>(</span><span class=n>Status</span><span class=w> </span><span class=n>status</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>(</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Metadata</span><span class=p>)</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>StatusRuntimeException</span><span class=p>(</span><span class=n>Status</span><span class=w> </span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Metadata</span><span class=w> </span><span class=n>trailers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>Status</span><span class=p>.</span><span class=na>formatThrowableMessage</span><span class=p>(</span><span class=n>status</span><span class=p>),</span><span class=w> </span><span class=n>status</span><span class=p>.</span><span class=na>getCause</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>trailers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>trailers</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Status</span><span class=w> </span><span class=nf>getStatus</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Metadata</span><span class=w> </span><span class=nf>getTrailers</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>trailers</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><p><code>StatusRuntimeExceptioni</code>是<code>Status</code>的RuntimeException形式，为了能够通过异常传播Status。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Status</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Code</span><span class=w> </span><span class=n>code</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>description</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>cause</span><span class=p>;</span></span></span></code></pre></div></div><p>Status定义了操作的状态通过提供标准的<code>Code</code>和可选的描述。对于客户端，每个远程调用调用都会在完成时返回一个status，如果发生错误status会被传播到blocking stub作为StatusRuntimeExcpetion，或者作为listener的显式参数，类似的，服务端可以抛出StatusRuntimeException或者将status传递给callback函数。</p><p>Code是一个enum类型，这里列出一些值得更多关注的code：</p><ul><li>OK 操作成功结束</li><li>CALCELLED 操作被取消，一般是被调用者取消</li><li>UNKNOWN 未知错误</li><li>INVALID_ARGUMENT 客户单提供了无效的参数</li><li>DEADLINE_EXCEEDED 在操作完成前超时</li><li>UNIMPLEMENTED 服务中的的操作未实现</li><li>INTERNAL 内部错误，表示底层系统所期望的一些不变量遭到了破坏</li><li>UNAVAILABLE 服务当前不可用，可能是瞬时错误，可以通过backoff重试纠正，然后对于非幂等操作重试不一定安全</li></ul><h4 id=listenablefuture>ListenableFuture</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>ListenableFuture</span><span class=o>&lt;</span><span class=n>V</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>addListener</span><span class=p>(</span><span class=n>Runnable</span><span class=w> </span><span class=n>listener</span><span class=p>,</span><span class=w> </span><span class=n>Executor</span><span class=w> </span><span class=n>executor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><p>google在<a href=https://github.com/google/guava/wiki/ListenableFutureExplained target=_blank rel="noopener noreffer">ListenableFutureExplained</a>文章中推荐总是使用<code>ListenableFuture</code>而不是<code>Future</code>，并给出了以下原因：</p><ul><li>大多数<code>Futures</code>方法需要<code>ListenableFutures</code></li><li>省去后续更改为<code>ListenableFuture</code>的麻烦</li><li>提供工具方法时不再需要提供<code>Future</code>和<code>ListenableFuture</code>两种变体</li></ul><p>传统的<code>Future</code>表示异步计算的结果，一个计算可能也可能还没有产生结果，<code>Future</code>可以作为正在进行中的计算的句柄，服务承诺未来提供结果给我们。</p><p><code>ListenableFuture</code>允许注册回调函数，一旦计算完成，这些回调函数将被执行，或者如果注册回调函数时计算已经开始，则立即开始执行。</p><p><code>addListenr</code>方法表示当<code>future</code>完成时，注册的回调函数将在提供的线程池中被执行。</p><p>推荐通过<code>Futures.addCallback(ListenableFuture&lt;V>, FutureCallback&lt;V>, Executor)</code>添加回调函数，<code>FutureCallback&lt;V></code>实现了两个方法</p><ul><li><code>onSuccess(V)</code> 当future成功后基于执行结果执行行动</li><li><code>onFailure(Throwable)</code> 在future失败时基于失败原因执行行动</li></ul><p>对应于JDK通过<code>ExecutorService.submit(Callable)</code>初始化一个异步计算，guava提供了<code>ListerningExecutorService</code>接口，在任何<code>ExecutorService</code>返回<code>Future</code>的地方都改成返回<code>ListenableFuture</code>。可以通过使用<code>MoreExecutors.listerningDecorator(ExecutorSerivce)</code>将<code>ExecutorService</code>转换成<code>ListerningExecutorService</code>。</p><p>如果你打算转换<code>FutureTask</code>，guava提供了<code>ListenableFutureTask.create(Callable&lt;V>)</code>和<code>ListenableFutureTask.create(Runnable, V)</code>，不同于jdk，<code>ListenableFutureTask</code>不希望被直接继承。</p><p>如果你需要的future抽象希望直接设置future的值而不是实现一个方法去计算这个值，可以考虑拓展<code>AbstractFuture&lt;V></code>或者直接使用<code>SettableFuture</code>。</p><p>如果你必须将其他API提供的future转换成ListenableFuture，那么你可能别无选择，只能使用较为重量级的<code>JdkFutureAdapters.listenInPoolThread(Future)</code> 方法来完成转换。但在可能的情况下，建议你修改原始代码，使其直接返回 ListenableFuture。</p><p>推荐使用<code>ListenableFuture</code>的最重要原因为它使得构建复杂的异步操作链变得可行，类似于JDK中提供了<code>CompletableFuture</code>。</p><h4 id=grpcfuture>GrpcFuture</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>GrpcFuture</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractFuture</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ClientCall</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>call</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Non private to avoid synthetic class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>GrpcFuture</span><span class=p>(</span><span class=n>ClientCall</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>call</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>call</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>call</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>interruptTask</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>call</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=s>&#34;GrpcFuture was cancelled&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RespT</span><span class=w> </span><span class=n>resp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>resp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>setException</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>throwable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>setException</span><span class=p>(</span><span class=n>throwable</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;MissingOverride&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// Add @Override once Java 6 support is dropped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>pendingToString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>MoreObjects</span><span class=p>.</span><span class=na>toStringHelper</span><span class=p>(</span><span class=k>this</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;clientCall&#34;</span><span class=p>,</span><span class=w> </span><span class=n>call</span><span class=p>).</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span></span></span></code></pre></div></div><p><code>GrpcFuture</code>继承了<code>AbstractFuture</code>，可以通过<code>interruptTask</code>取消grpc调用，通过<code>set</code>或者<code>setException</code>方法直接设置future的结果。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>UnaryStreamToFuture</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>StartableListener</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>GrpcFuture</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>responseFuture</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>RespT</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isValueReceived</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// Non private to avoid synthetic class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>UnaryStreamToFuture</span><span class=p>(</span><span class=n>GrpcFuture</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>responseFuture</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>responseFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>responseFuture</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onHeaders</span><span class=p>(</span><span class=n>Metadata</span><span class=w> </span><span class=n>headers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// 当收到server返回的信息后，保存相关信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessage</span><span class=p>(</span><span class=n>RespT</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>isValueReceived</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>INTERNAL</span><span class=p>.</span><span class=na>withDescription</span><span class=p>(</span><span class=s>&#34;More than one value received for unary call&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>.</span><span class=na>asRuntimeException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>isValueReceived</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// clientcall关闭时设置future的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onClose</span><span class=p>(</span><span class=n>Status</span><span class=w> </span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>Metadata</span><span class=w> </span><span class=n>trailers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>isOk</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isValueReceived</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// No value received so mark the future as an error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>responseFuture</span><span class=p>.</span><span class=na>setException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Status</span><span class=p>.</span><span class=na>INTERNAL</span><span class=p>.</span><span class=na>withDescription</span><span class=p>(</span><span class=s>&#34;No value received for unary call&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>asRuntimeException</span><span class=p>(</span><span class=n>trailers</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>responseFuture</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>responseFuture</span><span class=p>.</span><span class=na>setException</span><span class=p>(</span><span class=n>status</span><span class=p>.</span><span class=na>asRuntimeException</span><span class=p>(</span><span class=n>trailers</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// clientcall start后调用onstart</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>onStart</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>responseFuture</span><span class=p>.</span><span class=na>call</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>ReqT</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>RespT</span><span class=w> </span><span class=nf>blockingUnaryCall</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>MethodDescriptor</span><span class=o>&lt;</span><span class=n>ReqT</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>CallOptions</span><span class=w> </span><span class=n>callOptions</span><span class=p>,</span><span class=w> </span><span class=n>ReqT</span><span class=w> </span><span class=n>req</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ThreadlessExecutor</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ThreadlessExecutor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>interrupt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>ClientCall</span><span class=o>&lt;</span><span class=n>ReqT</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>call</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>newCall</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>callOptions</span><span class=p>.</span><span class=na>withOption</span><span class=p>(</span><span class=n>ClientCalls</span><span class=p>.</span><span class=na>STUB_TYPE_OPTION</span><span class=p>,</span><span class=w> </span><span class=n>StubType</span><span class=p>.</span><span class=na>BLOCKING</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>.</span><span class=na>withExecutor</span><span class=p>(</span><span class=n>executor</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ListenableFuture</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>responseFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>futureUnaryCall</span><span class=p>(</span><span class=n>call</span><span class=p>,</span><span class=w> </span><span class=n>req</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>responseFuture</span><span class=p>.</span><span class=na>isDone</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>executor</span><span class=p>.</span><span class=na>waitAndDrain</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interrupt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>call</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=s>&#34;Thread interrupted&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Now wait for onClose() to be called, so interceptors can clean up</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>executor</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>getUnchecked</span><span class=p>(</span><span class=n>responseFuture</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Something very bad happened. All bets are off; it may be dangerous to wait for onClose().</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=n>cancelThrow</span><span class=p>(</span><span class=n>call</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>interrupt</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><p><code>blockingUnaryCall</code>执行unary call并且阻塞等待结果，<code>call</code>不应该已经启动，在调用完这个函数后<code>call</code>不应该再被使用。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>ReqT</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>ListenableFuture</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=nf>futureUnaryCall</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClientCall</span><span class=o>&lt;</span><span class=n>ReqT</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>call</span><span class=p>,</span><span class=w> </span><span class=n>ReqT</span><span class=w> </span><span class=n>req</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>GrpcFuture</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>responseFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GrpcFuture</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>call</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>asyncUnaryRequestCall</span><span class=p>(</span><span class=n>call</span><span class=p>,</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnaryStreamToFuture</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>responseFuture</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>responseFuture</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><p><code>futureUnaryCall</code>负责执行unary call并返回响应的<code>ListenableFuture</code>。</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>ReqT</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>asyncUnaryRequestCall</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClientCall</span><span class=o>&lt;</span><span class=n>ReqT</span><span class=p>,</span><span class=w> </span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>call</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ReqT</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>StartableListener</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>responseListener</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>startCall</span><span class=p>(</span><span class=n>call</span><span class=p>,</span><span class=w> </span><span class=n>responseListener</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>call</span><span class=p>.</span><span class=na>sendMessage</span><span class=p>(</span><span class=n>req</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>call</span><span class=p>.</span><span class=na>halfClose</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=n>cancelThrow</span><span class=p>(</span><span class=n>call</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><p><code>ClientCall</code>是grpc中的一个核心类，表示客户端和服务器之间的一次rpc调用，<code>DelayedClientCall</code>在真实调用未准备好之前先将请求排队起来，等真正的调用准备好之后一并转发。<code>asyncUnaryRequestCall</code>中实际调用均没有发生，而是加入了队列等待执行。</p><p>在<code>ClientCallImpl#start</code>方法中，客户端构造headers frame，</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startInternal</span><span class=p>(</span><span class=n>Listener</span><span class=o>&lt;</span><span class=n>RespT</span><span class=o>&gt;</span><span class=w> </span><span class=n>observer</span><span class=p>,</span><span class=w> </span><span class=n>Metadata</span><span class=w> </span><span class=n>headers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 判断context deadline和callOptions deadline哪个更早生效</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 我们每次调用时通过stub设置超时时间对应 callOptions deadline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Deadline</span><span class=w> </span><span class=n>effectiveDeadline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>effectiveDeadline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>contextIsDeadlineSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>effectiveDeadline</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>effectiveDeadline</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getDeadline</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cancellationHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CancellationHandler</span><span class=p>(</span><span class=n>effectiveDeadline</span><span class=p>,</span><span class=w> </span><span class=n>contextIsDeadlineSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>deadlineExceeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>effectiveDeadline</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>cancellationHandler</span><span class=p>.</span><span class=na>remainingNanos</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果在实际发送请求前已经超时，就不用返回实际发送请求，直接返回</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这个一般是由于复用了之前请求的超时时间导致的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>deadlineExceeded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>clientStreamProvider</span><span class=p>.</span><span class=na>newStream</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>callOptions</span><span class=p>,</span><span class=w> </span><span class=n>headers</span><span class=p>,</span><span class=w> </span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>ClientStreamTracer</span><span class=o>[]</span><span class=w> </span><span class=n>tracers</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>GrpcUtil</span><span class=p>.</span><span class=na>getClientStreamTracers</span><span class=p>(</span><span class=n>callOptions</span><span class=p>,</span><span class=w> </span><span class=n>headers</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>deadlineName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>contextIsDeadlineSource</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34;Context&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;CallOptions&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Long</span><span class=w> </span><span class=n>nameResolutionDelay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callOptions</span><span class=p>.</span><span class=na>getOption</span><span class=p>(</span><span class=n>NAME_RESOLUTION_DELAYED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>String</span><span class=w> </span><span class=n>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=s>&#34;ClientCall started after %s deadline was exceeded %.9f seconds ago. &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=o>+</span><span class=w> </span><span class=s>&#34;Name resolution delay %.9f seconds.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>deadlineName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>cancellationHandler</span><span class=p>.</span><span class=na>remainingNanos</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>NANO_TO_SECS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>nameResolutionDelay</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>nameResolutionDelay</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>NANO_TO_SECS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FailingClientStream</span><span class=p>(</span><span class=n>DEADLINE_EXCEEDED</span><span class=p>.</span><span class=na>withDescription</span><span class=p>(</span><span class=n>description</span><span class=p>),</span><span class=w> </span><span class=n>tracers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>effectiveDeadline</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stream</span><span class=p>.</span><span class=na>setDeadline</span><span class=p>(</span><span class=n>effectiveDeadline</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stream</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ClientStreamListenerImpl</span><span class=p>(</span><span class=n>observer</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Delay any sources of cancellation after start(), because most of the transports are broken if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// they receive cancel before start. Issue #1343 has more details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Propagate later Context cancellation to the remote side.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// context cancel后调用stream.cancel通知server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cancellationHandler</span><span class=p>.</span><span class=na>setUp</span><span class=p>();</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>setUp</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tearDownCalled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasDeadline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c1>// If the context has the effective deadline, we don&#39;t need to schedule an extra task.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>contextIsDeadlineSource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c1>// If the channel has been terminated, we don&#39;t need to schedule an extra task.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>deadlineCancellationExecutor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 添加超时取消rpc任务到线程池</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>deadlineCancellationFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>deadlineCancellationExecutor</span><span class=p>.</span><span class=na>schedule</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>LogExceptionRunnable</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>remainingNanos</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>NANOSECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>context</span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>directExecutor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tearDownCalled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Race detected! Re-run to make sure the future is cancelled and context listener removed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tearDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>RealChannel</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Channel</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Reference to null if no config selector is available from resolution result</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Reference must be set() from syncContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>InternalConfigSelector</span><span class=o>&gt;</span><span class=w> </span><span class=n>configSelector</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>AtomicReference</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>INITIAL_PENDING_SELECTOR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Set when the NameResolver is initially created. When we create a new NameResolver for the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// same target, the new instance must have the same value.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>authority</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Channel</span><span class=w> </span><span class=n>clientCallImplChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Channel</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>RequestT</span><span class=p>,</span><span class=w> </span><span class=n>ResponseT</span><span class=o>&gt;</span><span class=w> </span><span class=n>ClientCall</span><span class=o>&lt;</span><span class=n>RequestT</span><span class=p>,</span><span class=w> </span><span class=n>ResponseT</span><span class=o>&gt;</span><span class=w> </span><span class=nf>newCall</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>MethodDescriptor</span><span class=o>&lt;</span><span class=n>RequestT</span><span class=p>,</span><span class=w> </span><span class=n>ResponseT</span><span class=o>&gt;</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>CallOptions</span><span class=w> </span><span class=n>callOptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ClientCallImpl</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>method</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// 使用 callOptions executor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>getCallExecutor</span><span class=p>(</span><span class=n>callOptions</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>callOptions</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// tansportProvider由外部提供</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transportProvider</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          	</span><span class=c1>// grpc底层传输层提供的调度任务的线程池，用于deadline超时取消任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>terminated</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>transportFactory</span><span class=p>.</span><span class=na>getScheduledExecutorService</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>channelCallTracer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setFullStreamDecompression</span><span class=p>(</span><span class=n>fullStreamDecompression</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setDecompressorRegistry</span><span class=p>(</span><span class=n>decompressorRegistry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setCompressorRegistry</span><span class=p>(</span><span class=n>compressorRegistry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>authority</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>authority</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span></span></span></code></pre></div></div><p>blockingUnaryCall -> channel.newCall -> RealChannel#newCall</p><p>·grpc-nio-woarker-elg-1-3` 构造deadline消息，CancellationHandler</p><p>![ChatGPT Image 2025年5月7日 21_48_33](ChatGPT Image 2025年5月7日 21_48_33.png)</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ClientCallImpl的子类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>CancellationHandler</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=p>,</span><span class=w> </span><span class=n>CancellationListener</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>contextIsDeadlineSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>hasDeadline</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>remainingNanos</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>deadlineCancellationFuture</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>tearDownCalled</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>CancellationHandler</span><span class=p>(</span><span class=n>Deadline</span><span class=w> </span><span class=n>deadline</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>contextIsDeadlineSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>contextIsDeadlineSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>contextIsDeadlineSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>deadline</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>hasDeadline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>remainingNanos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>hasDeadline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>remainingNanos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>deadline</span><span class=p>.</span><span class=na>timeRemaining</span><span class=p>(</span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>NANOSECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>setUp</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tearDownCalled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasDeadline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the context has the effective deadline, we don&#39;t need to schedule an extra task.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>contextIsDeadlineSource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// If the channel has been terminated, we don&#39;t need to schedule an extra task.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>deadlineCancellationExecutor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>deadlineCancellationFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>deadlineCancellationExecutor</span><span class=p>.</span><span class=na>schedule</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>new</span><span class=w> </span><span class=n>LogExceptionRunnable</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>remainingNanos</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>NANOSECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>context</span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>directExecutor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tearDownCalled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// Race detected! Re-run to make sure the future is cancelled and context listener removed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>tearDown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c1>// May be called multiple times, and race with setUp()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>tearDown</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tearDownCalled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>deadlineCancellationFuture</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>deadlineCancellationFuture</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>deadlineCancellationFuture</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>deadlineCancellationFuture</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>context</span><span class=p>.</span><span class=na>removeListener</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancelled</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasDeadline</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>contextIsDeadlineSource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>cancellationCause</span><span class=p>()</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>TimeoutException</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stream</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=n>formatDeadlineExceededStatus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stream</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=n>statusFromCancelled</span><span class=p>(</span><span class=n>context</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 超时时调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stream</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=n>formatDeadlineExceededStatus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Status</span><span class=w> </span><span class=nf>formatDeadlineExceededStatus</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// DelayedStream.cancel() is safe to call from a thread that is different from where the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// stream is created.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>seconds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>abs</span><span class=p>(</span><span class=n>remainingNanos</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>nanos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>abs</span><span class=p>(</span><span class=n>remainingNanos</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>.</span><span class=na>toNanos</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>contextIsDeadlineSource</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34;Context&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;CallOptions&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34; deadline exceeded after &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>remainingNanos</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=sc>&#39;-&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>seconds</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>Locale</span><span class=p>.</span><span class=na>US</span><span class=p>,</span><span class=w> </span><span class=s>&#34;.%09d&#34;</span><span class=p>,</span><span class=w> </span><span class=n>nanos</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;s. &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=n>nsDelay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callOptions</span><span class=p>.</span><span class=na>getOption</span><span class=p>(</span><span class=n>NAME_RESOLUTION_DELAYED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>Locale</span><span class=p>.</span><span class=na>US</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Name resolution delay %.9f seconds.&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>nsDelay</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>nsDelay</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>NANO_TO_SECS</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stream</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>InsightBuilder</span><span class=w> </span><span class=n>insight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InsightBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>stream</span><span class=p>.</span><span class=na>appendTimeoutInsight</span><span class=p>(</span><span class=n>insight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>buf</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>insight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>DEADLINE_EXCEEDED</span><span class=p>.</span><span class=na>withDescription</span><span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-java"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java></code></pre></div></div><h2 id=grpc-keepalive实现>grpc keepalive实现</h2><p>[grpc Keepalive是一种在http2连接空闲（没有数据传输）是保持连接活动状态的技术，通过定期发送ping帧来实现。http2保活机制能够提升http2连接的性能和可靠性，但需要仔细配置保活间隔时间。</p><h2 id=参考文献>参考文献</h2><ol><li><a href=https://juejin.cn/post/7089739785035579429 target=_blank rel="noopener noreffer">gprc源码分析 zhengxinzx</a> 一系列grpc源码分析，主要介绍了grpc的原理和流量控制，强烈推荐</li><li><a href=https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md target=_blank rel="noopener noreffer">grpc over http2</a> 基于http2实现grpc协议规范</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2025-05-02</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/grpc-in-practice/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on X" data-sharer=x data-url=http://example.org/posts/grpc-in-practice/ data-title=Grpc源码分析 data-hashtags=grpc><i class="fab fa-x-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Threads" data-sharer=threads data-url=http://example.org/posts/grpc-in-practice/ data-title=Grpc源码分析><i class="fab fa-threads fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://example.org/posts/grpc-in-practice/ data-hashtag=grpc><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://example.org/posts/grpc-in-practice/ data-title=Grpc源码分析><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://example.org/posts/grpc-in-practice/ data-title=Grpc源码分析><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@14.9.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://example.org/posts/grpc-in-practice/ data-title=Grpc源码分析><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Diaspora" data-sharer=diaspora data-url=http://example.org/posts/grpc-in-practice/ data-title=Grpc源码分析 data-description><i class="fab fa-diaspora fa-fw" aria-hidden=true></i></a><a href="https://t.me/share/url?url=http%3a%2f%2fexample.org%2fposts%2fgrpc-in-practice%2f&amp;text=Grpc%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" target=_blank title="Share on Telegram"><i class="fab fa-telegram fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/grpc/>Grpc</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/java-concurrency-jmm/ class=prev rel=prev title=Java内存模型><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Java内存模型</a>
<a href=/posts/spark-base/ class=next rel=next title=Spark基础知识>Spark基础知识<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.140.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xxxx</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js></script><script>window.config={comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ShadowUnderMoon/ShadowUnderMoon.github.io"}},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"}}</script><script src=/js/theme.min.js></script></body></html>