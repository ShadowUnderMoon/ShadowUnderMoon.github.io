<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>MinIO大杂烩 - 爱吃芒果</title><meta name="Description" content="This is my cool site"><meta property="og:url" content="http://example.org/posts/minio-get-started/">
  <meta property="og:site_name" content="爱吃芒果">
  <meta property="og:title" content="MinIO大杂烩">
  <meta property="og:description" content="xl.meta 数据结构 当对象大小超过 128KiB 后，比如a.txt，数据和元数据分开存储
MinIO 提供了命令行工具xl-meta用来查看xl.meta文件
{ &#34;Versions&#34;: [ { &#34;Header&#34;: { &#34;EcM&#34;: 1, &#34;EcN&#34;: 0, &#34;Flags&#34;: 2, &#34;ModTime&#34;: &#34;2025-01-23T15:27:45.311572&#43;08:00&#34;, &#34;Signature&#34;: &#34;d0c2b58b&#34;, &#34;Type&#34;: 1, &#34;VersionID&#34;: &#34;00000000000000000000000000000000&#34; }, &#34;Idx&#34;: 0, &#34;Metadata&#34;: { &#34;Type&#34;: 1, &#34;V2Obj&#34;: { &#34;CSumAlgo&#34;: 1, &#34;DDir&#34;: &#34;74hQxU7FTrq56ShK8pjqAA==&#34;, &#34;EcAlgo&#34;: 1, &#34;EcBSize&#34;: 1048576, &#34;EcDist&#34;: [1], &#34;EcIndex&#34;: 1, &#34;EcM&#34;: 1, &#34;EcN&#34;: 0, &#34;ID&#34;: &#34;AAAAAAAAAAAAAAAAAAAAAA==&#34;, &#34;MTime&#34;: 1737617265311572000, &#34;MetaSys&#34;: {}, &#34;MetaUsr&#34;: { &#34;content-type&#34;: &#34;text/plain&#34;, &#34;etag&#34;: &#34;90a1a2b65a4e40d55d758f2a59fe33b4&#34; }, &#34;PartASizes&#34;: [2097152], &#34;PartETags&#34;: null, &#34;PartNums&#34;: [1], &#34;PartSizes&#34;: [2097152], &#34;Size&#34;: 2097152 }, &#34;v&#34;: 1734527744 } } ] } . ├── a.txt │ ├── ef8850c5-4ec5-4eba-b9e9-284af298ea00 │ │ └── part.1 │ └── xl.meta └── b.txt └── xl.meta minio 的启动流程 minio 启动核心的核心命令为 minio server https://minio{1...4}.example.net:9000/mnt/disk{1...4}/minio，表示 minio 服务分布部署在 4 台服务器上总共 16 块磁盘上，...这种写法称之为拓展表达式，比如 http://minio{1…4}.example.net:9000实际上表示http://minio1.example.net:9000到http://minio4.example.net:9000`的4台主机。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-01-22T19:03:56+08:00">
    <meta property="article:modified_time" content="2025-01-22T19:03:56+08:00">
    <meta property="article:tag" content="MinIO">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="MinIO大杂烩">
  <meta name="twitter:description" content="xl.meta 数据结构 当对象大小超过 128KiB 后，比如a.txt，数据和元数据分开存储
MinIO 提供了命令行工具xl-meta用来查看xl.meta文件
{ &#34;Versions&#34;: [ { &#34;Header&#34;: { &#34;EcM&#34;: 1, &#34;EcN&#34;: 0, &#34;Flags&#34;: 2, &#34;ModTime&#34;: &#34;2025-01-23T15:27:45.311572&#43;08:00&#34;, &#34;Signature&#34;: &#34;d0c2b58b&#34;, &#34;Type&#34;: 1, &#34;VersionID&#34;: &#34;00000000000000000000000000000000&#34; }, &#34;Idx&#34;: 0, &#34;Metadata&#34;: { &#34;Type&#34;: 1, &#34;V2Obj&#34;: { &#34;CSumAlgo&#34;: 1, &#34;DDir&#34;: &#34;74hQxU7FTrq56ShK8pjqAA==&#34;, &#34;EcAlgo&#34;: 1, &#34;EcBSize&#34;: 1048576, &#34;EcDist&#34;: [1], &#34;EcIndex&#34;: 1, &#34;EcM&#34;: 1, &#34;EcN&#34;: 0, &#34;ID&#34;: &#34;AAAAAAAAAAAAAAAAAAAAAA==&#34;, &#34;MTime&#34;: 1737617265311572000, &#34;MetaSys&#34;: {}, &#34;MetaUsr&#34;: { &#34;content-type&#34;: &#34;text/plain&#34;, &#34;etag&#34;: &#34;90a1a2b65a4e40d55d758f2a59fe33b4&#34; }, &#34;PartASizes&#34;: [2097152], &#34;PartETags&#34;: null, &#34;PartNums&#34;: [1], &#34;PartSizes&#34;: [2097152], &#34;Size&#34;: 2097152 }, &#34;v&#34;: 1734527744 } } ] } . ├── a.txt │ ├── ef8850c5-4ec5-4eba-b9e9-284af298ea00 │ │ └── part.1 │ └── xl.meta └── b.txt └── xl.meta minio 的启动流程 minio 启动核心的核心命令为 minio server https://minio{1...4}.example.net:9000/mnt/disk{1...4}/minio，表示 minio 服务分布部署在 4 台服务器上总共 16 块磁盘上，...这种写法称之为拓展表达式，比如 http://minio{1…4}.example.net:9000实际上表示http://minio1.example.net:9000到http://minio4.example.net:9000`的4台主机。">
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site">
<meta name="referrer" content="no-referrer" /><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/posts/minio-get-started/" /><link rel="next" href="http://example.org/posts/prometheus_and_grafana/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "MinIO大杂烩",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/posts\/minio-get-started\/"
        },"genre": "posts","keywords": "MinIO","wordcount":  9579 ,
        "url": "http:\/\/example.org\/posts\/minio-get-started\/","datePublished": "2025-01-22T19:03:56+08:00","dateModified": "2025-01-22T19:03:56+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "爱吃芒果"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="爱吃芒果">My cool site</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/page/archives/" title="Archives"> Archives </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/page/search/" title="Search"> Search </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="爱吃芒果">My cool site</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/page/archives/" title="Archives">Archives</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/page/search/" title="Search">Search</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">MinIO大杂烩</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>爱吃芒果</a></span>&nbsp;<span class="post-category">included in <a href="/categories/minio/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>MinIO</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-01-22">2025-01-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;9579 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;20 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#xlmeta-数据结构">xl.meta 数据结构</a></li>
    <li><a href="#minio-的启动流程">minio 的启动流程</a>
      <ul>
        <li><a href="#servermain">ServerMain</a></li>
      </ul>
    </li>
    <li><a href="#minio-的-dns-缓存">MinIO 的 DNS 缓存</a></li>
    <li><a href="#构造拓扑关系-buildserverctxt">构造拓扑关系 (<code>buildServerCtxt</code>)</a>
      <ul>
        <li><a href="#serverhandlecmdargs-函数">serverHandleCmdArgs 函数</a></li>
      </ul>
    </li>
    <li><a href="#http-服务器注册-api">HTTP 服务器注册 API</a></li>
    <li><a href="#objectlayer-的初始化流程">ObjectLayer 的初始化流程</a>
      <ul>
        <li><a href="#minio-的存储分层">MinIO 的存储分层</a></li>
        <li><a href="#storageapi">StorageAPI</a></li>
        <li><a href="#objectlayer">ObjectLayer</a></li>
      </ul>
    </li>
    <li><a href="#重要常量">重要常量</a></li>
    <li><a href="#s3-api-putobject">s3 API: PutObject</a>
      <ul>
        <li><a href="#block-和-shard">block 和 shard</a></li>
        <li><a href="#putobject-的主要流程">putObject 的主要流程</a></li>
      </ul>
    </li>
    <li><a href="#名字空间锁的实现原理-todo">名字空间锁的实现原理 （TODO)</a>
      <ul>
        <li><a href="#什么是-dsync"><strong>什么是 dsync？</strong></a></li>
        <li><a href="#dsync-是如何工作的"><strong>dsync 是如何工作的？</strong></a></li>
        <li><a href="#总结"><strong>总结</strong></a></li>
      </ul>
    </li>
    <li><a href="#o_direct-的实际用途">O_DIRECT 的实际用途</a></li>
    <li><a href="#s3-api-getobject">s3 API: GetObject</a></li>
    <li><a href="#纠删码的基本原理">纠删码的基本原理</a></li>
    <li><a href="#分片上传和断点续传">分片上传和断点续传</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="xlmeta-数据结构">xl.meta 数据结构</h2>
<p>当对象大小超过 128KiB 后，比如<code>a.txt</code>，数据和元数据分开存储</p>
<p>MinIO 提供了命令行工具<code>xl-meta</code>用来查看<code>xl.meta</code>文件</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-json">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;Versions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;Header&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;EcM&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;EcN&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Flags&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ModTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-01-23T15:27:45.311572+08:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Signature&#34;</span><span class="p">:</span> <span class="s2">&#34;d0c2b58b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;VersionID&#34;</span><span class="p">:</span> <span class="s2">&#34;00000000000000000000000000000000&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;Idx&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;Metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;V2Obj&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;CSumAlgo&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;DDir&#34;</span><span class="p">:</span> <span class="s2">&#34;74hQxU7FTrq56ShK8pjqAA==&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;EcAlgo&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;EcBSize&#34;</span><span class="p">:</span> <span class="mi">1048576</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;EcDist&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;EcIndex&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;EcM&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;EcN&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ID&#34;</span><span class="p">:</span> <span class="s2">&#34;AAAAAAAAAAAAAAAAAAAAAA==&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;MTime&#34;</span><span class="p">:</span> <span class="mi">1737617265311572000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;MetaSys&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;MetaUsr&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content-type&#34;</span><span class="p">:</span> <span class="s2">&#34;text/plain&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;etag&#34;</span><span class="p">:</span> <span class="s2">&#34;90a1a2b65a4e40d55d758f2a59fe33b4&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;PartASizes&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2097152</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;PartETags&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;PartNums&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;PartSizes&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2097152</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;Size&#34;</span><span class="p">:</span> <span class="mi">2097152</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;v&#34;</span><span class="p">:</span> <span class="mi">1734527744</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── a.txt
</span></span><span class="line"><span class="cl">│   ├── ef8850c5-4ec5-4eba-b9e9-284af298ea00
</span></span><span class="line"><span class="cl">│   │   └── part.1
</span></span><span class="line"><span class="cl">│   └── xl.meta
</span></span><span class="line"><span class="cl">└── b.txt
</span></span><span class="line"><span class="cl">    └── xl.meta</span></span></code></pre></div></div>
<h2 id="minio-的启动流程">minio 的启动流程</h2>
<p>minio 启动核心的核心命令为 <code>minio server https://minio{1...4}.example.net:9000/mnt/disk{1...4}/minio</code>，表示 minio 服务分布部署在 4 台服务器上总共 16 块磁盘上，<code>...这种写法称之为拓展表达式，比如 </code>http://minio{1&hellip;4}.example.net:9000<code>实际上表示</code><a href="http://minio1.example.net:9000" target="_blank" rel="noopener noreffer ">http://minio1.example.net:9000</a><code>到</code><a href="http://minio4.example.net:9000" target="_blank" rel="noopener noreffer ">http://minio4.example.net:9000</a>`的4台主机。</p>
<p>go 程序的入口为<code>main#main()</code>函数，直接调用了<code>cmd#Main</code>,其中做了一些命令行程序的相关操作，包括注册命令，其中<code>registerCommand(serverCmd)</code>注册服务相关命令，<code>cmd#ServerMain</code>是主要启动流程函数。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Run the app - exit on error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newApp</span><span class="p">(</span><span class="nx">appName</span><span class="p">).</span><span class="nf">Run</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">//nolint:gocritic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">serverCmd</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Name</span><span class="p">:</span>   <span class="s">&#34;server&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Usage</span><span class="p">:</span>  <span class="s">&#34;start object storage server&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Flags</span><span class="p">:</span>  <span class="nb">append</span><span class="p">(</span><span class="nx">ServerFlags</span><span class="p">,</span> <span class="nx">GlobalFlags</span><span class="o">...</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Action</span><span class="p">:</span> <span class="nx">serverMain</span><span class="p">,</span></span></span></code></pre></div></div>
<h3 id="servermain">ServerMain</h3>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">server</span>
</span></span><span class="line"><span class="cl"><span class="nx">http</span><span class="p">:</span><span class="c1">//127.0.0.1:/Users/hanjing/mnt/minio0{1...3}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">http</span><span class="p">:</span><span class="c1">//127.0.0.1:/Users/hanjing/mnt/minio0{4...6}
</span></span></span></code></pre></div></div>
<p>处理系统终止或者重启相关的信号等</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">globalOSSignalCh</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="nf">handleSignals</span><span class="p">()</span></span></span></code></pre></div></div>
<p><code>buildServerCtxt</code>决定磁盘布局以及是否使用 legacy 方式，调用函数<code>cmd#mergeDisksLayoutFromArgs</code>判断是否使用了拓展表达式，如果没有，<code>legacy = true</code>，否则<code>legacy =false</code>, <code>legacy</code>参数的作用我们在后面就能看到了。</p>
<p><code>serverHandleCmdArgs</code>函数中调用 <code>createServerEndpoints</code>，</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="c1">// Handle all server command args and build the disks layout
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">bootstrapTrace</span><span class="p">(</span><span class="s">&#34;serverHandleCmdArgs&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里确定了erasure set size的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">err</span> <span class="o">:=</span> <span class="nf">buildServerCtxt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">globalServerCtxt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">FatalIf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Unable to prepare the list of endpoints&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">serverHandleCmdArgs</span><span class="p">(</span><span class="nx">globalServerCtxt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span></span></span></code></pre></div></div>
<h2 id="minio-的-dns-缓存">MinIO 的 DNS 缓存</h2>
<p>MinIO 为了避免向外发送过多的 DNS 查询，所以实现了 DNS 缓存，默认使用<code>net.DefaultResolver</code>实际执行 DNS 查询，设置的 DNS 查询超时时间为<code>5s</code>，缓存的刷新时间在容器环境下默认为<code>30s</code>，在其他环境下为<code>10min</code>，可以通过<code>dns-cache-ttl</code>指定。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Resolver</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Timeout defines the maximum allowed time allowed for a lookup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Resolver is used to perform actual DNS lookup. If nil,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// net.DefaultResolver is used instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Resolver</span> <span class="nx">DNSResolver</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">once</span>  <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mu</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cache</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">cacheEntry</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">globalDNSCache</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">dnscache</span><span class="p">.</span><span class="nx">Resolver</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Timeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runDNSCache</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dnsTTL</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="s">&#34;dns-cache-ttl&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Check if we have configured a custom DNS cache TTL.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">dnsTTL</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">orchestrated</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">dnsTTL</span> <span class="p">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">dnsTTL</span> <span class="p">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Call to refresh will refresh names in cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Baremetal setups set DNS refresh window up to dnsTTL duration.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">t</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">dnsTTL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">t</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">globalDNSCache</span><span class="p">.</span><span class="nf">Refresh</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">GlobalContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="构造拓扑关系-buildserverctxt">构造拓扑关系 (<code>buildServerCtxt</code>)</h2>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// serverCtxt保存了磁盘布局
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">disksLayout</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 是否使用拓展表达式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">legacy</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// server pool的集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pools</span>  <span class="p">[]</span><span class="nx">poolDisksLayout</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">poolDisksLayout</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// server pool对应的命令行命令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cmdline</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// layout的第一位表示不同的erasure set，第二维表示同一个erasure set中不同的磁盘路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">layout</span>  <span class="p">[][]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>构造拓扑关系的主要函数实现是<code>mergeDisksLayoutFromArgs</code>，判断环境变量<code>MINIO_ERASURE_SET_DRIVE_COUNT</code>是否存在，环境变量<code>MINIO_ERASURE_SET_DRIVE_COUNT</code>表示 erasure set 中指定的磁盘数量，否则默认为 0，表示自动设置最优结果。根据是否使用拓展表达式会走不同的逻辑。这里我们主要关心使用拓展表达式的场景<code>GetAllSets(setDriveCount, arg)</code>。（顺带一提，legacy style 会走<code>GetAllSets(setDriveCount, args...)</code>，可以看到 legacy style 只能指定一个<code>server pool</code>）</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mergeDisksLayoutFromArgs supports with and without ellipses transparently.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 构造网络拓扑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mergeDisksLayoutFromArgs</span><span class="p">(</span><span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">ctxt</span> <span class="o">*</span><span class="nx">serverCtxt</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errInvalidArgument</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ok</span> <span class="o">:=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ok 表示是否使用拓展表达式，true表示不使用拓展表达式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 只要在其中一个arg中使用拓展表达式，结果均为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">arg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">args</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ok</span> <span class="p">=</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">ellipses</span><span class="p">.</span><span class="nf">HasEllipses</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">setArgs</span> <span class="p">[][]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过环境变量得到erasure set的大小，默认为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">env</span><span class="p">.</span><span class="nf">GetInt</span><span class="p">(</span><span class="nx">EnvErasureSetDriveCount</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">setDriveCount</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// None of the args have ellipses use the old style.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">setArgs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">GetAllSets</span><span class="p">(</span><span class="nx">setDriveCount</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 所有的参数组成一个server pool
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">ctxt</span><span class="p">.</span><span class="nx">Layout</span> <span class="p">=</span> <span class="nx">disksLayout</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">legacy</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">pools</span><span class="p">:</span>  <span class="p">[]</span><span class="nx">poolDisksLayout</span><span class="p">{{</span><span class="nx">layout</span><span class="p">:</span> <span class="nx">setArgs</span><span class="p">,</span> <span class="nx">cmdline</span><span class="p">:</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">)}},</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">arg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">args</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">ellipses</span><span class="p">.</span><span class="nf">HasEllipses</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// TODO: support SNSD deployments to be decommissioned in future
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;all args must have ellipses for pool expansion (%w) args: %s&#34;</span><span class="p">,</span> <span class="nx">errInvalidArgument</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">setArgs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">GetAllSets</span><span class="p">(</span><span class="nx">setDriveCount</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctxt</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">pools</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ctxt</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">pools</span><span class="p">,</span> <span class="nx">poolDisksLayout</span><span class="p">{</span><span class="nx">cmdline</span><span class="p">:</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">layout</span><span class="p">:</span> <span class="nx">setArgs</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p><code>GetAllSets</code>主要调用了<code>parseEndpointSet</code>，通过正则表达式解析带有拓展表达式的输入参数，并返回一个<code>[][]string</code>，表示不同 erasure set 中的磁盘路径。这里主要对应的数据结构是<code>endpointSet</code>，主要实现两件事情，第一确定 setSize，第二确定如何将 endpoints 分布到不同的 erasure set 中。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Endpoint set represents parsed ellipses values, also provides
</span></span></span><span class="line"><span class="cl"><span class="c1">// methods to get the sets of endpoints.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">endpointSet</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 解析终端字符串得到的arg pattern，如果有多个ellipses，对应多个`Pattern`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">argPatterns</span> <span class="p">[]</span><span class="nx">ellipses</span><span class="p">.</span><span class="nx">ArgPattern</span>
</span></span><span class="line"><span class="cl">	<span class="nx">endpoints</span>   <span class="p">[]</span><span class="kt">string</span>   <span class="c1">// Endpoints saved from previous GetEndpoints().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 对于ellipses-style的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// setIndexes对应一行，记录了server pool size /setSize 个 setSize值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">setIndexes</span>  <span class="p">[][]</span><span class="kt">uint64</span> <span class="c1">// All the sets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ArgPattern</span> <span class="p">[]</span><span class="nx">Pattern</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Pattern - ellipses pattern, describes the range and also the
</span></span></span><span class="line"><span class="cl"><span class="c1">// associated prefix and suffixes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Pattern</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Prefix</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Suffix</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Seq</span>    <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>函数<code>getSetIndexes</code>的目的是找到合适的<code>setSize</code>，MinIO 规定分布式部署 setSize 的取值必须属于<code>var setSizes = []uint64{2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16}</code>，首先从<code>SetSizes</code>中找到能够被<code>server pool size</code>整除的<code>setCounts</code>集合，如果自定义了<code>setSize</code>则判断自定义的<code>setSize</code>是否属于<code>setCounts</code>集合，如果属于则<code>setSize</code>设置成功，否则返回错误。如果没有设置自定义的<code>setSize</code>，函数<code>possibleSetCountsWithSymmetry</code>从<code>setCounts</code>集合中找到具有<code>symmetry</code>属性的值，MinIO 中输入带拓展表达式的参数对应的 pattern 列表和参数中的顺序是相反的，<code>symmetry</code>过滤出能够被 pattern 中最后一个 pattern 对应的数量整除或者被整除的<code>setCounts</code>中的值，这里举一个例子<code>http://127.0.0.{1...4}:9000/Users/hanjing/mnt/minio{1...32}</code>，显然<code>symmetry</code>函数会判断 4 和<code>setCounts</code>中值的关系，而不是 32 和<code>setCounts</code>中值的关系，这可能与 MinIO 希望尽可能将 erasure set 的中不同磁盘分布到不同的节点上有关。最后取出剩余候选值中最大的值作为最终的<code>setSize</code>。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">endpointSet</span><span class="p">)</span> <span class="nf">Get</span><span class="p">()</span> <span class="p">(</span><span class="nx">sets</span> <span class="p">[][]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">k</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">getEndpoints</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">setIndexes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">setIndexes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">sets</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">sets</span><span class="p">,</span> <span class="nx">endpoints</span><span class="p">[</span><span class="nx">k</span><span class="p">:</span><span class="nx">s</span><span class="p">.</span><span class="nx">setIndexes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span><span class="o">+</span><span class="nx">k</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">			<span class="nx">k</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">setIndexes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">+</span> <span class="nx">k</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">sets</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p><code>endpointSet#Get</code>方法返回一个二维数据，第一维表示 不同的 erasure set，第二位表示 erasure set 中的不同磁盘。这里<code>getEndpoints</code>多重循环迭代 ellipses-style 对应的 pattern，如果还记得的话，pattern 的顺序和实际在参数中出现的顺序相反，这样得到的<code>endpoints</code>列表将不同节点上的磁盘均匀分布，后面连续取列表中的一段组成<code>erasure set</code>时，得到的<code>erasure set</code>中的磁盘也分布在不同的节点上。</p>
<h3 id="serverhandlecmdargs-函数">serverHandleCmdArgs 函数</h3>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="nx">globalEndpoints</span><span class="p">,</span> <span class="nx">setupType</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">createServerEndpoints</span><span class="p">(</span><span class="nx">globalMinioAddr</span><span class="p">,</span> <span class="nx">ctxt</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">pools</span><span class="p">,</span> <span class="nx">ctxt</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">legacy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">logger</span><span class="p">.</span><span class="nf">FatalIf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Invalid command line arguments&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">globalNodes</span> <span class="p">=</span> <span class="nx">globalEndpoints</span><span class="p">.</span><span class="nf">GetNodes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">globalIsErasure</span> <span class="p">=</span> <span class="p">(</span><span class="nx">setupType</span> <span class="o">==</span> <span class="nx">ErasureSetupType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">globalIsDistErasure</span> <span class="p">=</span> <span class="p">(</span><span class="nx">setupType</span> <span class="o">==</span> <span class="nx">DistErasureSetupType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">globalIsDistErasure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">globalIsErasure</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">globalIsErasureSD</span> <span class="p">=</span> <span class="p">(</span><span class="nx">setupType</span> <span class="o">==</span> <span class="nx">ErasureSDSetupType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">globalDynamicAPIPort</span> <span class="o">&amp;&amp;</span> <span class="nx">globalIsDistErasure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">FatalIf</span><span class="p">(</span><span class="nx">errInvalidArgument</span><span class="p">,</span> <span class="s">&#34;Invalid --address=\&#34;%s\&#34;, port &#39;0&#39; is not allowed in a distributed erasure coded setup&#34;</span><span class="p">,</span> <span class="nx">ctxt</span><span class="p">.</span><span class="nx">Addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">globalLocalNodeName</span> <span class="p">=</span> <span class="nf">GetLocalPeer</span><span class="p">(</span><span class="nx">globalEndpoints</span><span class="p">,</span> <span class="nx">globalMinioHost</span><span class="p">,</span> <span class="nx">globalMinioPort</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nodeNameSum</span> <span class="o">:=</span> <span class="nx">sha256</span><span class="p">.</span><span class="nf">Sum256</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">globalLocalNodeName</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">globalLocalNodeNameHex</span> <span class="p">=</span> <span class="nx">hex</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">nodeNameSum</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Initialize, see which NIC the service is running on, and save it as global value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">setGlobalInternodeInterface</span><span class="p">(</span><span class="nx">ctxt</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span></span></span></code></pre></div></div>
<p>里面有一个比较重要的工具函数<code>isLocalHost</code>，通过 DNS 查询 host 对应的 ip，和所有网卡对应的所有本地 ip 取交集,如果交集为空，说明不是本地服务器，否则是本地服务器。</p>
<p>函数<code>createServerEndpoints</code>将数据结构<code>[]poolDisksLayout</code>转换成<code>EndpointServerPools</code>，并指定对应的<code>SetupType</code></p>
<p>对于单磁盘部署，要求使用目录路径指定输入参数，<code>IsLocal</code>一定为<code>true</code>，<code>SetupType</code>为<code>ErasureSDSetupType</code>。其他情况下根据，根据本地 ip 和给定的 host，判断<code>IsLocal</code>，如果 host 为空（MinIO 称为<code>PathEndpointType</code>)，则<code>setupType = ErasureSetupType</code>，否则为<code>URLEndpointType</code>情况，如果不同<code>host:port</code>的数量等于 1，则是<code>ErasureSetupType</code>，否则对应<code>DistErasureSetupType</code>，根据得到的<code>SetType</code>设置全局参数。</p>
<p><code>EndpointServerPools</code>实际上是<code>[][]EndPoint</code>，第一位</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// EndpointServerPools是 PoolEndpoints的集合，实际上描述整个部署的拓扑结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">EndpointServerPools</span> <span class="p">[]</span><span class="nx">PoolEndpoints</span>
</span></span><span class="line"><span class="cl"><span class="c1">// PoolEndpoints represent endpoints in a given pool
</span></span></span><span class="line"><span class="cl"><span class="c1">// along with its setCount and setDriveCount.
</span></span></span><span class="line"><span class="cl"><span class="c1">// PoolEndpoints表示一个server pool的结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">PoolEndpoints</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// indicates if endpoints are provided in non-ellipses style
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// legacy 表示 是否使用遗留的方法表示终端，而不使用省略号表达式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Legacy</span>       <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// SetCount表示 server pool中的 erasure set的数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">SetCount</span>     <span class="kt">int</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// DrivesPerSet 表示一个erasure set中的磁盘数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">DrivesPerSet</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// type Endpoints []Endpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 表示一个server pool中的所有disk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Endpoints</span>    <span class="nx">Endpoints</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// server pool对应的命令行指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">CmdLine</span>      <span class="kt">string</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 操作系统信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Platform</span>     <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Endpoint</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果是单个目录的输入，则 IsLocal为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 如果输入参数ip是本地ip，IsLocal也为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 其他情况下为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">IsLocal</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">PoolIdx</span><span class="p">,</span> <span class="nx">SetIdx</span><span class="p">,</span> <span class="nx">DiskIdx</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// SetupType - enum for setup type.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">SetupType</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// UnknownSetupType - starts with unknown setup type.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">UnknownSetupType</span> <span class="nx">SetupType</span> <span class="p">=</span> <span class="kc">iota</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// FSSetupType - FS setup type enum.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">FSSetupType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ErasureSDSetupType - Erasure single drive setup enum.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ErasureSDSetupType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ErasureSetupType - Erasure setup type enum.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ErasureSetupType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// DistErasureSetupType - Distributed Erasure setup type enum.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">DistErasureSetupType</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div></div>
<p>以下函数列出了 Minio 支持的不同模式，和上面的<code>SetType</code>之间存在对应关系。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Returns the mode in which MinIO is running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">getMinioMode</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">globalIsDistErasure</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">globalMinioModeDistErasure</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">globalIsErasure</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">globalMinioModeErasure</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">globalIsErasureSD</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">globalMinioModeErasureSD</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">globalMinioModeFS</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="http-服务器注册-api">HTTP 服务器注册 API</h2>
<ul>
<li>注册分布式命名空间锁</li>
<li><code>registerAPIRouter</code>注册 s3 相关的主要 api</li>
</ul>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="c1">// Configure server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">bootstrapTrace</span><span class="p">(</span><span class="s">&#34;configureServer&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">handler</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">configureServerHandler</span><span class="p">(</span><span class="nx">globalEndpoints</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">logger</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nf">ErrUnexpectedError</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span> <span class="s">&#34;Unable to configure one of server&#39;s RPC services&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Allow grid to start after registering all services.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nb">close</span><span class="p">(</span><span class="nx">globalGridStart</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">close</span><span class="p">(</span><span class="nx">globalLockGridStart</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">httpServer</span> <span class="o">:=</span> <span class="nx">xhttp</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nf">getServerListenAddrs</span><span class="p">()).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UseHandler</span><span class="p">(</span><span class="nf">setCriticalErrorHandler</span><span class="p">(</span><span class="nf">corsHandler</span><span class="p">(</span><span class="nx">handler</span><span class="p">))).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UseTLSConfig</span><span class="p">(</span><span class="nf">newTLSConfig</span><span class="p">(</span><span class="nx">getCert</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UseIdleTimeout</span><span class="p">(</span><span class="nx">globalServerCtxt</span><span class="p">.</span><span class="nx">IdleTimeout</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UseReadTimeout</span><span class="p">(</span><span class="nx">globalServerCtxt</span><span class="p">.</span><span class="nx">IdleTimeout</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UseWriteTimeout</span><span class="p">(</span><span class="nx">globalServerCtxt</span><span class="p">.</span><span class="nx">IdleTimeout</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UseReadHeaderTimeout</span><span class="p">(</span><span class="nx">globalServerCtxt</span><span class="p">.</span><span class="nx">ReadHeaderTimeout</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UseBaseContext</span><span class="p">(</span><span class="nx">GlobalContext</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UseCustomLogger</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span> <span class="c1">// Turn-off random logging by Go stdlib
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">UseTCPOptions</span><span class="p">(</span><span class="nx">globalTCPOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">httpServer</span><span class="p">.</span><span class="nx">TCPOptions</span><span class="p">.</span><span class="nx">Trace</span> <span class="p">=</span> <span class="nx">bootstrapTraceMsg</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">serveFn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">httpServer</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="nx">GlobalContext</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">listenAddr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">bootLogIf</span><span class="p">(</span><span class="nx">GlobalContext</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Unable to listen on `%s`: %v&#34;</span><span class="p">,</span> <span class="nx">listenAddr</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">globalHTTPServerErrorCh</span> <span class="o">&lt;-</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">globalHTTPServerErrorCh</span> <span class="o">&lt;-</span> <span class="nf">serveFn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">setHTTPServer</span><span class="p">(</span><span class="nx">httpServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// configureServer handler returns final handler for the http server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">configureServerHandler</span><span class="p">(</span><span class="nx">endpointServerPools</span> <span class="nx">EndpointServerPools</span><span class="p">)</span> <span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Initialize router. `SkipClean(true)` stops minio/mux from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// normalizing URL path minio/minio#3256
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">router</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">().</span><span class="nf">SkipClean</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nf">UseEncodedPath</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Initialize distributed NS lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">globalIsDistErasure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">registerDistErasureRouters</span><span class="p">(</span><span class="nx">router</span><span class="p">,</span> <span class="nx">endpointServerPools</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Add Admin router, all APIs are enabled in server mode.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">registerAdminRouter</span><span class="p">(</span><span class="nx">router</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Add healthCheck router
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">registerHealthCheckRouter</span><span class="p">(</span><span class="nx">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Add server metrics router
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">registerMetricsRouter</span><span class="p">(</span><span class="nx">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Add STS router always.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">registerSTSRouter</span><span class="p">(</span><span class="nx">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Add KMS router
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">registerKMSRouter</span><span class="p">(</span><span class="nx">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Add API router
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">registerAPIRouter</span><span class="p">(</span><span class="nx">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">router</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">globalMiddlewares</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">router</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p><code>registerAPIRouter</code>会注册主要的 s3 API，这里举<code>GetObject</code>操作为例进行说明，当 http method 为<code>GET</code>时，如果没有命中其他的路由，则认为是<code>GetObject</code>操作，从 Path 中获取<code>object</code>名字，并使用<code>api.GetObjectHandler</code>进行处理和响应，<code>s3APIMiddleware</code>作为中间件，可以做一些额外的操作，比如监控和记录日志。</p>
<p><code>api</code>对象中保存了一个函数引用，通过这个函数引用，能够得到全局的<code>ObjectLayer</code>对象，<code>ObjectLayer</code>实现了对象 API 层的基本操作。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// GetObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">router</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodGet</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/{object:.+}&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">  <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nf">s3APIMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">GetObjectHandler</span><span class="p">,</span> <span class="nx">traceHdrsS3HFlag</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Initialize API.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">api</span> <span class="o">:=</span> <span class="nx">objectAPIHandlers</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ObjectAPI</span><span class="p">:</span> <span class="nx">newObjectLayerFn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// objectAPIHandlers implements and provides http handlers for S3 API.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">objectAPIHandlers</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ObjectAPI</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">ObjectLayer</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newObjectLayerFn</span><span class="p">()</span> <span class="nx">ObjectLayer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">globalObjLayerMutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">globalObjLayerMutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">globalObjectAPI</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="objectlayer-的初始化流程">ObjectLayer 的初始化流程</h2>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">newObject</span> <span class="nx">ObjectLayer</span>
</span></span><span class="line"><span class="cl">	<span class="nf">bootstrapTrace</span><span class="p">(</span><span class="s">&#34;newObjectLayer&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">		<span class="nx">newObject</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">newObjectLayer</span><span class="p">(</span><span class="nx">GlobalContext</span><span class="p">,</span> <span class="nx">globalEndpoints</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">logFatalErrs</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">Endpoint</span><span class="p">{},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span></span></span></code></pre></div></div>
<p><code>storageclass.LookupConfig</code>函数根据环境变量等初始化<code>Standard Storage Class</code>、<code>Reduced Redundancy Storage Class</code>以及<code>Optimized Storage Class</code>、以及 <code>inline data</code>的大小</p>
<p><code>Standard Storage Class</code>：通过环境变量<code>MINIO_STORAGE_CLASS_STANDARD</code>指定，否则会根据<code>erasure set</code>的大小指定</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// DefaultParityBlocks returns default parity blocks for &#39;drive&#39; count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">DefaultParityBlocks</span><span class="p">(</span><span class="nx">drive</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">drive</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p><code>Reduced Redundancy Storage Class</code>: 通过环境变量<code>MINIO_STORAGE_CLASS_RRS</code>指定，否则默认为 1</p>
<p><code>Optimized Storage Class</code>：通过环境变量<code>MINIO_STORAGE_CLASS_OPTIMIZE</code>指定，默认为<code>&quot;&quot;</code></p>
<p><code>inline block size</code>: 通过环境变量<code>MINIO_STORAGE_CLASS_INLINE_BLOCK</code>指定，默认为<code>128KiB</code>,如果 shard 数据的大小小于<code>inline block size</code>，则会直接将数据和元数据写到同一个文件，即<code>xl.meta</code></p>
<h3 id="minio-的存储分层">MinIO 的存储分层</h3>
<h4 id="erasureserverpools">erasureServerPools</h4>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// erasureServerPools
</span></span></span><span class="line"><span class="cl"><span class="c1">// minio 服务可以由多个server pool 组成，用来水平拓展
</span></span></span><span class="line"><span class="cl"><span class="c1">// erasureServerPools是server pool的集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">erasureServerPools</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">poolMetaMutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">poolMeta</span>      <span class="nx">poolMeta</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rebalMu</span>   <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rebalMeta</span> <span class="o">*</span><span class="nx">rebalanceMeta</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">deploymentID</span>     <span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">distributionAlgo</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// server pool 由多个erasure set 组成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 这里的erasureSets结构实际上指单个 server pool
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">serverPools</span> <span class="p">[]</span><span class="o">*</span><span class="nx">erasureSets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Active decommission canceler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">decommissionCancelers</span> <span class="p">[]</span><span class="nx">context</span><span class="p">.</span><span class="nx">CancelFunc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s3Peer</span> <span class="o">*</span><span class="nx">S3PeerSys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">mpCache</span> <span class="o">*</span><span class="nx">xsync</span><span class="p">.</span><span class="nx">MapOf</span><span class="p">[</span><span class="kt">string</span><span class="p">,</span> <span class="nx">MultipartInfo</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h4 id="erasuresets">erasureSets</h4>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// erasureSets implements ObjectLayer combining a static list of erasure coded
</span></span></span><span class="line"><span class="cl"><span class="c1">// object sets. NOTE: There is no dynamic scaling allowed or intended in
</span></span></span><span class="line"><span class="cl"><span class="c1">// current design.
</span></span></span><span class="line"><span class="cl"><span class="c1">// server pool 由多个erasure set 组成
</span></span></span><span class="line"><span class="cl"><span class="c1">// 这里的erasureSets结构实际上指单个 server pool
</span></span></span><span class="line"><span class="cl"><span class="c1">// 上面这段话的意思是不能动态扩展server pool，初始指定后就不能再修改了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">erasureSets</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sets</span> <span class="p">[]</span><span class="o">*</span><span class="nx">erasureObjects</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Reference format.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">format</span> <span class="o">*</span><span class="nx">formatErasureV3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// erasureDisks mutex to lock erasureDisks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">erasureDisksMu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Re-ordered list of disks per set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">erasureDisks</span> <span class="p">[][]</span><span class="nx">StorageAPI</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Distributed locker clients.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">erasureLockers</span> <span class="nx">setsDsyncLockers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Distributed lock owner (constant per running instance).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">erasureLockOwner</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// List of endpoints provided on the command line.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">endpoints</span> <span class="nx">PoolEndpoints</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// String version of all the endpoints, an optimization
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to avoid url.String() conversion taking CPU on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// large disk setups.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">endpointStrings</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Total number of sets and the number of disks per set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">setCount</span><span class="p">,</span> <span class="nx">setDriveCount</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">defaultParityCount</span>      <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">poolIndex</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Distribution algorithm of choice.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">distributionAlgo</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">deploymentID</span>     <span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">lastConnectDisksOpTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h4 id="erasureobjects">erasureObjects</h4>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// erasureObjects - Implements ER object layer.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 表示一个erasure Set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">erasureObjects</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">setDriveCount</span>      <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">defaultParityCount</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">setIndex</span>  <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">poolIndex</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// getDisks returns list of storageAPIs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">getDisks</span> <span class="kd">func</span><span class="p">()</span> <span class="p">[]</span><span class="nx">StorageAPI</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// getLockers returns list of remote and local lockers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">getLockers</span> <span class="kd">func</span><span class="p">()</span> <span class="p">([]</span><span class="nx">dsync</span><span class="p">.</span><span class="nx">NetLocker</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// getEndpoints returns list of endpoint belonging this set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// some may be local and some remote.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">getEndpoints</span> <span class="kd">func</span><span class="p">()</span> <span class="p">[]</span><span class="nx">Endpoint</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// getEndpoints returns list of endpoint strings belonging this set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// some may be local and some remote.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">getEndpointStrings</span> <span class="kd">func</span><span class="p">()</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Locker mutex map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nsMutex</span> <span class="o">*</span><span class="nx">nsLockMap</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h3 id="storageapi">StorageAPI</h3>
<p><code>StorageAPI</code>主要有两个实现</p>
<ul>
<li><code>xlStorage</code>表示本地存储</li>
<li><code>storageRESTClient</code>表示远程主机上的存储</li>
</ul>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Depending on the disk type network or local, initialize storage API.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newStorageAPI</span><span class="p">(</span><span class="nx">endpoint</span> <span class="nx">Endpoint</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">storageOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">storage</span> <span class="nx">StorageAPI</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">IsLocal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newXLStorage</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">cleanUp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">newXLStorageDiskIDCheck</span><span class="p">(</span><span class="nx">storage</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">healthCheck</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">newStorageRESTClient</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">healthCheck</span><span class="p">,</span> <span class="nx">globalGrid</span><span class="p">.</span><span class="nf">Load</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p><code>newXLStorage</code>函数调用了<code>getDiskInfo</code>函数，并要求路径不能在<code>rootDrive</code>上。判断磁盘是否支持<code>O_DIRECT</code>，在分布式部署下，如果不支持<code>O_DIRECT</code>，则直接报错。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="c1">// Return an error if ODirect is not supported. Single disk will have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// oDirect off.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 在类似unix的平台上 disk.ODirectPlatform应该为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">globalIsErasureSD</span> <span class="o">||</span> <span class="p">!</span><span class="nx">disk</span><span class="p">.</span><span class="nx">ODirectPlatform</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">oDirect</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">checkODirectDiskSupport</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">FSType</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">oDirect</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// getDiskInfo returns given disk information.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">getDiskInfo</span><span class="p">(</span><span class="nx">drivePath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">di</span> <span class="nx">disk</span><span class="p">.</span><span class="nx">Info</span><span class="p">,</span> <span class="nx">rootDrive</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">checkPathLength</span><span class="p">(</span><span class="nx">drivePath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">di</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">disk</span><span class="p">.</span><span class="nf">GetInfo</span><span class="p">(</span><span class="nx">drivePath</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">globalIsCICD</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">globalIsErasureSD</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">globalRootDiskThreshold</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Use MINIO_ROOTDISK_THRESHOLD_SIZE to figure out if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// this disk is a root disk. treat those disks with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// size less than or equal to the threshold as rootDrives.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">rootDrive</span> <span class="p">=</span> <span class="nx">di</span><span class="p">.</span><span class="nx">Total</span> <span class="o">&lt;=</span> <span class="nx">globalRootDiskThreshold</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rootDrive</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">disk</span><span class="p">.</span><span class="nf">IsRootDisk</span><span class="p">(</span><span class="nx">drivePath</span><span class="p">,</span> <span class="nx">SlashSeparator</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// StorageAPI interface.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 对应磁盘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">StorageAPI</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Stringified version of disk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Storage operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Returns true if disk is online and its valid i.e valid format.json.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This has nothing to do with if the drive is hung or not responding.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// For that individual storage API calls will fail properly. The purpose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// of this function is to know if the &#34;drive&#34; has &#34;format.json&#34; or not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// if it has a &#34;format.json&#34; then is it correct &#34;format.json&#34; or not.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">IsOnline</span><span class="p">()</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Returns the last time this disk (re)-connected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">LastConn</span><span class="p">()</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Indicates if disk is local or not.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">IsLocal</span><span class="p">()</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Returns hostname if disk is remote.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Hostname</span><span class="p">()</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Returns the entire endpoint.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Endpoint</span><span class="p">()</span> <span class="nx">Endpoint</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Close the disk, mark it purposefully closed, only implemented for remote disks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Returns the unique &#39;uuid&#39; of this disk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetDiskID</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Set a unique &#39;uuid&#39; for this disk, only used when
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// disk is replaced and formatted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SetDiskID</span><span class="p">(</span><span class="nx">id</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Returns healing information for a newly replaced disk,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// returns &#39;nil&#39; once healing is complete or if the disk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// has never been replaced.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Healing</span><span class="p">()</span> <span class="o">*</span><span class="nx">healingTracker</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DiskInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">DiskInfoOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">info</span> <span class="nx">DiskInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">NSScanner</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">cache</span> <span class="nx">dataUsageCache</span><span class="p">,</span> <span class="nx">updates</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">dataUsageEntry</span><span class="p">,</span> <span class="nx">scanMode</span> <span class="nx">madmin</span><span class="p">.</span><span class="nx">HealScanMode</span><span class="p">,</span> <span class="nx">shouldSleep</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">dataUsageCache</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Volume operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">MakeVol</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">MakeVolBulk</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volumes</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListVols</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">vols</span> <span class="p">[]</span><span class="nx">VolInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">StatVol</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">vol</span> <span class="nx">VolInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteVol</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">forceDelete</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// WalkDir will walk a directory on disk and return a metacache stream on wr.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">WalkDir</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">WalkDirOptions</span><span class="p">,</span> <span class="nx">wr</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Metadata operations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">DeleteVersion</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fi</span> <span class="nx">FileInfo</span><span class="p">,</span> <span class="nx">forceDelMarker</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">DeleteOptions</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteVersions</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">versions</span> <span class="p">[]</span><span class="nx">FileInfoVersions</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">[]</span><span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteBulk</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">paths</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">WriteMetadata</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">origvolume</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fi</span> <span class="nx">FileInfo</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">UpdateMetadata</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fi</span> <span class="nx">FileInfo</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">UpdateMetadataOpts</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadVersion</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">origvolume</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">versionID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ReadOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">FileInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadXL</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">readData</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">RawFileInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RenameData</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">srcVolume</span><span class="p">,</span> <span class="nx">srcPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fi</span> <span class="nx">FileInfo</span><span class="p">,</span> <span class="nx">dstVolume</span><span class="p">,</span> <span class="nx">dstPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">RenameOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">RenameDataResp</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// File operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">ListDir</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">origvolume</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">dirPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">count</span> <span class="kt">int</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadFile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">offset</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">verifier</span> <span class="o">*</span><span class="nx">BitrotVerifier</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">AppendFile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateFile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">origvolume</span><span class="p">,</span> <span class="nx">olume</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">size</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">reader</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadFileStream</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">length</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadCloser</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RenameFile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">srcVolume</span><span class="p">,</span> <span class="nx">srcPath</span><span class="p">,</span> <span class="nx">dstVolume</span><span class="p">,</span> <span class="nx">dstPath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RenamePart</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">srcVolume</span><span class="p">,</span> <span class="nx">srcPath</span><span class="p">,</span> <span class="nx">dstVolume</span><span class="p">,</span> <span class="nx">dstPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">meta</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CheckParts</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fi</span> <span class="nx">FileInfo</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CheckPartsResp</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VerifyFile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fi</span> <span class="nx">FileInfo</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CheckPartsResp</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">StatInfoFile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">glob</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">stat</span> <span class="p">[]</span><span class="nx">StatInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadParts</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">partMetaPaths</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">ObjectPartInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ReadMultiple</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="nx">ReadMultipleReq</span><span class="p">,</span> <span class="nx">resp</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">ReadMultipleResp</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CleanAbandonedData</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Write all data, syncs the data to disk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Should be used for smaller payloads.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">WriteAll</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Read all.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">ReadAll</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">volume</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetDiskLoc</span><span class="p">()</span> <span class="p">(</span><span class="nx">poolIdx</span><span class="p">,</span> <span class="nx">setIdx</span><span class="p">,</span> <span class="nx">diskIdx</span> <span class="kt">int</span><span class="p">)</span> <span class="c1">// Retrieve location indexes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></div></div>
<h3 id="objectlayer">ObjectLayer</h3>
<p>唯一一个实现就是<code>erasureServerPools</code></p>
<p>ObjectLayer 就是 Minio 提供的面向 Object 的接口，而<code>StorageAPI</code>则是具体的本地或者远程存储磁盘。</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ObjectLayer implements primitives for object API layer.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 重要接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ObjectLayer</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Locking operations on object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">NewNSLock</span><span class="p">(</span><span class="nx">bucket</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">objects</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="nx">RWLocker</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Storage operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Shutdown</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">NSScanner</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">updates</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">DataUsageInfo</span><span class="p">,</span> <span class="nx">wantCycle</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">scanMode</span> <span class="nx">madmin</span><span class="p">.</span><span class="nx">HealScanMode</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BackendInfo</span><span class="p">()</span> <span class="nx">madmin</span><span class="p">.</span><span class="nx">BackendInfo</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Legacy</span><span class="p">()</span> <span class="kt">bool</span> <span class="c1">// Only returns true for deployments which use CRCMOD as its object distribution algorithm.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">StorageInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">metrics</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">StorageInfo</span>
</span></span><span class="line"><span class="cl">	<span class="nf">LocalStorageInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">metrics</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">StorageInfo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Bucket operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">MakeBucket</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">MakeBucketOptions</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetBucketInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">BucketOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">bucketInfo</span> <span class="nx">BucketInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListBuckets</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">BucketOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">buckets</span> <span class="p">[]</span><span class="nx">BucketInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteBucket</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">DeleteBucketOptions</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListObjects</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">marker</span><span class="p">,</span> <span class="nx">delimiter</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">maxKeys</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">ListObjectsInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListObjectsV2</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">continuationToken</span><span class="p">,</span> <span class="nx">delimiter</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">maxKeys</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">fetchOwner</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">startAfter</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">ListObjectsV2Info</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListObjectVersions</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">marker</span><span class="p">,</span> <span class="nx">versionMarker</span><span class="p">,</span> <span class="nx">delimiter</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">maxKeys</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">ListObjectVersionsInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Walk lists all objects including versions, delete markers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Walk</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">prefix</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">results</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">itemOrErr</span><span class="p">[</span><span class="nx">ObjectInfo</span><span class="p">],</span> <span class="nx">opts</span> <span class="nx">WalkOptions</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Object operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GetObjectNInfo returns a GetObjectReader that satisfies the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ReadCloser interface. The Close method runs any cleanup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// functions, so it must always be called after reading till EOF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// IMPORTANTLY, when implementations return err != nil, this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// function MUST NOT return a non-nil ReadCloser.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetObjectNInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">rs</span> <span class="o">*</span><span class="nx">HTTPRangeSpec</span><span class="p">,</span> <span class="nx">h</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">reader</span> <span class="o">*</span><span class="nx">GetObjectReader</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetObjectInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">objInfo</span> <span class="nx">ObjectInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">PutObject</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">data</span> <span class="o">*</span><span class="nx">PutObjReader</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">objInfo</span> <span class="nx">ObjectInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CopyObject</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">srcBucket</span><span class="p">,</span> <span class="nx">srcObject</span><span class="p">,</span> <span class="nx">destBucket</span><span class="p">,</span> <span class="nx">destObject</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">srcInfo</span> <span class="nx">ObjectInfo</span><span class="p">,</span> <span class="nx">srcOpts</span><span class="p">,</span> <span class="nx">dstOpts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">objInfo</span> <span class="nx">ObjectInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteObject</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">ObjectInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteObjects</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">objects</span> <span class="p">[]</span><span class="nx">ObjectToDelete</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">([]</span><span class="nx">DeletedObject</span><span class="p">,</span> <span class="p">[]</span><span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">TransitionObject</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RestoreTransitionedObject</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Multipart operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">ListMultipartUploads</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">keyMarker</span><span class="p">,</span> <span class="nx">uploadIDMarker</span><span class="p">,</span> <span class="nx">delimiter</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">maxUploads</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">ListMultipartsInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">NewMultipartUpload</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="o">*</span><span class="nx">NewMultipartUploadResult</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CopyObjectPart</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">srcBucket</span><span class="p">,</span> <span class="nx">srcObject</span><span class="p">,</span> <span class="nx">destBucket</span><span class="p">,</span> <span class="nx">destObject</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uploadID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">partID</span> <span class="kt">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">startOffset</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">length</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">srcInfo</span> <span class="nx">ObjectInfo</span><span class="p">,</span> <span class="nx">srcOpts</span><span class="p">,</span> <span class="nx">dstOpts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">info</span> <span class="nx">PartInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">PutObjectPart</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">uploadID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">partID</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">data</span> <span class="o">*</span><span class="nx">PutObjReader</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">info</span> <span class="nx">PartInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetMultipartInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">uploadID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">info</span> <span class="nx">MultipartInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ListObjectParts</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">uploadID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">partNumberMarker</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxParts</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">ListPartsInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">AbortMultipartUpload</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">uploadID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CompleteMultipartUpload</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">uploadID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uploadedParts</span> <span class="p">[]</span><span class="nx">CompletePart</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">objInfo</span> <span class="nx">ObjectInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">GetDisks</span><span class="p">(</span><span class="nx">poolIdx</span><span class="p">,</span> <span class="nx">setIdx</span> <span class="kt">int</span><span class="p">)</span> <span class="p">([]</span><span class="nx">StorageAPI</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="c1">// return the disks belonging to pool and set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SetDriveCounts</span><span class="p">()</span> <span class="p">[]</span><span class="kt">int</span>                              <span class="c1">// list of erasure stripe size for each pool in order.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Healing operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">HealFormat</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dryRun</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">madmin</span><span class="p">.</span><span class="nx">HealResultItem</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">HealBucket</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">madmin</span><span class="p">.</span><span class="nx">HealOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">madmin</span><span class="p">.</span><span class="nx">HealResultItem</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">HealObject</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">versionID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">madmin</span><span class="p">.</span><span class="nx">HealOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">madmin</span><span class="p">.</span><span class="nx">HealResultItem</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">HealObjects</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">prefix</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">madmin</span><span class="p">.</span><span class="nx">HealOpts</span><span class="p">,</span> <span class="nx">fn</span> <span class="nx">HealObjectFn</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CheckAbandonedParts</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">madmin</span><span class="p">.</span><span class="nx">HealOpts</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Returns health of the backend
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Health</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">HealthOptions</span><span class="p">)</span> <span class="nx">HealthResult</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Metadata operations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PutObjectMetadata</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">ObjectInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DecomTieredObject</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">FileInfo</span><span class="p">,</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ObjectTagging operations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PutObjectTags</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">ObjectInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetObjectTags</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">tags</span><span class="p">.</span><span class="nx">Tags</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteObjectTags</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">ObjectInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h2 id="重要常量">重要常量</h2>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Represents Erasure backend.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">formatBackendErasure</span> <span class="p">=</span> <span class="s">&#34;xl&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Represents Erasure backend - single drive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">formatBackendErasureSingle</span> <span class="p">=</span> <span class="s">&#34;xl-single&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// formatErasureV1.Erasure.Version - version &#39;1&#39;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">formatErasureVersionV1</span> <span class="p">=</span> <span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// formatErasureV2.Erasure.Version - version &#39;2&#39;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">formatErasureVersionV2</span> <span class="p">=</span> <span class="s">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// formatErasureV3.Erasure.Version - version &#39;3&#39;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">formatErasureVersionV3</span> <span class="p">=</span> <span class="s">&#34;3&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Distribution algorithm used, legacy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">formatErasureVersionV2DistributionAlgoV1</span> <span class="p">=</span> <span class="s">&#34;CRCMOD&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Distributed algorithm used, with N/2 default parity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">formatErasureVersionV3DistributionAlgoV2</span> <span class="p">=</span> <span class="s">&#34;SIPMOD&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Distributed algorithm used, with EC:4 default parity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">formatErasureVersionV3DistributionAlgoV3</span> <span class="p">=</span> <span class="s">&#34;SIPMOD+PARITY&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div></div>
<h2 id="s3-api-putobject">s3 API: PutObject</h2>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// PutObject
</span></span></span><span class="line"><span class="cl"><span class="c1">// http处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">router</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodPut</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/{object:.+}&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">  <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nf">s3APIMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">PutObjectHandler</span><span class="p">,</span> <span class="nx">traceHdrsS3HFlag</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">// objectLayer层接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">putObject</span> <span class="p">=</span> <span class="nx">objectAPI</span><span class="p">.</span><span class="nx">PutObject</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Validate storage class metadata if present
</span></span></span><span class="line"><span class="cl"><span class="c1">// x-amz-storage-class minio 只支持 REDUCED_REDUNDANCY 和 Standard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="nx">sc</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">xhttp</span><span class="p">.</span><span class="nx">AmzStorageClass</span><span class="p">);</span> <span class="nx">sc</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">storageclass</span><span class="p">.</span><span class="nf">IsValid</span><span class="p">(</span><span class="nx">sc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nf">writeErrorResponse</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">errorCodes</span><span class="p">.</span><span class="nf">ToAPIErr</span><span class="p">(</span><span class="nx">ErrInvalidStorageClass</span><span class="p">),</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// maximum Upload size for objects in a single operation
</span></span></span><span class="line"><span class="cl"><span class="c1">// 5TiB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="nf">isMaxObjectSize</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">writeErrorResponse</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">errorCodes</span><span class="p">.</span><span class="nf">ToAPIErr</span><span class="p">(</span><span class="nx">ErrEntityTooLarge</span><span class="p">),</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="nx">objInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">putObject</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">pReader</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span></span></span></code></pre></div></div>
<p>同一个对象对应到的<code>erasure set</code>总是同一个，这是通过确定性的 hash 算法得到的，所以 server pool 不能被修改，否则 hash 映射关系可能发生变化。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Returns always a same erasure coded set for a given input.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">erasureSets</span><span class="p">)</span> <span class="nf">getHashedSetIndex</span><span class="p">(</span><span class="nx">input</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过hash得到对应erasure set，以下要素可能影响hash结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nf">hashKey</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">distributionAlgo</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">sets</span><span class="p">),</span> <span class="nx">s</span><span class="p">.</span><span class="nx">deploymentID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// PutObject - creates an object upon reading from the input stream
</span></span></span><span class="line"><span class="cl"><span class="c1">// until EOF, erasure codes the data across all disk and additionally
</span></span></span><span class="line"><span class="cl"><span class="c1">// writes `xl.meta` which carries the necessary metadata for future
</span></span></span><span class="line"><span class="cl"><span class="c1">// object operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">er</span> <span class="nx">erasureObjects</span><span class="p">)</span> <span class="nf">PutObject</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">object</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">data</span> <span class="o">*</span><span class="nx">PutObjReader</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ObjectOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">objInfo</span> <span class="nx">ObjectInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">er</span><span class="p">.</span><span class="nf">putObject</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h3 id="block-和-shard">block 和 shard</h3>
<p>block （块）</p>
<p><code>blockSize</code> 代表原始数据在存储时被切分的最小单位。</p>
<ul>
<li>在 MinIO 中，数据在存储前被分割成多个 <code>block</code>。</li>
<li>这些 <code>block</code> 经过 <strong>纠删码（Erasure Coding）</strong> 计算后，生成 <strong>数据块（data blocks）</strong> 和 <strong>校验块（parity blocks）</strong>。</li>
</ul>
<p>Shard (分片)</p>
<p><code>shard</code> 是 MinIO <strong>存储在磁盘上的物理单位</strong>，包含 <strong>数据块</strong> 和 <strong>校验块</strong>。</p>
<ul>
<li>
<p>在 <strong>N+M 纠删码</strong>（N 个数据块 + M 个校验块）中，每个 <code>shard</code> 对应 <strong>一个数据块或一个校验块</strong>。</p>
</li>
<li>
<p>例如，</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>EC: 4+2</code></pre></div>
<p>（4 个数据块 + 2 个校验块）表示：</p>
<ul>
<li><strong>数据被分成 4 个 <code>block</code></strong>。</li>
<li><strong>计算出 2 个额外的 <code>parity block</code>（用于恢复数据）</strong>。</li>
<li><strong>最终存储 6 个 <code>shard</code></strong>，每个 <code>shard</code> 分别存放在不同的磁盘上。</li>
</ul>
</li>
</ul>
<p>假设数据为 300MiB，blocksize 为 10MiB, 遵循 EC: 4 + 2, shardsize = ceil(10MiB / 4) =2.5MiB，最终每个 blocksize 存储在磁盘上为 6 个 shard，4 个 data shard，6 个 parity shard</p>
<h3 id="putobject-的主要流程">putObject 的主要流程</h3>
<ol>
<li>创建临时目录，写入分片数据</li>
<li>如果没有加锁，获取名字空间锁，实现原子操作，避免数据竞争</li>
<li>rename 操作，包含将分片移动到目标目录以及写入 <code>xl.meta</code>元数据</li>
<li>最后好像有提交操作，没有看懂</li>
</ol>
<h2 id="名字空间锁的实现原理-todo">名字空间锁的实现原理 （TODO)</h2>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// func (er erasureObjects) putObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">NoLock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lk</span> <span class="o">:=</span> <span class="nx">er</span><span class="p">.</span><span class="nf">NewNSLock</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lkctx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">lk</span><span class="p">.</span><span class="nf">GetLock</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">globalOperationTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">ObjectInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">lkctx</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">lk</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="nx">lkctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span></span></span></code></pre></div></div>
<p><code>erasureObjects</code>中有两个关键的字段<code>getLockers</code>和<code>nsMutex</code>用于名字空间加锁。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">erasureObjects</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// getLockers returns list of remote and local lockers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">getLockers</span> <span class="kd">func</span><span class="p">()</span> <span class="p">([]</span><span class="nx">dsync</span><span class="p">.</span><span class="nx">NetLocker</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Locker mutex map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nsMutex</span> <span class="o">*</span><span class="nx">nsLockMap</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">erasureSets</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sets</span> <span class="p">[]</span><span class="o">*</span><span class="nx">erasureObjects</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Distributed locker clients.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">erasureLockers</span> <span class="nx">setsDsyncLockers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Distributed lock owner (constant per running instance).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">erasureLockOwner</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// setsDsyncLockers is encapsulated type for Close()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">type</span> <span class="nx">setsDsyncLockers</span> <span class="p">[][]</span><span class="nx">dsync</span><span class="p">.</span><span class="nx">NetLocker</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">erasureSets</span><span class="p">)</span> <span class="nf">GetLockers</span><span class="p">(</span><span class="nx">setIndex</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="p">([]</span><span class="nx">dsync</span><span class="p">.</span><span class="nx">NetLocker</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">([]</span><span class="nx">dsync</span><span class="p">.</span><span class="nx">NetLocker</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lockers</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">dsync</span><span class="p">.</span><span class="nx">NetLocker</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">erasureLockers</span><span class="p">[</span><span class="nx">setIndex</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">		<span class="nb">copy</span><span class="p">(</span><span class="nx">lockers</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">erasureLockers</span><span class="p">[</span><span class="nx">setIndex</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// erasureLockerOwner实际上是globalLocalNodeName
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The name of this local node, fetched from arguments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="c1">// globalLocalNodeName    string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">lockers</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">erasureLockOwner</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// nsLockMap - namespace lock map, provides primitives to Lock,
</span></span></span><span class="line"><span class="cl"><span class="c1">// Unlock, RLock and RUnlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">nsLockMap</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Indicates if namespace is part of a distributed setup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">isDistErasure</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lockMap</span>       <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">nsLock</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lockMapMutex</span>  <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// newNSLock - return a new name space lock map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newNSLock</span><span class="p">(</span><span class="nx">isDistErasure</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">nsLockMap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nsMutex</span> <span class="o">:=</span> <span class="nx">nsLockMap</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">isDistErasure</span><span class="p">:</span> <span class="nx">isDistErasure</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">isDistErasure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">nsMutex</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nsMutex</span><span class="p">.</span><span class="nx">lockMap</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">nsLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">nsMutex</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<h3 id="什么是-dsync"><strong>什么是 dsync？</strong></h3>
<p><code>dsync</code> 是 <strong>MinIO</strong> 实现的<strong>分布式锁（distributed locking）库</strong>，用于在多节点环境下进行同步锁定，确保数据一致性。</p>
<p><strong>主要作用：</strong></p>
<ul>
<li>在 <strong>MinIO 集群</strong> 中，确保多个 MinIO 服务器节点在 <strong>并发访问同一资源</strong> 时，正确管理<strong>读/写锁</strong>。</li>
<li>提供 <strong>类似 <code>sync.Mutex</code> 和 <code>sync.RWMutex</code> 的分布式版本</strong>，但适用于<strong>分布式系统</strong>，而不是单机环境。</li>
<li><strong>避免数据竞争和不一致性</strong>，保证多个 MinIO 服务器不会发生并发冲突。</li>
</ul>
<h4 id="netlocker-接口"><strong><code>NetLocker</code> 接口</strong></h4>
<p>你提供的 <code>NetLocker</code> 接口定义了一种<strong>分布式锁管理机制</strong>，与 <code>dsync</code> 兼容，核心方法包括：</p>
<ul>
<li><code>Lock()</code> / <code>Unlock()</code> —— <strong>写锁</strong></li>
<li><code>RLock()</code> / <code>RUnlock()</code> —— <strong>读锁</strong></li>
<li><code>Refresh()</code> —— <strong>续约锁，防止锁过期</strong></li>
<li><code>ForceUnlock()</code> —— <strong>强制解锁</strong></li>
<li><code>IsOnline()</code> / <code>IsLocal()</code> —— <strong>检查锁服务是否在线，本地还是远程</strong></li>
<li><code>String()</code> / <code>Close()</code> —— <strong>返回锁的标识 &amp; 关闭连接</strong></li>
</ul>
<p>这套机制允许 MinIO 在<strong>多个服务器节点</strong>间进行<strong>分布式锁管理</strong>，确保一致性。</p>
<h3 id="dsync-是如何工作的"><strong>dsync 是如何工作的？</strong></h3>
<p><code>dsync</code> <strong>采用基于 <code>n/2+1</code> 多数决机制的分布式锁</strong>，适用于 MinIO <strong>分布式对象存储集群</strong>。</p>
<p><strong>核心特点：</strong></p>
<ol>
<li>
<p><strong>分布式锁（类似 <code>sync.Mutex</code>）</strong></p>
<ul>
<li><code>Lock()</code> / <code>Unlock()</code> 实现互斥锁，确保<strong>多个 MinIO 节点不会同时写入相同数据</strong>。</li>
<li><code>RLock()</code> / <code>RUnlock()</code> 允许<strong>多个读取者并发访问</strong>，但不能同时有写入者。</li>
</ul>
</li>
<li>
<p><strong>基于 Raft 的一致性算法</strong></p>
<p>不存储锁的持久化状态，而是采用 n/2+1 机制</p>
<ul>
<li>
<p><strong>如果大多数（n/2+1）MinIO 节点同意加锁，则锁成功。</strong></p>
</li>
<li>
<p>如果未达到多数决（如部分节点宕机），加锁失败，防止数据不一致。</p>
</li>
<li>
<p>这类似于 <strong>Paxos/Raft</strong> 选举机制，保证<strong>数据一致性</strong>。</p>
</li>
</ul>
</li>
<li>
<p><strong>超时 &amp; 续约（避免死锁）</strong></p>
<ul>
<li><strong>锁会自动超时</strong>，防止死锁问题。</li>
<li><code>Refresh()</code> 允许持有锁的进程 <strong>续约</strong>，防止锁过期被其他进程获取。</li>
</ul>
</li>
<li>
<p><strong>支持本地 &amp; 远程锁</strong></p>
<ul>
<li><strong>单机模式</strong>：类似 <code>sync.Mutex</code>，锁是<strong>本地的</strong>。</li>
<li><strong>分布式模式</strong>（<code>dsync</code>）：锁请求会被发送到<strong>多个 MinIO 服务器</strong>，确保整个集群同步加锁。</li>
</ul>
</li>
</ol>
<p><strong>MinIO 为什么需要 <code>dsync</code>？</strong></p>
<p>在 MinIO <strong>分布式对象存储</strong> 中，多个节点可能同时操作同一个对象（如 PUT/DELETE 操作）。
如果没有锁，可能会出现 <strong>数据覆盖、损坏或不一致</strong> 的问题。</p>
<p><strong>使用 <code>dsync</code> 进行分布式锁管理，MinIO 解决了这些问题</strong>：</p>
<ul>
<li><strong>确保多个节点不会同时写入同一对象</strong>，防止数据损坏。</li>
<li><strong>允许多个节点同时读取数据</strong>，提高并发性能。</li>
<li><strong>防止死锁 &amp; 允许锁续约</strong>，确保锁不会永久占用资源。</li>
</ul>
<h3 id="总结"><strong>总结</strong></h3>
<ul>
<li><strong><code>dsync</code> 是 MinIO 的分布式锁库</strong>，用于<strong>多节点同步</strong>，确保一致性。</li>
<li>采用 <strong>n/2+1 多数决机制</strong>，防止数据竞争 &amp; 保证锁安全。</li>
<li>提供 <strong>读/写锁、强制解锁、锁续约等功能</strong>，适用于高并发场景。</li>
<li><strong>MinIO 通过 <code>dsync</code> 确保多个服务器不会并发写入相同对象</strong>，保证数据一致性。</li>
</ul>
<h2 id="o_direct-的实际用途">O_DIRECT 的实际用途</h2>
<h2 id="s3-api-getobject">s3 API: GetObject</h2>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// GetObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">router</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodGet</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/{object:.+}&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">  <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nf">s3APIMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">GetObjectHandler</span><span class="p">,</span> <span class="nx">traceHdrsS3HFlag</span><span class="p">))</span></span></span></code></pre></div></div>
<ul>
<li>首先加分布式读锁</li>
<li>通过读取<code>xl.meta</code>获取对象的元数据信息，<code>xl.meta</code>保存了<code>part</code>和<code>verison</code>的全部信息，注意可能存在某些磁盘上的<code>xl.meta</code>由于故障而修改落后，所以依然需要读取法定人数的磁盘，从而确定实际的元数据</li>
<li>如果 http 请求通过<code>part</code>或者<code>range</code>要求读取部分数据，最终都会转换成对多个 part 的读取，每个 part 都会划分成不同的<code>block</code>进行操作。</li>
</ul>
<h2 id="纠删码的基本原理">纠删码的基本原理</h2>
<p><a href="https://p0kt65jtu2p.feishu.cn/docx/LZ36dMN3LoZCuUxFadccNOXGnKb" target="_blank" rel="noopener noreffer ">https://p0kt65jtu2p.feishu.cn/docx/LZ36dMN3LoZCuUxFadccNOXGnKb</a></p>
<p>假设将数据分成 4 块，采用 EC:2 冗余比例，可以将原来的数据组合成一个输入矩阵 <code>P = [][]byte</code>， 第一维表示不同的数据块，第二维表示数据块的数据，所以这里的 P 的大小为 <code>4 * n</code>，n 为每个数据块的大小</p>
<p>编码矩阵 E 的大小为 <code>6 * 4</code>，要求 编码矩阵的前 4 行组成的矩阵为单位矩阵，保持原来数据块数据不变，后两行用来生成冗余数据。</p>
<p>E * P = C （C 表示生成的数据块和冗余块）</p>
<p>假设有两行数据不慎丢失，此时去掉那两行对应的数据后依然有关系 $E&rsquo; * P = C&rsquo;$ 成立，此时通过求逆可以得到原先的 P，也就从数据丢失中恢复了原来的数据。</p>
<h2 id="分片上传和断点续传">分片上传和断点续传</h2>
<p>分片下载可以通过前面说过的 http 请求中的<code>range</code>或者<code>partnumber</code>实现。</p>
<p>主要涉及的 s3 API（客户端）:</p>
<ul>
<li>InitiateMultipartUpload</li>
<li>UploadPart</li>
<li>AbortMultipartUpload</li>
<li>CompleteMultipartUpload</li>
</ul>
<p>在 minio 的客户端代码中实现了分片上传，并且支持并发上传</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// PutObject creates an object in a bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// You must have WRITE permissions on a bucket to create an object.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//   - For size smaller than 16MiB PutObject automatically does a
</span></span></span><span class="line"><span class="cl"><span class="c1">//     single atomic PUT operation.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//   - For size larger than 16MiB PutObject automatically does a
</span></span></span><span class="line"><span class="cl"><span class="c1">//     multipart upload operation.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//   - For size input as -1 PutObject does a multipart Put operation
</span></span></span><span class="line"><span class="cl"><span class="c1">//     until input stream reaches EOF. Maximum object size that can
</span></span></span><span class="line"><span class="cl"><span class="c1">//     be uploaded through this operation will be 5TiB.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//     WARNING: Passing down &#39;-1&#39; will use memory and these cannot
</span></span></span><span class="line"><span class="cl"><span class="c1">//     be reused for best outcomes for PutObject(), pass the size always.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// NOTE: Upon errors during upload multipart operation is entirely aborted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">PutObject</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucketName</span><span class="p">,</span> <span class="nx">objectName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">reader</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">objectSize</span> <span class="kt">int64</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="nx">PutObjectOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// putObjectMultipartStreamParallel uploads opts.NumThreads parts in parallel.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This is expected to take opts.PartSize * opts.NumThreads * (GOGC / 100) bytes of buffer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">putObjectMultipartStreamParallel</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bucketName</span><span class="p">,</span> <span class="nx">objectName</span> <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">reader</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">PutObjectOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">(</span><span class="nx">info</span> <span class="nx">UploadInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-go">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">  <span class="c1">// PutObjectPart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">router</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodPut</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/{object:.+}&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nf">s3APIMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">PutObjectPartHandler</span><span class="p">,</span> <span class="nx">traceHdrsS3HFlag</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Queries</span><span class="p">(</span><span class="s">&#34;partNumber&#34;</span><span class="p">,</span> <span class="s">&#34;{partNumber:.*}&#34;</span><span class="p">,</span> <span class="s">&#34;uploadId&#34;</span><span class="p">,</span> <span class="s">&#34;{uploadId:.*}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ListObjectParts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">router</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodGet</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/{object:.+}&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nf">s3APIMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">ListObjectPartsHandler</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Queries</span><span class="p">(</span><span class="s">&#34;uploadId&#34;</span><span class="p">,</span> <span class="s">&#34;{uploadId:.*}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// CompleteMultipartUpload
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">router</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodPost</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/{object:.+}&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nf">s3APIMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">CompleteMultipartUploadHandler</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Queries</span><span class="p">(</span><span class="s">&#34;uploadId&#34;</span><span class="p">,</span> <span class="s">&#34;{uploadId:.*}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// NewMultipartUpload
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">router</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodPost</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/{object:.+}&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nf">s3APIMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">NewMultipartUploadHandler</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Queries</span><span class="p">(</span><span class="s">&#34;uploads&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// AbortMultipartUpload
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">router</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodDelete</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/{object:.+}&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nf">s3APIMiddleware</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">AbortMultipartUploadHandler</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Queries</span><span class="p">(</span><span class="s">&#34;uploadId&#34;</span><span class="p">,</span> <span class="s">&#34;{uploadId:.*}&#34;</span><span class="p">)</span></span></span></code></pre></div></div>
<p><strong>NewMultipartUpload</strong></p>
<ul>
<li>生成 uuid 作为 uploadId</li>
<li>将元数据写入 <code>.minio.sys/multipart</code> uploadId 路径下</li>
</ul>
<p><strong>PutObjectPart</strong></p>
<ul>
<li>类似于 PutObejct</li>
</ul>
<p><strong>CompleteMultipartUpload</strong></p>
<ul>
<li>并没有合并 part，仍然保留每个 part</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-01-22</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/posts/minio-get-started/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on X" data-sharer="x" data-url="http://example.org/posts/minio-get-started/" data-title="MinIO大杂烩" data-hashtags="MinIO"><i class="fab fa-x-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Threads" data-sharer="threads" data-url="http://example.org/posts/minio-get-started/" data-title="MinIO大杂烩"><i class="fab fa-threads fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/posts/minio-get-started/" data-hashtag="MinIO"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://example.org/posts/minio-get-started/" data-title="MinIO大杂烩"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.org/posts/minio-get-started/" data-title="MinIO大杂烩"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@14.9.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://example.org/posts/minio-get-started/" data-title="MinIO大杂烩"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Diaspora" data-sharer="diaspora" data-url="http://example.org/posts/minio-get-started/" data-title="MinIO大杂烩" data-description=""><i class="fab fa-diaspora fa-fw" aria-hidden="true"></i></a><a href="https://t.me/share/url?url=http%3a%2f%2fexample.org%2fposts%2fminio-get-started%2f&amp;text=MinIO%e5%a4%a7%e6%9d%82%e7%83%a9" target="_blank" title="Share on Telegram"><i class="fab fa-telegram fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/minio/">MinIO</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
            <a href="/posts/prometheus_and_grafana/" class="next" rel="next" title="Prometheus_and_grafana">Prometheus_and_grafana<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.140.2">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">xxxx</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js"></script><script>window.config={"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"ShadowUnderMoon/ShadowUnderMoon.github.io"}},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
